# ═══════════════════════════════════════════════════════════════════
# P5: INTAKE CAPACITY CALCULATOR - UPDATED v2.0
# VK Charts AI Scoring System
# ═══════════════════════════════════════════════════════════════════
#
# CHANGES IN v2.0:
# - Added penalties for under-utilization (<90%)
# - Added penalties for over-utilization (>110%)
# - Clarified cargo quantity range handling (min-max or ±10%)
# - Linear penalty formulas for both under and over capacity
#
# ═══════════════════════════════════════════════════════════════════

version: "2.0"
date: "2026-01-19"
priority: "CRITICAL - Intake affects commercial viability"

# ═══════════════════════════════════════════════════════════════════
# OVERVIEW
# ═══════════════════════════════════════════════════════════════════

purpose: |
  P5 evaluates whether vessel can physically carry the cargo quantity.
  
  SCORE RANGE: 0-15 points
  
  KEY PRINCIPLE:
  - Optimal utilization: 90-110% of cargo quantity
  - Under-utilization: Vessel too large → lost revenue per ton
  - Over-utilization: Cargo too large → physically impossible or risky

# ═══════════════════════════════════════════════════════════════════
# CARGO QUANTITY RANGES
# ═══════════════════════════════════════════════════════════════════

cargo_quantity_formats:
  
  explicit_range:
    format: "6000-6600t"
    interpretation:
      min_quantity: 6000
      max_quantity: 6600
      optimal_target: 6300
    
    example: "Wheat 6000/6600t Odessa/Mersin"
  
  plus_minus_percentage:
    format: "6000t ±10%"
    interpretation:
      base_quantity: 6000
      percentage: 10
      min_quantity: "6000 × 0.90 = 5400t"
      max_quantity: "6000 × 1.10 = 6600t"
    
    example: "Corn 6000t MOLOO Chornomorsk/Yarimca"
    note: "MOLOO = More Or Less Owner's Option (±10%)"
  
  single_quantity:
    format: "6000t"
    interpretation:
      target_quantity: 6000
      assume_range: "6000 ±5% (5700-6300t)"
    
    note: "Default tolerance if no range specified"
  
  calculation_basis:
    use_for_utilization: "cargo_max_quantity"
    reasoning: |
      Always calculate utilization against MAX possible cargo.
      This ensures vessel can handle worst-case (largest) parcel.

# ═══════════════════════════════════════════════════════════════════
# INTAKE CALCULATION STEPS
# ═══════════════════════════════════════════════════════════════════

intake_calculation:
  
  step_1_weight_based_intake:
    formula: "effective_dwt = vessel_dwt - rob - constant"
    
    components:
      vessel_dwt:
        source: "Vessel database field"
        example: 7853
      
      rob:
        full_name: "Remaining On Board (fuel, water, stores)"
        typical_value: 250
        unit: "tons"
        note: "Standard assumption for coasters"
      
      constant:
        value: 0
        note: "Reserved for future adjustments"
    
    example:
      vessel_dwt: 7853
      rob: 250
      constant: 0
      effective_dwt: "7853 - 250 - 0 = 7603t"
  
  step_2_volume_based_intake:
    description: "Calculate intake limited by cargo volume (grain capacity)"
    
    condition: "IF cargo has high stowage factor (volumetric cargo)"
    
    formula: "volume_based_intake = grain_capacity / stowage_factor"
    
    components:
      grain_capacity:
        source: "Vessel database field"
        unit: "cubic feet"
        example: 283120
      
      stowage_factor:
        source: "Cargo database or description"
        unit: "cubic feet per ton"
        example: 47
        note: "Higher SF = lighter/bulkier cargo"
      
      conversion:
        if_needed: "Convert grain capacity to cubic meters if SF in m³/t"
    
    example:
      grain_capacity: 283120
      stowage_factor: 47
      volume_based_intake: "283120 / 47 = 6023t"
  
  step_3_draft_based_intake:
    description: "Calculate intake limited by port draft restrictions"
    
    condition: "IF port has draft restriction < vessel max draft"
    
    formula: "Use TPC (Tons Per Centimeter) curves or approximation"
    
    note: |
      Draft restrictions are complex and vessel-specific.
      For MVP, use weight and volume checks primarily.
      Draft can be added later with TPC data.
  
  step_4_final_intake:
    formula: "final_intake = MIN(weight_based, volume_based, draft_based)"
    
    reasoning: |
      Vessel intake is LIMITED by the most restrictive factor:
      - Weight limit (DWT)
      - Volume limit (grain capacity ÷ SF)
      - Draft limit (port restriction)
    
    example:
      weight_based: 7603
      volume_based: 6023
      draft_based: "N/A (no restriction)"
      final_intake: "MIN(7603, 6023) = 6023t"

# ═══════════════════════════════════════════════════════════════════
# UTILIZATION CALCULATION
# ═══════════════════════════════════════════════════════════════════

utilization_calculation:
  
  formula: "utilization_percent = (cargo_max_quantity / final_intake) × 100"
  
  example:
    cargo_quantity: "6000t"
    cargo_max: 6000
    final_intake: 6023
    utilization: "(6000 / 6023) × 100 = 99.6%"
  
  interpretation:
    optimal_range: "90-110%"
    under_utilized: "< 90%"
    over_utilized: "> 110%"

# ═══════════════════════════════════════════════════════════════════
# SCORING MATRIX v2.0 - WITH PENALTIES
# ═══════════════════════════════════════════════════════════════════

scoring_matrix_v2:
  
  # ─────────────────────────────────────────────────────────────────
  # OPTIMAL UTILIZATION (90-110%)
  # ─────────────────────────────────────────────────────────────────
  
  optimal_90_110:
    condition: "90% ≤ utilization ≤ 110%"
    base_score: 15
    penalty: 0
    final_score: 15
    confidence: 90
    reasoning: "Excellent fit - cargo and vessel well-matched"
    examples:
      - utilization: "95%"
        score: 15
      - utilization: "100%"
        score: 15
      - utilization: "105%"
        score: 15
  
  # ─────────────────────────────────────────────────────────────────
  # UNDER-UTILIZATION (<90%) - Vessel Too Large
  # ─────────────────────────────────────────────────────────────────
  
  under_utilization_formula:
    condition: "utilization < 90%"
    
    penalty_formula: "penalty_percent = (90 - utilization) × 2.0"
    final_score_formula: "score = 15 × (1 - penalty_percent/100)"
    
    explanation: |
      For every 1% below 90% utilization, apply 0.5% penalty.
      This reflects owner's lost revenue from unused capacity.
    
    examples:
      
      example_1_severe:
  utilization: "73.8%"
  penalty_calculation: "(90 - 73.8) × 2.0 = 32.4%"
  final_score: "15 × (1 - 0.324) = 10.14/15"
  reasoning: "2,125 t underload – severe underutilization"

example_2_moderate:
  utilization: "80%"
  penalty_calculation: "(90 - 80) × 2.0 = 20%"
  final_score: "15 × (1 - 0.20) = 12.0/15"
  reasoning: "Moderate underutilization"

example_3_minor:
  utilization: "85%"
  penalty_calculation: "(90 - 85) × 2.0 = 10%"
  final_score: "15 × (1 - 0.10) = 13.5/15"
  reasoning: "Minor underutilization, acceptable"

  
  # ─────────────────────────────────────────────────────────────────
  # OVER-UTILIZATION (>110%) - Cargo Too Large
  # ─────────────────────────────────────────────────────────────────
  
  over_utilization_110_120:
    condition: "110% < utilization ≤ 120%"
    base_score: 15
    penalty_formula: "(utilization - 110) × 0.5"
    
    examples:
      
      example_1:
        utilization: "112%"
        penalty: "(112 - 110) × 0.5 = 1%"
        final_score: "15 × (1 - 0.01) = 14.9"
        reasoning: "Tight fit, possible with careful planning"
      
      example_2:
        utilization: "115%"
        penalty: "(115 - 110) × 0.5 = 2.5%"
        final_score: "15 × (1 - 0.025) = 14.6"
        reasoning: "Very tight, requires optimization"
      
      example_3:
        utilization: "119%"
        penalty: "(119 - 110) × 0.5 = 4.5%"
        final_score: "15 × (1 - 0.045) = 14.3"
        reasoning: "Borderline feasible"
  
  over_utilization_120_130:
    condition: "120% < utilization ≤ 130%"
    score_range: [6, 10]
    reasoning: "Very risky - may require cargo reduction or favorable conditions"
    
    examples:
      utilization: "125%"
      score: 8
      reasoning: "Risky - likely need to reduce cargo or optimize SF"
  
  over_utilization_above_130:
    condition: "utilization > 130%"
    score_range: [2, 5]
    reasoning: "Physically very difficult - extreme measures required"
    
    examples:
      utilization: "135%"
      score: 3
      reasoning: "Nearly impossible without major cargo reduction"
  
  # ─────────────────────────────────────────────────────────────────
  # MINIMUM SCORE FLOOR
  # ─────────────────────────────────────────────────────────────────
  
  minimum_score:
    value: 2
    reasoning: |
      Even if cargo doesn't fit perfectly, score should never be zero.
      There's always potential for negotiation (cargo reduction, etc.)

# ═══════════════════════════════════════════════════════════════════
# SPECIAL CONSIDERATIONS
# ═══════════════════════════════════════════════════════════════════

special_cases:
  
  stowage_factor_missing:
    condition: "Cargo SF not available"
    action: "Skip volume_based_intake calculation"
    use: "weight_based_intake only"
    note: "Assume weight-limited cargo (low SF like grain)"
  
  grain_capacity_missing:
    condition: "Vessel grain capacity not in database"
    action: "Estimate from DWT or skip volume check"
    conservative_estimate: "grain_capacity ≈ DWT × 50 cubic feet/ton"
  
  draft_restriction:
    condition: "Port draft < vessel draft"
    action: "Flag in reasoning, reduce confidence"
    future_enhancement: "Add draft-based intake calculation"
  
  dense_cargo:
    examples: ["Iron ore", "Steel products", "Kaolin"]
    characteristic: "Low SF (weight-limited)"
    impact: "weight_based_intake is limiting factor"
  
  light_cargo:
    examples: ["Wood chips", "Cotton", "Light grain"]
    characteristic: "High SF (volume-limited)"
    impact: "volume_based_intake is limiting factor"

# ═══════════════════════════════════════════════════════════════════
# AI REASONING TEMPLATES
# ═══════════════════════════════════════════════════════════════════

reasoning_templates:
  
  template_optimal:
    condition: "90-110% utilization"
    format: |
      "Vessel DWT ([dwt]) accommodates [cargo_qty] cargo with [util]% utilization.
      [limiting_factor if relevant]. Excellent/Good fit."
    example: |
      "Vessel DWT (6687) accommodates 6000t cargo with 90% utilization after ROB deduction.
      Good fit for this parcel size."
  
  template_under_utilized:
    condition: "<90% utilization"
    format: |
      "Vessel DWT ([dwt]) significantly exceeds cargo requirement ([cargo_qty]).
      Utilization: [util]%, indicating vessel is [X]% under-utilized. [Impact]."
    example: |
      "Vessel DWT (7782) significantly exceeds cargo requirement (6000t).
      Utilization: 77%, indicating vessel is 23% under-utilized.
      Owner loses revenue on unused capacity."
  
  template_over_utilized:
    condition: ">110% utilization"
    format: |
      "Cargo [cargo_qty] requires [util]% of vessel capacity ([intake]).
      [tight/risky/difficult] fit. [Actions needed]."
    example: |
      "Cargo 6000t requires 115% of vessel capacity (5200t effective).
      Tight fit, may require cargo reduction or favorable draft conditions."

# ═══════════════════════════════════════════════════════════════════
# CRITICAL AI INSTRUCTIONS
# ═══════════════════════════════════════════════════════════════════

ai_must:
  - "ALWAYS calculate utilization against cargo MAX quantity"
  - "ALWAYS apply penalties for <90% or >110% utilization"
  - "ALWAYS check for volumetric cargoes (high SF)"
  - "ALWAYS use MIN of weight/volume/draft as final intake"
  - "NEVER give zero score (minimum is 2)"

ai_must_not:
  - "Never ignore under-utilization penalties"
  - "Never assume vessel can carry >130% without major penalty"
  - "Never skip volume check if SF is available"

# ═══════════════════════════════════════════════════════════════════
# END OF P5 INTAKE CAPACITY CALCULATOR v2.0
# ═══════════════════════════════════════════════════════════════════

