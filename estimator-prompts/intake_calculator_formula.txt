================================================================================
INTAKE CALCULATOR FORMULA — P5
Version: 4.0
Last updated: 2026-02-07
================================================================================

PURPOSE:
  Calculate vessel's cargo intake capacity and score how well the vessel 
  fits the cargo quantity requirements. Multi-step process covering weight,
  volume, draft restrictions, vessel utilization, and cubature.

SCORE RANGE: [0, 15]
ALWAYS ACTIVE: max_score = 15
MINIMUM SCORE: 2 (except when BLOCK)

================================================================================
STEP 1 — PARSE CARGO QUANTITY (min_qty / max_qty)
================================================================================

  Convert cargo quantity description into numeric min/max range:
  
  Format: "15,000t ±10%"
    min_qty = 15000 × 0.90 = 13,500
    max_qty = 15000 × 1.10 = 16,500
    
  Format: "6000/6600t" or "6000-6600t"
    min_qty = 6,000
    max_qty = 6,600
    
  Format: "6000t MOLOO" (more or less in owner's option)
    min_qty = 6000 × 0.95 = 5,700
    max_qty = 6000 × 1.05 = 6,300
    
  Format: "6000t" (no qualifier)
    min_qty = 6000 × 0.95 = 5,700
    max_qty = 6000 × 1.05 = 6,300
    (Default: assume ±5% flexibility)
    
  Format: "15,000mt 10% MOLOO"
    min_qty = 15000 × 0.90 = 13,500
    max_qty = 15000 × 1.10 = 16,500

  Format: "abt 8,000t" (about)
    min_qty = 8000 × 0.95 = 7,600
    max_qty = 8000 × 1.05 = 8,400

================================================================================
STEP 2 — CALCULATE VESSEL INTAKE
================================================================================

  A) WEIGHT INTAKE:
     weight_intake = DWT - ROB
     ROB (Remaining On Board) = 250 tonnes (default fuel/water/stores)
     
     If DWT is not available → BLOCK with note "Missing DWT data"
     
  B) VOLUME INTAKE (if stowage factor is known):
     volume_intake = grain_capacity / SF
     
     grain_capacity = from vessel specs (cubic feet or cubic meters)
     SF = Stowage Factor of the cargo (cubic feet per tonne)
     
     Common SF values:
       Wheat: 46-48 cbft/t
       Corn/Maize: 47-50 cbft/t
       Barley: 49-53 cbft/t
       Soybeans: 48-50 cbft/t
       Rice: 42-52 cbft/t (varies by type)
       Cement: 28-30 cbft/t
       Coal: 42-48 cbft/t
       Fertilizer (urea): 42-45 cbft/t
       Sugar: 38-42 cbft/t
       Steel products: 15-25 cbft/t
       
     If grain_capacity is not available → skip volume check
     If SF is not known → skip volume check
     
  C) DRAFT-RESTRICTED INTAKE (if port has draft restriction):
     draft_restricted_intake = (port_max_draft - vessel_light_draft) / 
                               (vessel_max_draft - vessel_light_draft) × DWT
     
     Simplified estimate when light draft is unknown:
       draft_ratio = port_max_draft / vessel_max_draft
       draft_restricted_intake = weight_intake × draft_ratio
       (This is approximate — actual calculation depends on vessel design)
       
     If no draft restriction → draft_restricted_intake = unlimited
     
  D) FINAL INTAKE:
     final_intake = MIN(weight_intake, volume_intake, draft_restricted_intake)
     
     Use whichever is the limiting factor.

================================================================================
STEP 3 — CARGO FIT SCORE (base P5 score)
================================================================================

  Compare final_intake to cargo min_qty / max_qty:
  
  PERFECT FIT: min_qty ≤ final_intake ≤ max_qty
  ─────────────────────────────────────────
    P5_base = 15/15
    offer_hint: "Cargo fits vessel perfectly — mention full utilization."
    
  UNDER CARGO: final_intake < min_qty
  ─────────────────────────────────────────
    shortfall = 1 - (final_intake / min_qty)
    penalty = shortfall × 2.0
    P5_base = MAX(15 × (1 - penalty), 2)
    
    Example: intake = 12,000, min_qty = 13,500
      shortfall = 1 - 12000/13500 = 0.111
      penalty = 0.111 × 2.0 = 0.222
      P5_base = 15 × (1 - 0.222) = 11.67
      
    BLOCK CONDITION: final_intake < min_qty × 0.85
      → Vessel physically cannot load minimum required cargo
      → P5 = BLOCK
      
    offer_hint: "Vessel intake is below cargo minimum — be transparent about 
                 quantity limitations. Mention MOLOO flexibility if applicable."
    
  OVER CARGO: final_intake > max_qty
  ─────────────────────────────────────────
    excess = 1 - (max_qty / final_intake)
    penalty = excess × 2.0
    P5_base = MAX(15 × (1 - penalty), 2)
    
    Example: intake = 25,000, max_qty = 16,500
      excess = 1 - 16500/25000 = 0.340
      penalty = 0.340 × 2.0 = 0.680
      P5_base = 15 × (1 - 0.680) = 4.8
      
    Note: No BLOCK for over-cargo — vessel can always load less.
    But heavily penalized because owner won't want to waste capacity.
    
    offer_hint: "Vessel significantly larger than needed — emphasize 
                 attractive freight rate to compensate underutilization."

================================================================================
STEP 4 — VESSEL UTILIZATION PENALTY (additional modifier)
================================================================================

  PURPOSE: Penalize when external restrictions (draft, grain capacity) prevent
  the vessel from using her full capacity. An owner is less interested if 
  their vessel can only load 70% of what she could normally carry.
  
  APPLIES WHEN: Any restriction reduces intake below unrestricted capacity.
  This includes draft restrictions AND grain capacity limitations.
  
  FORMULA:
    unrestricted_intake = MIN(weight_intake, volume_intake)  # without draft limits
    restricted_intake = MIN(weight_intake, volume_intake, draft_restricted_intake)
    
    restriction_ratio = restricted_intake / unrestricted_intake
    
    If restriction_ratio >= 0.85: no additional penalty
    
    If restriction_ratio < 0.85:
      vessel_util_penalty = (0.85 - restriction_ratio) × 1.5
      P5_score = P5_base × (1 - vessel_util_penalty)
      
  EXAMPLE:
    Vessel DWT = 16,000, weight_intake = 15,750
    Port draft restriction → draft_restricted_intake = 12,000
    No volume restriction → volume_intake = 16,000
    
    unrestricted = MIN(15750, 16000) = 15,750
    restricted = MIN(15750, 16000, 12000) = 12,000
    restriction_ratio = 12000 / 15750 = 0.762
    
    0.762 < 0.85 → penalty applies
    vessel_util_penalty = (0.85 - 0.762) × 1.5 = 0.132
    P5_score = P5_base × (1 - 0.132) = P5_base × 0.868
    
  EXAMPLE with grain capacity limitation:
    weight_intake = 8,000
    volume_intake = 6,200 (grain capacity limits)
    No draft restriction
    
    unrestricted = MIN(8000, 6200) = 6,200 (volume limited)
    restricted = same = 6,200
    restriction_ratio = 1.0 → no penalty (grain cap IS the limit, not an external restriction)
    
    BUT if there's ALSO a draft restriction reducing it further:
    draft_restricted = 5,000
    restricted = MIN(8000, 6200, 5000) = 5,000
    unrestricted = MIN(8000, 6200) = 6,200
    restriction_ratio = 5000/6200 = 0.806 → penalty applies

================================================================================
STEP 5 — CUBATURE MODIFIER (for voluminous cargoes)
================================================================================

  PURPOSE: Additional penalty when vessel's hold volume limits intake
  significantly below weight capacity. Only relevant for light/bulky cargoes.
  
  APPLIES WHEN: SF > 47 (cargo is voluminous — grains, feeds, some minerals)
  
  FORMULA:
    cubature_ratio = volume_intake / weight_intake
    
    If cubature_ratio >= 0.85: no penalty (vessel has enough volume)
    
    If cubature_ratio < 0.85:
      cubature_penalty = (0.85 - cubature_ratio) × 1.5
      P5_score = P5_score × (1 - cubature_penalty)
      
  EXAMPLE:
    Vessel: DWT 8,000 → weight_intake = 7,750
    Grain capacity = 280,000 cbft, Cargo SF = 50
    volume_intake = 280000 / 50 = 5,600t
    
    cubature_ratio = 5600 / 7750 = 0.723
    0.723 < 0.85 → penalty applies
    cubature_penalty = (0.85 - 0.723) × 1.5 = 0.191
    P5_score = P5_score × (1 - 0.191) = P5_score × 0.809

================================================================================
FINAL P5 SCORE
================================================================================

  P5 = MAX(P5_score after all modifiers, 2)
  
  Unless BLOCK condition was triggered → then P5 = BLOCK
  
  BLOCK CONDITIONS:
    - final_intake < min_qty × 0.85 (vessel physically too small)
    - Missing DWT data

================================================================================
COMPLETE EXAMPLE — ADAMAR + WHEAT
================================================================================

  Cargo: wheat 15,000t ±10% ex Chornomorsk, SF = 47, port draft 7.5m
  Vessel: ADAMAR, DWT 16,653, draft 8.6m, grain capacity 694,700 cbft
  
  Step 1: min_qty = 13,500, max_qty = 16,500
  
  Step 2:
    weight_intake = 16653 - 250 = 16,403
    volume_intake = 694700 / 47 = 14,781
    draft_restricted = 16403 × (7.5/8.6) = 14,305 (approximate)
    final_intake = MIN(16403, 14781, 14305) = 14,305
    
  Step 3: Cargo Fit
    13,500 ≤ 14,305 ≤ 16,500 → PERFECT FIT
    P5_base = 15/15
    
  Step 4: Vessel Utilization
    unrestricted = MIN(16403, 14781) = 14,781
    restricted = 14,305
    ratio = 14305/14781 = 0.968 → no penalty (≥ 0.85)
    
  Step 5: Cubature (SF = 47, not > 47)
    Skipped — SF not above threshold
    
  Final P5 = 15/15
  offer_hint: "Cargo fits vessel well within draft restriction."

================================================================================
COMPLETE EXAMPLE — SMALL VESSEL + DRAFT RESTRICTION
================================================================================

  Cargo: wheat 8,000t ±5%, SF = 47, port draft 6.0m
  Vessel: DWT 6,800, draft 7.2m, grain capacity 220,000 cbft
  
  Step 1: min_qty = 7,600, max_qty = 8,400
  
  Step 2:
    weight_intake = 6800 - 250 = 6,550
    volume_intake = 220000 / 47 = 4,681
    draft_restricted = 6550 × (6.0/7.2) = 5,458
    final_intake = MIN(6550, 4681, 5458) = 4,681
    
  Step 3: Cargo Fit
    4,681 < min_qty × 0.85 = 6,460 → BLOCK
    Vessel physically cannot load minimum required cargo.
    
  Final P5 = BLOCK
  offer_hint: "Vessel cannot load minimum cargo quantity — grain capacity and 
               draft restriction limit intake to ~4,700t vs 7,600t minimum."

================================================================================
EDGE CASES
================================================================================

  Missing grain capacity:
    - Skip volume_intake calculation
    - Use weight_intake and draft_restricted only
    - Note: "Grain capacity unknown — intake based on DWT/draft only"
    - Reduce confidence

  Missing SF:
    - Skip cubature modifier
    - Note: "Cargo SF unknown — cubature check skipped"
    
  Vessel way too big (intake > max_qty × 3):
    - Apply over-cargo penalty as normal
    - P5_base will be very low (2-4 range)
    - offer_hint: "Vessel far too large for this parcel — only offer if 
                   vessel is desperate for cargo."
                   
  Vessel way too small (intake < min_qty × 0.5):
    - BLOCK
    - offer_hint: "Vessel far too small — do not offer."

================================================================================
AI INSTRUCTIONS
================================================================================

  ai_must:
    - Follow all 5 steps in order
    - Show calculation in reasoning
    - Identify the limiting factor (weight/volume/draft)
    - Apply vessel utilization penalty when restrictions reduce capacity
    - Apply cubature modifier only when SF > 47
    - Generate appropriate offer_hint
    
  ai_must_not:
    - Never skip Step 1 (cargo quantity parsing)
    - Never forget ROB deduction (250t)
    - Never ignore draft restrictions when provided
    - Never apply cubature penalty when SF ≤ 47
    - Never give score below 2 (except BLOCK)
    - Never assume volume_intake when grain capacity is missing

================================================================================
