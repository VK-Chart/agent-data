================================================================================
COMMENTS PROCESSING GUIDE — P2 & P3 Support
Version: 4.1
Last updated: 2026-02-20
================================================================================

PURPOSE:
  Guide for parsing and interpreting company/vessel/person comments to 
  extract owner preferences (P2), cargo preferences (P3), and relationship 
  data (P9). Comments are free-text and use shipping industry shorthand.

================================================================================
P2 — OWNER PREFERENCES (from comments + system settings)
================================================================================

  Score range: [0, 15]
  DYNAMIC CRITERION: If no preference data exists → score = 0, max_score = 0

  DATA SOURCES (check ALL):
    1. Company comments (free text)
    2. Person comments (free text)
    3. Vessel comments (free text)
    4. System settings / structured preferences (when available)
    
================================================================================
P2 — NO DATA vs NEUTRAL vs MATCH/CONFLICT
================================================================================

  This is a critical distinction. Three different situations:

  SITUATION A — NO PREFERENCE DATA AT ALL:
    score = 0, max_score = 0 (excluded from total)
    
    When to apply:
    - ALL comment sources are empty (no text at all)
    - Comments exist but contain ONLY non-preference information:
      • Business descriptions: "israel trader", "greek owner", "family company"
      • Relationship info: "works with Bunge", "Cargill via Clarkson"
      • Contact notes: "speak with John only", "email preferred"
      • Vessel operations: "fast loading", "good cranes"
      • Company size/type: "small operator", "single vessel company"
    - System settings have no preference data
    
    reasoning = "No owner preference data available — criterion excluded."

  SITUATION B — NEUTRAL (comments exist with preference-relevant words but no
    clear match or conflict):
    score = 7.5/15, max_score = 15
    
    When to apply:
    - Comments mention regions/cargoes but ambiguously
    - "open for all areas" → neutral
    - "flexible on cargo types" → neutral
    - Generic trading descriptions without specific preferences
    
    reasoning = "Comments exist but no clear preference match or conflict."

  SITUATION C — CLEAR MATCH OR CONFLICT:
    Score based on degree of match (see score mapping below)
    max_score = 15

================================================================================
P2 — WHAT IS AND IS NOT PREFERENCE DATA
================================================================================

  ✅ IS PREFERENCE DATA (score P2):
    "spec med/bs" → specializes in Med and Black Sea
    "pref atlantic" → prefers Atlantic trade
    "no ukr" → avoids Ukraine
    "ok greece but pref turkey" → Greece acceptable, Turkey preferred
    "avoids west africa" → negative for WA cargoes
    "only med/bs" → exclusive preference

  ❌ IS NOT PREFERENCE DATA (do NOT score P2, use 0/0):
    "israel trader" → business description, not a preference
    "greek owner" → nationality, not a preference
    "family company" → company type, not a preference
    "works direct with Bunge" → relationship data (P9), not preference
    "good operator" → reputation, not a preference
    "single vessel" → fleet info, not a preference
    "fast fixer" → behavior, not a preference
    "DPA in Istanbul" → operational info, not a preference

  ⚠️ EDGE CASES — use judgment:
    "trades mainly med" → WEAK preference data, score 7-8/15 (slight positive)
    "always in BS/Med area" → implied preference, score based on match
    "never goes to atlantic" → this IS a preference (negative for atlantic)

================================================================================
P2 — PARSING PREFERENCES FROM COMMENTS
================================================================================
  
  Keyword patterns:
    "spec [region]" → specialization, score 12-15 if match
    "pref [region]" → preference, score 10-12 if match
    "ok [region]" → acceptable, score 7.5-9 if match
    "no [region/country]" → hard block, score 0 for that region
    "avoids [region]" → soft block, score 2-4
    "only [region]" → exclusive, score 13-15 if match, 0-2 if not

  Score mapping:
    Perfect match (spec + region match): 15/15
    Good match (pref + region match): 10-12/15
    Acceptable match (ok + region): 7.5-9/15
    Neutral (ambiguous data): 7.5/15
    Soft conflict (avoids but not "no"): 3-5/15
    Hard conflict ("no [region]"): 0/15, potential BLOCK

================================================================================
P2 — ADJACENT REGION LOGIC FOR SPECIALIZATIONS
================================================================================

  ╔═══════════════════════════════════════════════════════════════════════════╗
  ║  "spec: [country]" implies adjacent countries are also acceptable.       ║
  ║  Score adjacent slightly lower than exact match (8-10/15 vs 12-15/15). ║
  ║                                                                          ║
  ║  ADJACENCY MAP:                                                          ║
  ║  "spec: italy"   → Greece, Croatia, Albania, Slovenia also ok           ║
  ║  "spec: libya"   → Tunisia, Egypt also ok                               ║
  ║  "spec: turkey"  → East Coast Greece, Bulgaria also ok                             ║
  ║  "spec: greece"  → Turkey, Albania, Bulgaria also ok             ║
  ║  "spec: egypt"   → Lebanon also ok                       ║
  ║  "spec: ukraine" → Romania (Constanta), Turkey (BS)(except Marmara Sea) also ok            ║
  ║  "spec: romania" → Bulgaria also ok                      ║
  ║                                                                          ║
  ║  SCORING:                                                                ║
  ║  Exact country match:    12-15/15                                        ║
  ║  Adjacent country match: 8-10/15                                         ║
  ║  Same broad region:      6-8/15                                          ║
  ║  Different region:       standard P2 rules apply                         ║
  ╚═══════════════════════════════════════════════════════════════════════════╝

  EXAMPLE:
    Comment: "spec: italy"
    Cargo loads Greece → adjacent to Italy → 8-10/15 (good, not perfect)
    Cargo loads Turkey → same broad Med region → 6-8/15
    Cargo loads Ukraine → different region → standard rules (possibly 5-7/15)

================================================================================
P3 — CARGO PREFERENCES (vessel/company comments)
================================================================================

  Score range: [0, 15]
  DYNAMIC CRITERION: If no cargo preference data exists → score = 0, max_score = 0

  DATA SOURCES:
    1. Company comments — may mention cargo specializations
    2. Vessel comments — may mention cargo types handled
    3. Vessel type — General Cargo, Bulk Carrier, etc.

  ╔═══════════════════════════════════════════════════════════════════════════╗
  ║  IMPORTANT: "spec: [country/region]" in comments is a LOCATION          ║
  ║  preference (P2), NOT a cargo preference. Do NOT activate P3 based     ║
  ║  on geographic specializations.                                          ║
  ║                                                                          ║
  ║  P3 is ONLY about cargo TYPE (grain, steel, fertilizer, etc.).          ║
  ║                                                                          ║
  ║  If rules.cargo[] is empty AND no cargo-type comments exist             ║
  ║  → P3 excluded (score = 0, max_score = 0).                             ║
  ║                                                                          ║
  ║  Examples:                                                               ║
  ║  "spec: ukraine" → P2 only (location), NOT P3                          ║
  ║  "spec: grain"   → P3 (cargo type)                                     ║
  ║  "no DG"         → P3 (cargo restriction)                              ║
  ║  "spec: italy"   → P2 only (location), NOT P3                          ║
  ╚═══════════════════════════════════════════════════════════════════════════╝
    
  NO DATA RULE:
    If no cargo preference information is found in any source:
      score = 0
      max_score = 0
      reasoning = "No cargo preference data available — criterion excluded."
      offer_hint = null

  PARSING CARGO PREFERENCES:
  
    "grain specialist" → high score for grain cargoes
    "cement carrier" → high score for cement, low for grain
    "no dangerous goods" → block for IMO/DG cargoes
    "clean holds required" → vessel maintained for sensitive cargoes
    "bulk only" → block for breakbulk/project cargo
    "steel/timber regular" → specialization indicators

================================================================================
AI MUST NOT — CRITICAL RULES
================================================================================

  ❌ Never consider vessel AGE when scoring P2 or P3.
     Age is NOT a preference factor. Age belongs in P8 only.
     
  ❌ Never treat business descriptions as preference data.
     "israel trader", "greek owner", "family company" = NOT preferences.
     These go to 0/0 (excluded) unless combined with actual preferences.
     
  ❌ Never assign neutral (7.5/15) when data clearly supports match/conflict.
  
  ❌ Never assign neutral (7.5/15) when comments contain only non-preference info.
     If no actual preference keywords found → use 0/0 (excluded).
     
  ❌ Never treat absence of negative data as positive.
     "No comment about grain" ≠ "vessel is good for grain"
     
  ❌ Never mix P2 (region preferences) with P3 (cargo preferences).
     P2 = WHERE the owner wants to trade
     P3 = WHAT cargo the vessel can/prefers to carry
     "spec: ukraine" → P2 (location), NOT P3
     "spec: grain" → P3 (cargo type)
     
  ❌ Never infer preferences from vessel type alone when comments exist.
     Comments override vessel type assumptions.
     
  ❌ Never consider vessel class, P&I, or flag in P2/P3 — that's P2A/P8.
  
  ❌ Never activate P3 based on geographic specializations.
     "spec: [country]" is ALWAYS P2, never P3.

================================================================================
COMMENT PARSING PATTERNS
================================================================================

  ABBREVIATIONS commonly found in comments:
    spec = specializes           pref = prefers  
    ok = acceptable              no = does not accept / avoids
    w/ = with                    w/o = without
    dg = dangerous goods         imo = IMO classified cargo
    bs = Black Sea               med = Mediterranean
    waf = West Africa            eaf = East Africa
    cont = Continent (NW Europe) ukr = Ukraine
    tur / trk = Turkey           gre = Greece
    ita = Italy                  fra = France
    
  RELATIONSHIP INDICATORS (for P9, see MASTER_SCORING_SYSTEM.txt):
    "works direct with [company]" → direct relationship
    "[company] cargoes via [broker]" → broker relationship
    "exclusive [company]" → exclusive relationship, caution
    "broker for [company]" → intermediary relationship

  NON-PREFERENCE INDICATORS (use 0/0 for P2):
    "[country] trader" → business description
    "[nationality] owner" → nationality info
    "family company" → company type
    "single vessel" → fleet size
    "good/reliable operator" → reputation

================================================================================
