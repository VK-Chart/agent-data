================================================================================
READINESS / ETA TO LOADING PORT SCORING — P7
Version: 5.0 FINAL
Last updated: 2026-02-07
================================================================================

PURPOSE:
  Score how well the vessel's availability timing matches the cargo laycan.
  Integrates draught analysis to determine if vessel needs operations buffer.

SCORE RANGE: [0, 10]
ALWAYS ACTIVE: max_score = 10

================================================================================
STEP 1 — MANDATORY DRAUGHT ANALYSIS
================================================================================

  ╔══════════════════════════════════════════════════════════════════╗
  ║  AI MUST perform draught analysis BEFORE calculating            ║
  ║  vessel_ready date. See vessel_location_determination.txt       ║
  ╚══════════════════════════════════════════════════════════════════╝

  FIELD USAGE:
    current_draught = field "current-draught" (from AIS)
    max_draft = field "draft" (summer loadline from vessel specs)
    ❌ Do NOT use "max-draught" field (max recorded, includes tropical)
    ❌ Do NOT use "min-draught" field (ballast reference only)

  MISSING / ZERO DRAFT:
    If field "draft" = 0.0, null, or missing:
      Draught analysis is IMPOSSIBLE (cannot divide by zero).
      Default to LADEN (+7 days buffer).
      confidence = "low"
      reasoning: "draft field is 0/missing — cannot calculate ratio.
                  Defaulting to laden (conservative)."

  STALE AIS DATA:
    Check field "position-received". If older than 7 days from today:
      confidence = "low"
      Add to reasoning: "AIS data is [X] days old — vessel may have
        moved since then. Position/draught data unreliable."
      Scoring still proceeds but with low confidence.

  DRAUGHT RATIO (when draft > 0):
    ratio = current_draught / max_draft (using field "draft")
    
    ratio < 0.65  → BALLAST
    ratio >= 0.65 → LADEN
    current > max → OVER_DRAFT → treat as LADEN

================================================================================
STEP 2 — DETERMINE VESSEL READY DATE
================================================================================

  ┌─────────────────────────────────────────────────────────┐
  │  CASE A: Vessel has open_area with date                 │
  └─────────────────────────────────────────────────────────┘
    Example: open_area = "Montoir, Feb 17"
    vessel_ready = Feb 17
    No buffer needed — vessel stated as open.
    Then calculate sailing time from open location to load port.
    vessel_at_loadport = vessel_ready + sailing_days
    
  ┌─────────────────────────────────────────────────────────┐
  │  CASE B: Vessel underway with destination + future ETA  │
  └─────────────────────────────────────────────────────────┘
    ETA is in the FUTURE (after today).
    
    BALLAST → vessel arrives at ETA. Available immediately.
      vessel_ready = ETA
      Then + sailing from destination to load port (if different)
      
    LADEN → vessel arrives, needs to discharge.
      vessel_ready = ETA + 7 days (operations buffer)
      Then + sailing from destination to load port (if different)
      
  ┌─────────────────────────────────────────────────────────┐
  │  CASE C: Vessel at destination / ETA in the PAST        │
  │  (IMPORTANT — common real-world scenario)               │
  └─────────────────────────────────────────────────────────┘
    Triggered when ANY of:
      - navigation-status = "At anchor" or "Moored"
      - ETA is in the past (before today)
      - Vessel speed < 2 knots AND at destination area
      
    The vessel has ALREADY ARRIVED at its destination.
    
    BALLAST at destination:
      Vessel is empty, waiting for cargo/orders.
      vessel_ready = TODAY (available now)
      Then + sailing from current location to load port
      
    LADEN at destination:
      Vessel is waiting to discharge or currently discharging.
      
      FORMULA:
        days_since_arrival = TODAY - MAX(ETA, position_received - 3 days)
        remaining_ops = MAX(0, 7 - days_since_arrival)
        vessel_ready = TODAY + remaining_ops
        
      Logic: Standard discharge takes ~7 days. If vessel arrived 
      6 days ago, only ~1 day remaining. If arrived today, 7 days.
      
      MINIMUM: vessel_ready = TODAY (never in the past)
      
      Then + sailing from current location to load port

    EXAMPLE (PETREL S):
      ETA = Feb 1, today = Feb 7, nav = "At anchor", laden (ratio 0.97)
      days_since_arrival = Feb 7 - Feb 1 = 6 days
      remaining_ops = MAX(0, 7 - 6) = 1 day
      vessel_ready = Feb 7 + 1 = Feb 8
      sailing Lisboa → POC: ~3000nm / 10.2 knots / 24 = ~12.3 days
      vessel_at_loadport = Feb 8 + 12 = Feb 20
      
  ┌─────────────────────────────────────────────────────────┐
  │  CASE D: No destination / no ETA                        │
  └─────────────────────────────────────────────────────────┘
    Estimate sailing time from current position to load port.
    Use average-speed or default 10-12 knots.
    Add 1 day buffer.
    confidence = "low"

================================================================================
STEP 3 — CALCULATE SAILING TIME TO LOAD PORT
================================================================================

  After determining vessel_ready, calculate sailing to load port:
  
  sailing_days = distance_nm / (speed_knots × 24)
  
  Speed source (priority):
    1. field "average-speed" (if available and > 0)
    2. Default 10.5 knots for bulk carriers / general cargo
    
  vessel_at_loadport = vessel_ready + sailing_days
  
  Note: If vessel is ALREADY near load port area, sailing_days ≈ 0.

================================================================================
STEP 4 — CALCULATE GAP
================================================================================

  gap = vessel_at_loadport - cargo_layday (start of laycan)
  
  Positive gap = vessel is late (arrives AFTER layday)
  Negative gap = vessel is early (arrives BEFORE layday)
  Zero = perfect timing

================================================================================
STEP 5 — SCORING MATRIX
================================================================================

  gap <= -7 days (very early):     score = 4/10
  gap = -6 to -3 days (early):    score = 7/10
  gap = -2 to +1 days (ideal):    score = 10/10
  gap = +2 to +3 days (slightly late): score = 7/10
  gap = +4 to +5 days (late):     score = 4/10
  gap = +6 to +7 days (very late): score = 2/10
  gap > +7 days (past canceling):  score = 0/10, decision = BLOCK

================================================================================
EXAMPLES
================================================================================

  Example 1: Laden at anchor, ETA in past (PETREL S scenario)
  ─────────────────────────────────────────
    Vessel: At anchor Lisboa. ETA Feb 1 (past). Today Feb 7.
    current-draught: 8.3, draft: 8.48 → ratio 0.978 → LADEN
    days_since_arrival = 6. remaining_ops = MAX(0, 7-6) = 1
    vessel_ready = Feb 8
    Sailing Lisboa → POC: 3000nm / 10.2kn / 24h = 12.3d ≈ 12d
    vessel_at_loadport = Feb 8 + 12 = Feb 20
    Cargo layday Feb 5, canceling Feb 10
    gap = Feb 20 - Feb 5 = +15 days → BLOCK
    reasoning: "Laden at anchor Lisboa since ~Feb 1 (ratio 0.978).
               Est. ready Feb 8, +12d sailing = arrives POC ~Feb 20.
               Misses canceling Feb 10 by 10 days."

  Example 2: Ballast underway, future ETA
  ─────────────────────────────────────────
    Vessel heading Mersin, ETA Feb 10. ratio 0.40 → BALLAST
    vessel_ready = Feb 10 (no buffer)
    Cargo loads Mersin → sailing = 0 days
    vessel_at_loadport = Feb 10
    Layday Feb 8 → gap = +2 days → score = 7/10

  Example 3: Open vessel
  ─────────────────────────────────────────
    open_area = "Constanta, Feb 12"
    vessel_ready = Feb 12
    Cargo loads Chornomorsk (~50nm) → 0.2d sailing
    vessel_at_loadport = Feb 12
    Layday Feb 14 → gap = -2 days → score = 10/10

  Example 4: Laden underway, future ETA
  ─────────────────────────────────────────
    Heading Ravenna, ETA Feb 13. ratio 0.85 → LADEN
    vessel_ready = Feb 13 + 7 = Feb 20
    Sailing Ravenna → POC: ~800nm / 10.5kn = 3.2d ≈ 3d
    vessel_at_loadport = Feb 20 + 3 = Feb 23
    Layday Feb 5 → gap = +18 → BLOCK

  Example 5: No draught data
  ─────────────────────────────────────────
    Heading Istanbul, ETA Feb 8. No current-draught.
    Default LADEN. vessel_ready = Feb 8 + 7 = Feb 15
    confidence = "medium"

================================================================================
REASONING FORMAT
================================================================================

  P7 reasoning MUST include:
    1. Draught analysis: ratio, ballast/laden status
    2. How vessel_ready was calculated (which CASE)
    3. Sailing time to load port (distance, speed, days)
    4. vessel_at_loadport date
    5. Gap in days
    6. Laycan reference (layday + canceling dates)

  Good: "Laden at anchor Lisboa since ~Feb 1 (ratio 0.978). 
         Remaining ops ~1d, ready Feb 8. +12d sailing to POC = 
         arrives ~Feb 20. Layday Feb 5, canceling Feb 10, gap +15d."
         
  Bad:  "Vessel is laden in Lisboa. Ready Feb 11 + 11d sailing = Feb 22."
        (Where does Feb 11 come from? Unclear.)

================================================================================
AI INSTRUCTIONS
================================================================================

  ai_must:
    - ALWAYS perform draught analysis first (use "draft" field, not "max-draught")
    - Determine which CASE applies (A/B/C/D)
    - For CASE C (at anchor/ETA past): calculate days_since_arrival
    - Calculate sailing time from ready location to LOAD PORT
    - Show all calculation steps in reasoning
    - Use field "average-speed" when available for sailing calculation
    
  ai_must_not:
    - ❌ Never use "max-draught" for draught ratio
    - ❌ Never skip draught analysis
    - ❌ Never forget to add sailing time to load port
    - ❌ Never produce vessel_ready date without showing how it was derived
    - ❌ Never ignore "At anchor" / "Moored" navigation status
    - ❌ Never ignore ETA being in the past

================================================================================
