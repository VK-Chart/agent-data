# ═══════════════════════════════════════════════════════════════════
# P7: READINESS/ETA TO LOADING PORT SCORING - UPDATED v2.0
# VK Charts AI Scoring System
# ═══════════════════════════════════════════════════════════════════
#
# CHANGES IN v2.0:
# - Added ETA + 7 days operations logic
# - Added layday vs canceling date scoring thresholds
# - Added AIS staleness warning (30+ days)
# - Clarified difference between destination ETA vs actual opening
# - Added Tuzla dry dock special handling
#
# ═══════════════════════════════════════════════════════════════════

version: "2.0"
date: "2026-01-19"
priority: "CRITICAL - Timing compatibility affects commercial viability"

# ═══════════════════════════════════════════════════════════════════
# OVERVIEW
# ═══════════════════════════════════════════════════════════════════

purpose: |
  P7 evaluates whether vessel will be ready at loading port in time
  for the cargo's laycan (loading window). 
  
  SCORE RANGE: 0-10 points
  
  KEY PRINCIPLE:
  - Vessel ready BEFORE layday = idle time cost (unfavorable)
  - Vessel ready AT layday = perfect timing (optimal)
  - Vessel ready AFTER canceling = impossible (blocked)

# ═══════════════════════════════════════════════════════════════════
# DATA SOURCES & PRIORITY
# ═══════════════════════════════════════════════════════════════════

data_sources:
  
  priority_1_open_area:
    source: "OpenArea field (manually set)"
    format: "Port name + Date"
    example: "Constanta, Jan 20"
    reliability: "HIGHEST - directly stated by owner"
    
    usage: |
      If open_area is provided, use this as the definitive opening position
      and date. This is the owner's stated availability.
  
  priority_2_destination:
    source: "Destination field (from AIS)"
    format: "Port name"
    additional: "ETA (Estimated Time of Arrival)"
    reliability: "MEDIUM - vessel is heading there, but purpose unknown"
    
    usage: |
      If destination is set, vessel is likely going there to:
      a) Discharge current cargo, OR
      b) Load next cargo, OR
      c) Bunkers/provisions/repairs
      
      CRITICAL: Add +7 days to ETA for operations (loading/discharge)
      before vessel is actually "open" for next cargo.
    
    special_case_tuzla:
      port: "Tuzla (Turkey)"
      interpretation: "DRY DOCK / REPAIRS"
      add_time: "+30 days (minimum)"
      reasoning: |
        Tuzla is a major repair/dry dock location. If vessel is currently
        in Tuzla or heading to Tuzla, assume repairs lasting ~1 month.
        Repair completion dates are uncertain.
      
      scoring_impact:
        if_current_in_tuzla: "P7 score = 2/10 (high uncertainty)"
        if_heading_to_tuzla: "P7 score = 3/10 (repairs expected)"
  
  priority_3_current_area:
    source: "Current Area field (from AIS)"
    format: "Geographic region"
    example: "East Mediterranean"
    reliability: "LOW - only shows current position, no destination"
    
    usage: |
      Use only if no open_area or destination available.
      Assume vessel is at anchor or drifting, date from position_received.
  
  ais_staleness_check:
    threshold: 30
    threshold_unit: "days"
    
    check: |
      If (current_date - position_received) > 30 days:
        - AIS may be turned off
        - Vessel may have issues
        - Position data UNRELIABLE
    
    action:
      add_warning: true
      warning_text: |
        "⚠️ Warning: AIS data is stale (last update: {position_received}).
        Vessel may have disabled AIS or encountered issues.
        Position reliability: LOW."
      
      reduce_confidence:
        overall_confidence: -10
        p7_confidence: -20

# ═══════════════════════════════════════════════════════════════════
# OPERATIONS TIME ESTIMATION
# ═══════════════════════════════════════════════════════════════════

operations_time:
  
  principle: |
    If vessel has a destination with ETA but no explicit "open" date,
    we must add time for loading/discharge operations before vessel
    is actually ready for next cargo.
  
  standard_operations:
    duration: 7
    unit: "days"
    reasoning: |
      Standard allowance for loading OR discharge operations.
      Covers:
      - Port approach and berthing
      - Cargo operations (loading or discharge)
      - Documentation and clearance
      - Departure
    
    note: |
      Loading and discharge times differ, but for simplicity we use
      a standard 7-day allowance. This prevents over-complexity.
  
  calculation_example:
    scenario: "Vessel heading to Mersin, ETA Jan 25"
    cargo_laycan: "Feb 5"
    
    calculation:
      eta_arrival: "Jan 25"
      operations: "+7 days"
      vessel_ready: "Feb 1"
      days_before_layday: "4 days"
      
    result:
      p7_score: "8/10 (good timing)"

# ═══════════════════════════════════════════════════════════════════
# LAYCAN HANDLING
# ═══════════════════════════════════════════════════════════════════

laycan_logic:
  
  definitions:
    layday:
      definition: "FIRST possible loading date"
      abbreviation: "L/D or Layday"
      example: "Feb 5, 2026"
      
    canceling_date:
      definition: "LAST possible arrival date"
      abbreviation: "CAN or Canceling"
      example: "Feb 10, 2026"
      
    full_laycan:
      format: "Layday - Canceling"
      example: "Feb 5-10, 2026"
      interpretation: "Vessel must arrive between Feb 5 and Feb 10"
  
  single_date_handling:
    scenario: "Cargo shows only one date (e.g., '05 feb 2026')"
    
    interpretation_1:
      if_format: "Single date with no range"
      treat_as: "BOTH layday AND canceling on same date"
      example: "05 feb 2026 → Layday: Feb 5, Canceling: Feb 5"
      tolerance: "+7 days implicit tolerance"
      
      scoring:
        vessel_ready_on_date: "10/10 (perfect)"
        vessel_ready_1_3_days_early: "9/10"
        vessel_ready_4_7_days_early: "7/10"
        vessel_ready_8_plus_days_early: "< 5/10"
        vessel_ready_1_7_days_late: "5/10"
        vessel_ready_8_plus_days_late: "2/10"
  
  range_handling:
    scenario: "Cargo shows range (e.g., '05-10 feb 2026')"
    
    interpretation:
      layday: "Feb 5 (first date)"
      canceling: "Feb 10 (last date)"
      
    scoring:
      vessel_ready_on_layday: "10/10 (perfect timing)"
      vessel_ready_before_layday: "See early arrival matrix below"
      vessel_ready_after_layday_before_canceling: "7/10 (acceptable)"
      vessel_ready_after_canceling: "2/10 (very problematic)"

# ═══════════════════════════════════════════════════════════════════
# SCORING MATRIX v2.0
# ═══════════════════════════════════════════════════════════════════

scoring_matrix_v2:
  
  # ─────────────────────────────────────────────────────────────────
  # PERFECT TIMING
  # ─────────────────────────────────────────────────────────────────
  
  on_time:
    condition: "Vessel ready 0-3 days before layday"
    score: 10
    confidence: 90
    reasoning: "Perfect timing - vessel arrives just before laycan starts"
    example: "Layday Feb 5, vessel ready Feb 3"
  
  # ─────────────────────────────────────────────────────────────────
  # EARLY ARRIVAL (Idle Time Costs)
  # ─────────────────────────────────────────────────────────────────
  
  slightly_early:
    condition: "Vessel ready 4-7 days before layday"
    score: 8
    confidence: 85
    reasoning: "Good timing, minor idle time"
    example: "Layday Feb 5, vessel ready Jan 30"
  
  early:
    condition: "Vessel ready 8-15 days before layday"
    score: 5
    confidence: 85
    reasoning: "Early - vessel needs filler cargo or waits with idle costs"
    example: "Layday Feb 5, vessel ready Jan 22"
    citations:
      - "Correction (akdeniz, valmiera): Long gap before laycan unfavorable"
  
  too_early:
    condition: "Vessel ready 16-25 days before layday"
    score: 2
    confidence: 90
    reasoning: "Too early - significant idle time, owner will seek other business"
    example: "Layday Feb 5, vessel ready Jan 12"
    citations:
      - "Correction: 23-day gap is highly unfavorable"
  
  very_early:
    condition: "Vessel ready 25+ days before layday"
    score: 0
    confidence: 90
    reasoning: "Far too early - vessel will fix other cargo before this laycan"
    example: "Layday Feb 5, vessel ready Dec 30"
    citations:
      - "Correction (ak khadeja): 36-day gap means vessel will fix other business"
  
  # ─────────────────────────────────────────────────────────────────
  # LATE ARRIVAL
  # ─────────────────────────────────────────────────────────────────
  
  after_layday_before_canceling:
    condition: "Vessel ready after layday but before canceling"
    score: 7
    confidence: 80
    reasoning: "Acceptable - vessel arrives during laycan window"
    example: "Layday Feb 5, Canceling Feb 10, vessel ready Feb 7"
  
  after_canceling_slight:
    condition: "Vessel ready 1-3 days after canceling"
    score: 4
    confidence: 75
    reasoning: "Risky - charterer may cancel, requires negotiation"
    example: "Canceling Feb 10, vessel ready Feb 12"
  
  after_canceling_significant:
    condition: "Vessel ready 4-7 days after canceling"
    score: 2
    confidence: 70
    reasoning: "Very problematic - charterer likely to cancel"
    example: "Canceling Feb 10, vessel ready Feb 15"
  
  impossible:
    condition: "Vessel ready 8+ days after canceling"
    score: 0
    confidence: 90
    reasoning: "Impossible - vessel cannot make laycan"
    example: "Canceling Feb 10, vessel ready Feb 20"

# ═══════════════════════════════════════════════════════════════════
# AI CALCULATION PROCESS
# ═══════════════════════════════════════════════════════════════════

ai_calculation_process:
  
  step_1_determine_vessel_ready_date:
    
    option_a_open_area_provided:
      if: "open_area field exists"
      then: "Use open_area date as vessel_ready_date"
      example: "open_area: 'Constanta, Jan 20' → vessel_ready = Jan 20"
    
    option_b_destination_with_eta:
      if: "destination + ETA provided, no open_area"
      then: "vessel_ready_date = ETA + 7 days"
      example: "destination: Mersin, ETA: Jan 25 → vessel_ready = Feb 1"
      
      special_case_tuzla:
        if: "destination = Tuzla"
        then: "vessel_ready_date = ETA + 30 days (dry dock)"
        example: "destination: Tuzla, ETA: Jan 20 → vessel_ready = Feb 20"
    
    option_c_current_area_only:
      if: "Only current_area available, no destination"
      then: "vessel_ready_date = position_received date"
      caveat: "Assume vessel at anchor, ready immediately"
      
    option_d_ais_stale:
      if: "(current_date - position_received) > 30 days"
      then:
        add_warning: true
        reduce_confidence: true
        use_conservative_estimate: true
  
  step_2_parse_laycan:
    
    single_date:
      format: "05 feb 2026"
      interpretation:
        layday: "Feb 5, 2026"
        canceling: "Feb 5, 2026 (same day)"
        tolerance: "+7 days implicit"
    
    date_range:
      format: "05-10 feb 2026"
      interpretation:
        layday: "Feb 5, 2026"
        canceling: "Feb 10, 2026"
  
  step_3_calculate_gap:
    formula: "gap_days = layday - vessel_ready_date"
    
    examples:
      example_1:
        vessel_ready: "Feb 3"
        layday: "Feb 5"
        gap: "+2 days (vessel 2 days early)"
        
      example_2:
        vessel_ready: "Jan 20"
        layday: "Feb 5"
        gap: "+16 days (vessel 16 days early)"
        
      example_3:
        vessel_ready: "Feb 7"
        layday: "Feb 5"
        gap: "-2 days (vessel 2 days late)"
  
  step_4_determine_score:
    use: "scoring_matrix_v2 thresholds"
    match_gap_to_condition: true
    output_score: "[0-10]"
  
  step_5_generate_reasoning:
    include:
      - "How vessel_ready_date was determined"
      - "Laycan window (layday-canceling)"
      - "Gap in days (early/late)"
      - "Commercial impact (idle cost / impossible / perfect)"
    
    template: |
      "Vessel ready [date] ([source]). Laycan starts [layday]. 
      Gap: [X] days [early/late]. [Impact assessment]."
    
    example: |
      "Vessel ready Feb 1 (destination Mersin ETA Jan 25 + 7 days operations).
      Laycan starts Feb 5. Gap: 4 days early. Minor idle time, acceptable timing."

# ═══════════════════════════════════════════════════════════════════
# CRITICAL AI INSTRUCTIONS
# ═══════════════════════════════════════════════════════════════════

ai_must:
  - "ALWAYS add +7 days to destination ETA if no explicit open date"
  - "ALWAYS check AIS staleness (30+ days)"
  - "ALWAYS treat Tuzla as dry dock (+30 days)"
  - "ALWAYS calculate gap relative to LAYDAY, not canceling"
  - "NEVER assume vessel is ready at destination ETA without operations time"

ai_must_not:
  - "Never ignore the +7 days operations buffer"
  - "Never treat single date as only layday (it's also canceling)"
  - "Never give high score for 20+ day early arrival"

# ═══════════════════════════════════════════════════════════════════
# END OF P7 READINESS/ETA SCORING v2.0
# ═══════════════════════════════════════════════════════════════════
