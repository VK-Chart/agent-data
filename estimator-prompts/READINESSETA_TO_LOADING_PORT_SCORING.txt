================================================================================
READINESS / ETA TO LOADING PORT SCORING — P7
Version: 4.0
Last updated: 2026-02-07
================================================================================

PURPOSE:
  Score how well the vessel's availability timing matches the cargo laycan.
  Integrates draught analysis to determine if vessel needs operations buffer.

SCORE RANGE: [0, 10]
ALWAYS ACTIVE: max_score = 10

================================================================================
STEP 1 — MANDATORY DRAUGHT ANALYSIS
================================================================================

  ╔══════════════════════════════════════════════════════════════════╗
  ║  CRITICAL: AI MUST perform draught analysis BEFORE calculating  ║
  ║  vessel_ready date. Without this step, P7 score may be wrong.  ║
  ║  See vessel_location_determination.txt for full details.       ║
  ╚══════════════════════════════════════════════════════════════════╝

  DRAUGHT RATIO FORMULA:
    draught_ratio = current_draught / max_draft
    
    Fields: current-draught (from AIS/VesselFinder), draft (vessel specs)

  THRESHOLDS:
    ratio < 0.65  → BALLAST (vessel empty, heading to load)
    ratio >= 0.65 → LADEN (vessel carrying cargo, heading to discharge)
    current > max → OVER_DRAFT (data anomaly, treat as LADEN)
    
  If current_draught is NOT available:
    Default to LADEN (conservative) and note in reasoning.

================================================================================
STEP 2 — DETERMINE VESSEL READY DATE
================================================================================

  A) Vessel is OPEN with a date:
     Example: "open Montoir Feb 17"
     vessel_ready = Feb 17 (use as-is)
     No buffer needed — vessel stated as open.
     
  B) Vessel has destination + ETA:
     Perform draught analysis first, then:
     
     If BALLAST (ratio < 0.65):
       vessel_ready = ETA
       Note: "Vessel in ballast — no operations buffer. Confirm with 
              owner if heading for loading or available for redirection."
              
     If LADEN (ratio >= 0.65):
       vessel_ready = ETA + 7 days
       Note: "Vessel laden — adding 7 days buffer (discharge + preparation)."
              
     If OVER_DRAFT (current > max):
       vessel_ready = ETA + 7 days
       Note: "Draught exceeds max (data anomaly) — treating as laden, +7d."

  C) Vessel has no destination/ETA:
     Estimate sailing time from current position to loading port.
     Use average speed 10-12 knots. Add 1 day port entry buffer.
     confidence = "low"

================================================================================
STEP 3 — CALCULATE GAP
================================================================================

  gap = vessel_ready - cargo_layday (start of laycan)
  
  Positive gap = vessel is late (arrives AFTER layday)
  Negative gap = vessel is early (arrives BEFORE layday)
  Zero = perfect timing

================================================================================
STEP 4 — SCORING MATRIX
================================================================================

  gap <= -7 days (very early):
    score = 4/10
    Vessel idle too long. Owner may lose interest.
    offer_hint: "Vessel ready much earlier — suggest flexibility on dates."

  gap = -6 to -3 days (early):
    score = 7/10
    Slight wait but manageable.
    offer_hint: "Ready a few days early — timing works."

  gap = -2 to +1 days (ideal window):
    score = 10/10
    Perfect timing.
    offer_hint: "Timing aligns perfectly — highlight in opening."

  gap = +2 to +3 days (slightly late):
    score = 7/10
    Acceptable if flexible.
    offer_hint: "Timing slightly tight — mention laycan flexibility."

  gap = +4 to +5 days (late):
    score = 4/10
    Risky, may miss canceling.
    offer_hint: "Timing tight — offer only if laycan may extend."

  gap = +6 to +7 days (very late):
    score = 2/10
    Likely misses canceling.
    offer_hint: "Likely misses canceling — only if extension confirmed."

  gap > +7 days (past canceling):
    score = 0/10, decision = BLOCK
    offer_hint: "Cannot meet laycan — do not offer."

================================================================================
SPECIAL CASES
================================================================================

  BALLAST QUESTION:
    When vessel is in ballast heading somewhere:
    - Score using ETA (without +7 days)
    - Add question to offer: confirm if fixed or open
    - offer_hint includes: "Vessel appears in ballast — confirm with 
      owner if proceeding for loading or available for redirection."

  NO ETA AVAILABLE:
    - Estimate sailing time from current position
    - Use 10-12 knots average speed + 1 day buffer
    - Score with low confidence
    
  VESSEL AT ANCHOR (no destination):
    - If at/near load port area → vessel_ready = today/tomorrow
    - If elsewhere → estimate sailing time
    - Check if waiting for cargo, berth, or instructions

================================================================================
EXAMPLES
================================================================================

  Example 1: Laden vessel (draught analysis applied)
    Vessel heading Ravenna, ETA Feb 13
    current_draught = 8.8m, max_draft = 8.6m
    draught_ratio = 8.8/8.6 = 1.023 → OVER_DRAFT → treat as LADEN
    vessel_ready = Feb 13 + 7 = Feb 20
    Cargo layday = Feb 5, canceling = Feb 10
    gap = Feb 20 - Feb 5 = +15 days → score = 0/10, BLOCK
    reasoning: "Draught 8.8m > max 8.6m (over_draft, treat as laden). 
               After +7d operations buffer: ready Feb 20. Misses laycan by 15 days."

  Example 2: Ballast vessel (draught analysis applied)
    Vessel heading Mersin, ETA Feb 10
    current_draught = 2.1m, max_draft = 5.2m
    draught_ratio = 2.1/5.2 = 0.404 → BALLAST
    vessel_ready = Feb 10 (no buffer)
    Cargo layday = Feb 8, canceling = Feb 15
    gap = Feb 10 - Feb 8 = +2 days → score = 7/10
    reasoning: "Vessel in ballast (ratio 0.40). No operations buffer.
               Ready Feb 10, gap +2 days — acceptable timing."

  Example 3: Open vessel
    Vessel open Constanta Feb 12
    vessel_ready = Feb 12 (stated opening)
    Cargo layday = Feb 14, canceling = Feb 20
    gap = Feb 12 - Feb 14 = -2 days → score = 10/10
    reasoning: "Open Constanta Feb 12, gap -2 days — ideal timing."

  Example 4: No draught data
    Vessel heading Istanbul, ETA Feb 8. No current_draught available.
    → Default to LADEN (conservative)
    vessel_ready = Feb 8 + 7 = Feb 15
    Cargo layday = Feb 12
    gap = +3 days → score = 7/10
    reasoning: "No draught data — defaulting to laden (+7d buffer).
               Ready Feb 15, gap +3 days. Confirm actual status."
    confidence = "medium"

================================================================================
AI INSTRUCTIONS
================================================================================

  ai_must:
    - ALWAYS perform draught analysis before calculating vessel_ready
    - Show draught_ratio and ballast/laden determination in reasoning
    - Apply +7 days buffer for LADEN vessels, 0 days for BALLAST
    - Default to LADEN when draught data is missing
    - Include draught status in offer_hint when relevant
    
  ai_must_not:
    - ❌ Never skip draught analysis when current_draught is available
    - ❌ Never assume vessel is in ballast without checking ratio
    - ❌ Never forget +7 days buffer for laden vessels
    - ❌ Never score P7 without first determining vessel_ready date
    - ❌ Never ignore OVER_DRAFT condition (treat as laden)

================================================================================
