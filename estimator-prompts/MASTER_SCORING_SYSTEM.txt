================================================================================
MASTER SCORING SYSTEM
Version: 6.0 FINAL
Last updated: 2026-02-07
================================================================================

PURPOSE:
  Central scoring framework for vessel-cargo matching. Defines all criteria,
  dynamic score calculation, priority order, P9 relationship check, and 
  offer opening generation logic.

================================================================================
VESSEL JSON FIELD MAPPING
================================================================================

  AI must use the correct fields from vessel JSON:

  VESSEL SPECS:
    DWT            → field "dwt"
    Max summer draft → field "draft" (NOT "max-draught")
    LOA            → field "length-overall"
    Beam           → field "beam"
    Year built     → field "year-of-build"
    Grain capacity → field "grain-capacity" (cubic feet)
    Class          → field "classification-society"
    Flag           → field "flag"
    Flag MOU status → field "flag-performance" (e.g., "Paris MOU: Grey")
    P&I            → field "pi_information"
    Holds          → field "holds"
    Hatches        → field "hatches"
    Gear           → field "gear-details"

  AIS / POSITION DATA:
    Current draught → field "current-draught" (from AIS, meters)
    Destination    → field "destination"
    ETA            → field "eta" (ISO datetime)
    Speed          → field "speed"
    Nav status     → field "navigation-status"
    Position time  → field "position-received" (when AIS data was received)
    Current area   → field "vessel_current_area"
    Average speed  → field "average-speed"

  DRAUGHT ANALYSIS FIELDS:
    For draught ratio, use: current-draught / draft
    ❌ Do NOT use "max-draught" (this is max recorded, may include tropical)
    ❌ Do NOT use "min-draught" (this is ballast reference)
    ✅ Use "draft" = summer loadline draft from vessel specs

  COMMENTS / PREFERENCES:
    Vessel comments     → field "comments" (array)
    Company comments    → field "companies[].comments" (array per company)
    Person comments     → field "people[].comments" (array per person)
    OpenArea           → field "open_area" (string or null)

  PORT HISTORY:
    Vessel top ports    → field "top_ports.vessel" (array)
    Company top ports   → field "top_ports.company.items" (array)
    Both sources should be used for P4 scoring.

================================================================================
ALL CRITERIA — OVERVIEW
================================================================================

  Code  Name                    Max    Type       Reference File
  ────  ────────────────────    ───    ────       ──────────────
  P1    Proximity               20     Always     proximity_scoring_matrix.txt
  P1A   Regional Patterns       15     Always     P1A_REGIONAL_SCORING_RULES.txt
  P2    Owner Preferences       15     Dynamic    COMMENTS_PROCESSING_GUIDE.txt
  P2A   PSC Port Accessibility  20     Always     P2A_PSC_PORT_ACCESSIBILITY_SCORING.txt
  P3    Cargo Preferences       15     Dynamic    COMMENTS_PROCESSING_GUIDE.txt
  P4    Last Ports              10     Always     P4_LAST_PORTS_SCORING.txt
  P5    Intake / Cargo Fit      15     Always     intake_calculator_formula.txt
  P6    OpenArea Comments       15     Dynamic    OPEN_AREA_COMMENTS_SCORING.txt
  P7    Readiness / ETA         10     Always     READINESSETA_TO_LOADING_PORT_SCORING.txt
  P8    Restrictions            20     Dynamic    P8_RESTRICTIONS_COMPLIANCE_SCORING.txt
  P9    Relationship Check      —      Warning    (this file, section below)

================================================================================
DYNAMIC MAX_SCORE CALCULATION
================================================================================

  ALWAYS ACTIVE (max_score is always set):
    P1  = 20
    P1A = 15
    P2A = 20
    P4  = 10
    P5  = 15
    P7  = 10
    ────────
    Base always-active MAX = 90

  DYNAMIC (max_score = 0 if no data, otherwise max):
    P2  = 15 or 0 (no owner preference data → excluded)
    P3  = 15 or 0 (no cargo preference data → excluded)
    P6  = 15 or 0 (no OpenArea comments → excluded)
    P8  = 20 or 0 (no restrictions set → excluded)

  FORMULA:
    dynamic_max_score = SUM of max_score for ALL criteria where max_score > 0
    
    Minimum: 90 (only always-active criteria)
    Maximum: 90 + 15 + 15 + 15 + 20 = 155 (all criteria active)

  ╔══════════════════════════════════════════════════════════════════╗
  ║  FINAL SCORE — ALWAYS EXPRESSED AS PERCENTAGE:                  ║
  ║                                                                 ║
  ║  total_score = ROUND((total_score_raw / dynamic_max_score)×100) ║
  ║                                                                 ║
  ║  total_score is a number from 0 to 100 (percentage).            ║
  ║  NEVER report total_score as raw points.                        ║
  ╚══════════════════════════════════════════════════════════════════╝

================================================================================
EVALUATION PRIORITY ORDER
================================================================================

  1. P8  — Restrictions Compliance (BLOCK potential — but NOT for age)
  2. P5  — Intake / Cargo Fit (BLOCK potential — includes draft restrictions)
  3. P2A — PSC Port Accessibility (BLOCK potential)
  4. P2  — Owner Preferences (BLOCK potential for "no X")
  5. P3  — Cargo Preferences
  6. P6  — OpenArea Comments
  7. P4  — Last Ports
  8. P1A — Regional Patterns
  9. P1  — Proximity (BLOCK for non-viable distances)
  10. P7  — Readiness / ETA (BLOCK for missed laycan)
  11. P9  — Relationship Check (warning only, no score)

  IMPORTANT: Even when a BLOCK is found early, score ALL remaining criteria.

================================================================================
CRITICAL — RESTRICTION SCOPE RULES
================================================================================

  P5 handles: Draft/draught restrictions, cargo quantity fit, cubature
  P8 handles: ONLY Class, P&I, IMO, Holds Type, DWT, Age, LOA, Beam
  P2A handles: PSC risk based on flag, class, P&I, age, port strictness
  P2 handles: Owner's regional preferences from comments
  P3 handles: Cargo type preferences from comments

  Draft restrictions → P5. NEVER in P8.

================================================================================
BLOCK LOGIC
================================================================================

  Any criterion can produce a BLOCK. A single BLOCK = vessel is not viable.
  
  When BLOCK is triggered:
    - recommendation = "BLOCKED"
    - Still score ALL other criteria
    - Mark blocked criterion with "decision": "blocked", "critical": true
    - short_summary explains why vessel is blocked
    - Offer opening IS STILL generated (see below)

  Multiple BLOCKs: Report all. Summary mentions the most impactful.

================================================================================
RECOMMENDATION CATEGORIES
================================================================================

  BLOCKED — One or more criteria triggered BLOCK
  STRONG (80%+) — Excellent match
  GOOD (65-80%) — Solid match with minor issues
  CONDITIONAL (50-65%) — Decent match, has concerns
  WEAK (35-50%) — Poor match but may work
  SKIP (<35%) — Not worth offering

================================================================================
P9 — RELATIONSHIP CHECK (WARNING ONLY)
================================================================================

  P9 is NOT a scoring criterion. It generates a warning flag.

  DATA SOURCES:
    - companies[].comments
    - people[].comments
    - vessel comments[]
    
  WARNING TYPES:

    DIRECT_RELATIONSHIP
      Trigger: "works direct with [charterer]"
      Offer impact: "in case you haven't seen this yet"
               
    BROKER_RELATIONSHIP
      Trigger: "[charterer] cargoes via [broker]"
      Offer impact: Owner may redirect to their broker.
               
    NO_RELATIONSHIP (CLEAR)
      Warning: null

  OUTPUT:
    "relationship_warning": { "status": "CLEAR" }
    or
    "relationship_warning": {
      "status": "WARNING",
      "type": "direct_relationship",
      "details": "...",
      "offer_guidance": "..."
    }

================================================================================
OFFER OPENING GENERATION — ALWAYS REQUIRED
================================================================================

  ╔══════════════════════════════════════════════════════════════════╗
  ║  Offer opening is ALWAYS generated, including for BLOCKED       ║
  ║  vessels. For BLOCKED vessels, use intent "blocked_info".       ║
  ╚══════════════════════════════════════════════════════════════════╝

  See: OFFER_OPENING_STYLE_GUIDE.txt for detailed style rules.

  INTENT based on recommendation:

    BLOCKED:
      intent = "blocked_info"
      Purpose: Informational text in case broker decides to offer anyway
      (e.g., if laycan extends, if market changes).
      Tone: cautious, factual. Mention the block reason.
      Still generate email_text and messenger_text.
      Example: "We have below cargo which may interest you for mv Petrel S 
               post her current discharge — timing is tight for current 
               dates but pls keep in mind for any extensions."

    STRONG (80%+):
      intent = "attract"
      Confident, lead with strengths.

    GOOD (65-80%):
      intent = "attract" or "inquire"
      Proactive, show cargo + mention minor concerns.

    CONDITIONAL (50-65%):
      intent = "inquire"
      Balanced, ask key questions.

    WEAK (35-50%):
      intent = "inform"
      Cautious, gather info.

    SKIP (<35%):
      intent = "inform"
      For reference only.

  GENERATION STEPS:
    1. Determine intent from recommendation
    2. Extract selling points from high-scoring criteria (offer_hints)
    3. Extract concerns from low-scoring criteria (offer_hints)
    4. Extract questions from missing data
    5. Generate email_text (2-4 sentences, shipping English)
    6. Generate messenger_text (1-2 sentences, max abbreviations)

  RULES:
    - NO greetings in offer_opening text
    - Always use shipping abbreviations (pls, yr, mv, lmk, cld)
    - Reference vessel by name
    - For BLOCKED: mention what makes it blocked + what could change

================================================================================
AI INSTRUCTIONS
================================================================================

  ai_must:
    - Evaluate ALL criteria, even when BLOCK is found early
    - Include ALL criteria in output (even excluded 0/0)
    - Calculate dynamic_max_score correctly
    - Express total_score as PERCENTAGE (0-100)
    - ALWAYS generate offer_opening (including for BLOCKED)
    - Perform P9 relationship check
    - Route draft → P5, age/DWT/class → P8
    
  ai_must:
    - Check position_received date — if older than 7 days, set P7 
      confidence = "low" and note "AIS data is [X] days old" in reasoning
    - If field "draft" = 0, null, or missing → draught analysis impossible,
      default to LADEN, confidence = "low"
    - If classification-society = null → report "No class society on record"
      (different from "Non-IACS class")
    - If pi_information = null → report "No P&I on record"

  ai_must_not:
    - ❌ Never use "max-draught" for draught ratio (use "draft")
    - ❌ Never skip offer_opening for BLOCKED vessels
    - ❌ Never use intent "do_not_offer" — use "blocked_info" for BLOCKED
    - ❌ Never report total_score as raw points
    - ❌ Never omit excluded criteria from output
    - ❌ Never put draft in P8
    - ❌ Never let P9 affect numerical score
    - ❌ Never BLOCK vessel for age alone
    - ❌ Never write offer_opening in AI explanation style — always write
         as broker-to-owner message (shipping English, abbreviations)

================================================================================
