MASTER_SCORING_SYSTEM

SHORT SUMMARY

This is the SINGLE SOURCE OF TRUTH for the VK Charts vessel-cargo scoring system.
It defines all 7 scoring criteria (P1-P7), their weights, ranges, calculation sources, and how they combine into a final compatibility score (0-100 points).

The system evaluates:
• P1 (20pts): Geographic proximity (distance-based)
• P1A (15pts): Regional trade patterns (market logic)
• P2 (15pts): Regional preferences (manual owner settings)
• P2A (20pts): PSC port accessibility (vessel PSC status vs port strictness)
• P3 (15pts): Cargo type compatibility
• P4 (10pts): Last ports familiarity
• P5 (15pts): Intake capacity match
• P6 (modifier, -50 to +25): Current voyage preferences (OpenArea comments)
• P7 (10pts): Timing and readiness (ETA vs laycan)

BASE_SCORE = P1 + P1A + P2 + P2A + P3 + P4 + P5 + P7 (max 115)
MODIFIED_SCORE = BASE_SCORE + P6
FINAL_SCORE = CLAMP(MODIFIED_SCORE, 0, 100)

Blocking conditions: technical impossibility, insufficient capacity, geopolitical restrictions, or P6 ≤ -40.

**Quick Reference - Scoring Ranges:**
P1: [0, 20] | P1A: [0, 15] | P2: [0, 15] | P2A: [0, 20] | P3: [0, 15] | P4: [0, 10] | P5: [0, 15] | P6: [-50, +25] | P7: [0, 10]

# ═══════════════════════════════════════════════════════════════════
# SCORING CRITERIA STRUCTURE
# ═══════════════════════════════════════════════════════════════════

scoring_criteria:
  
  # ─────────────────────────────────────────────────────────────────
  P1_PROXIMITY:
    name: "Geographic Proximity"
    weight: 20  # out of 100
    range: [0, 20]
    
    description: |
      Measures geographic distance and economic viability of ballast leg
      from vessel's current position to loading port.
      
    calculation_source: "proximity_scoring_matrix.txt"
    
    dependencies:
      - file: "vessel_location_determination.txt"
        purpose: "Determine vessel's effective location"
      - file: "vessel_size_classification.txt"
        purpose: "Size-based distance penalties"
      - file: "port_restrictions_map.txt"
        purpose: "Port accessibility validation"
    
    key_factors:
      - "Distance in nautical miles"
      - "Vessel size (affects ballast economics)"
      - "Geographic barriers (straits, canals)"
      - "Geopolitical restrictions"
    
    scoring_logic: |
      1. Determine vessel location via vessel_location_determination
      2. Calculate proximity level (same port → far region)
      3. Apply size-based adjustments
      4. Scale to 0-20 range
    
    blocking_conditions:
      - "Ukraine-Russia sanctions block"
      - "Port physically inaccessible for vessel size"

  # ─────────────────────────────────────────────────────────────────
  P1A_REGIONAL_PATTERNS:
    name: "Regional Trade Patterns"
    weight: 15
    range: [0, 15]
    
    description: |
      Evaluates market logic of vessel positioning from current region
      to loading region based on typical trade flows.
      
    calculation_source: "regional_trade_patterns.txt"
    
    dependencies:
      - file: "cargo_export_map.txt"
        purpose: "Typical cargo flows and vessel sizes"
      - file: "vessel_size_classification.txt"
        purpose: "Size economics and behavior"
      - file: "learning_session_1.txt"
        purpose: "Expert corrections and overrides"
    
    key_factors:
      - "Region pairs (from → to patterns)"
      - "Vessel size economics"
      - "Seasonal patterns"
      - "Backhaul probability"
    
    scoring_logic: |
      1. Find region_pair pattern for vessel_location → loading_region
      2. Apply vessel size bucket rules
      3. Apply seasonal adjustments
      4. Scale to 0-15 range
      
    important_note: |
      Uses CURRENT vessel position region, NOT last discharge region

  # ─────────────────────────────────────────────────────────────────
  P2_REGIONAL_PREFERENCES:
    name: "Owner's Regional Preferences"
    weight: 15
    range: [0, 15]
    
    description: |
      Manual preferences for countries/regions from company/vessel settings
      and comments history.
      
    calculation_source: "COMMENTS_PROCESSING_GUIDE.txt"
    
    data_sources:
      - "Company settings (specializes/prefers/avoids)"
      - "Vessel snapshot settings"
      - "Historical comments patterns"
    
    preference_levels:
      specializes: "+15 points"
      prefers: "+10 points"
      can_work: "+5 points"
      neutral: "0 points"
      avoids: "-10 points"
      cannot_work: "-15 points"
    
    priority_hierarchy:
      1: "Vessel-specific settings"
      2: "Person preferences"
      3: "Company-wide settings"
      4: "Formal UI settings"
  # ─────────────────────────────────────────────────────────────────
  P2A_PSC_PORT_ACCESSIBILITY:
    name: "PSC Port Accessibility"
    weight: 20
    range: [0, 20]
    
    description: |
      Evaluates whether a vessel can enter a port based on Port State
      Control (PSC) status and port's PSC enforcement severity.
      Reflects real shipowner behavior: vessels with poor PSC records
      AVOID strict ports (detention risk) and PREFER lax ports.
    
    calculation_source: "P2A_PSC_PORT_ACCESSIBILITY_SCORING.txt"
    
    data_sources:
      equasis:
        - "Paris MOU status (White/Grey/Black)"
        - "Detention rate (%)"
        - "IMO number (for sanctions check)"
      external:
        - "EU sanctions list (Danish Maritime Authority)"
        - "Paris/Tokyo/USCG MOU banning lists"
    
    key_factors:
      vessel_psc_status:
        - "GOOD: Paris White or (Grey + <3% detention)"
        - "MEDIUM: Paris Grey + 3-8% detention"
        - "POOR: Paris Black or >8% detention"
        - "BANNED: Currently banned from MOU region"
      
      port_psc_severity:
        - "VERY_STRICT: Italy, France, Greece, Germany, Netherlands, Belgium, UK, USA, Japan, Singapore"
        - "MODERATE: Turkey, Egypt, Romania, Bulgaria, Cyprus, Malta"
        - "LAX: Libya, Syria, Lebanon (weak enforcement)"
    
    scoring_logic: |
      Matrix-based scoring: Vessel_Status × Port_Severity
      
      GOOD vessel:
        - Any port: 18-20 points
      
      MEDIUM vessel:
        - Very strict port: 8-12 points
        - Moderate port: 12-15 points
        - Lax port: 15-18 points
      
      POOR vessel:
        - Very strict port: 0-5 points (CRITICAL - owner will AVOID)
        - Moderate port: 8-12 points
        - Lax port: 15-18 points (owner PREFERS lax PSC)
      
      Soft modifiers (±3 points max):
        - IACS class: +1-2 points
        - International Group P&I: +1 point
        - Age >20 years: -1 to -3 points
    
    blocking_conditions:
      hard_blocks:
        - "EU sanctions: Vessel IMO on EU sanctions list → P2A = 0 for ALL EU ports"
        - "MOU banning: Vessel banned from Paris/Tokyo/USCG MOU → P2A = 0 for that region"
      
      critical_scores:
        - "P2A ≤ 5 for Poor vessel at Very strict port → Strong signal to avoid"
    
    behavioral_logic:
      key_principle: |
        Poor PSC vessel + Lax PSC port = HIGH score (15-18)
        This is CORRECT behavior - reflects real shipowner strategy
        Vessels with PSC problems actively SEEK ports with weak enforcement
      
      critical_rules:
        - "⚠️ NEVER block on class/P&I alone (Equasis can be outdated)"
        - "⚠️ NO age restrictions for dry cargo (unlike tankers)"
        - "⚠️ EU sanctions = absolute legal block (not negotiable)"
    
    dependencies:
      - file: "P2A_PSC_PORT_ACCESSIBILITY_SCORING.txt"
        purpose: "Complete PSC scoring logic and country classifications"
    
    reasoning_template: |
      "{vessel_name} PSC status: {paris_mou}, {detention_rate}% detention rate
      {port_name}, {country}: {severity} PSC enforcement ({mou_region})
      {vessel_status} vessel + {port_severity} port → Base: {base_score}
      Modifiers: {modifiers}
      P2A = {final_score}/20 - {interpretation}"
    
    confidence_indicators:
      high: "Complete Equasis PSC data available"
      medium: "MOU status present, missing class/P&I"
      low: "Only flag data, no MOU information (assume MEDIUM status)"
  # ─────────────────────────────────────────────────────────────────
  P3_CARGO_PREFERENCES:
    name: "Cargo Type Compatibility"
    weight: 15
    range: [0, 15]
    
    description: |
      Compatibility with cargo type, technical requirements, and
      vessel capabilities.
      
    calculation_sources:
      - "COMMENTS_PROCESSING_GUIDE.txt"
      - "cargo_export_map.txt"
    
    key_factors:
      - "Cargo type match (grain/steel/fertilizers)"
      - "Technical requirements (gear/grabs/IMO)"
      - "Stowage factor compatibility"
      - "Historical cargo patterns"
    
    preference_levels:
      specializes_in_cargo: "+15 points"
      regularly_carries: "+10 points"
      can_carry: "+5 points"
      neutral: "0 points"
      avoids_cargo: "-10 points"
      cannot_carry_technically: "BLOCK"

  # ─────────────────────────────────────────────────────────────────
  P4_LAST_PORTS:
    name: "Last Ports of Call Familiarity"
    weight: 10
    range: [0, 10]
    
    description: |
      Vessel's historical familiarity with loading/discharge regions
      based on port call statistics.
      
    data_sources:
      - "Vessel's port call history (%)"
      - "Company fleet patterns (if vessel new)"
    
    scoring_logic: |
      >30% calls in region: +10 points
      20-30% calls: +7 points
      10-20% calls: +5 points
      5-10% calls: +3 points
      <5% calls: +1 point
      Never been: 0 points

  # ─────────────────────────────────────────────────────────────────
  P5_INTAKE_CAPACITY:
    name: "Cargo Intake Match"
    weight: 15
    range: [0, 15]
    
    description: |
      Vessel's ability to load required cargo quantity considering
      port restrictions and technical limitations.
      
    calculation_source: "intake_calculator_formula.txt"
    
    scoring_logic: |
      Ratio = vessel_intake / cargo_quantity
      
      ≥110%: 15 points (comfortable margin)
      100-110%: 12 points (exact fit)
      95-100%: 8 points (tight fit)
      90-95%: 3 points (requires negotiation)
      <90%: BLOCK (cannot carry)
    
    override_priority:
      1: "Manual intake from vessel comments"
      2: "Calculated intake"
      3: "DWT-based estimation"

  # ─────────────────────────────────────────────────────────────────
  P6_OPEN_AREA_COMMENTS:
    name: "Current Voyage Preferences"
    type: "MODIFIER"
    range: [-50, +25]
    
    description: |
      Owner's specific requirements for CURRENT voyage from OpenArea
      comments. Acts as modifier on top of base score.
      
    calculation_source: "OPEN_AREA_COMMENTS_SCORING.txt"
    
    key_signals:
      cargo_related:
        - "no grains / only grains"
        - "no steel / prefer steel"
        - "high SF only / no low SF"
      geography_related:
        - "no Black Sea / only Black Sea"
        - "nearby only / no long ballast"
        - "seeking backhaul to X"
      strategy_related:
        - "short trip only"
        - "repositioning to X"
        - "waiting for rates"
    
    impact_levels:
      full_conflict: "-40 to -50 → BLOCK OFFER"
      partial_conflict: "-15 to -25"
      neutral: "0"
      partial_match: "+10 to +15"
      perfect_match: "+20 to +25"
    
    blocking_rule: |
      If P6 score ≤ -40: Do not send offer, regardless of other scores

  # ─────────────────────────────────────────────────────────────────
  P7_READINESS_ETA:
    name: "Timing and Readiness"
    weight: 10
    range: [0, 10]
    
    description: |
      Vessel's ability to meet laycan dates considering current position
      and operational factors.
      
    calculation_source: "READINESSETA_TO_LOADING_PORT_SCORING.txt"
    
    key_factors:
      - "Current position and status (laden/ballast)"
      - "Distance to loading port"
      - "ETA calculation vs laycan window"
      - "Discharge time if laden"
    
    scoring_categories:
      perfect_fit: "9-10 points (within laycan)"
      slightly_early: "7-8 points (1-3 days wait)"
      slightly_late: "4-6 points (needs extension)"
      too_early_or_late: "1-3 points"
      unknown_eta: "0 points"
    
    important_note: |
      P7 focuses on CALENDAR FIT, not distance economics (that's P1)

# ═══════════════════════════════════════════════════════════════════
# SCORING CALCULATION FORMULA
# ═══════════════════════════════════════════════════════════════════

scoring_formula:
  
  base_score_calculation: |
    BASE_SCORE = P1 + P1A + P2 + P3 + P4 + P5 + P7
    (Maximum: 100 points)
  
  modifier_application: |
    MODIFIED_SCORE = BASE_SCORE + P6
    (P6 can push score above 100 or below 0)
  
  final_score: |
    FINAL_SCORE = CLAMP(MODIFIED_SCORE, 0, 100)
    (Bounded between 0 and 100)
  
  blocking_conditions:
    - condition: "P3 = CANNOT_CARRY_TECHNICALLY"
      action: "BLOCK → No score, no offer"
      
    - condition: "P5_ratio < 0.90"
      action: "BLOCK → Insufficient capacity"
      
    - condition: "P6 ≤ -40"
      action: "BLOCK → Owner explicitly avoids"
      
    - condition: "Geopolitical restriction"
      action: "BLOCK → Sanctions/war"

# ═══════════════════════════════════════════════════════════════════
# SCORING THRESHOLDS
# ═══════════════════════════════════════════════════════════════════

thresholds:
  
  classification:
    excellent_match:
      range: [85, 100]
      action: "High priority, immediate offer"
      email_template: "CASE A - Strong Match"
      
    good_match:
      range: [70, 85]
      action: "Standard offer"
      email_template: "CASE A - Standard"
      
    acceptable_match:
      range: [60, 70]
      action: "Offer with caveats"
      email_template: "CASE B - Not Ideal"
      
    marginal_match:
      range: [50, 60]
      action: "Low priority or positioning"
      email_template: "CASE B - Positioning"
      
    poor_match:
      range: [30, 50]
      action: "Only if requested"
      email_template: "CASE B - Unlikely"
      
    do_not_offer:
      range: [0, 30]
      action: "Skip unless manual override"
      email_template: "Do not send"
  
  automatic_actions:
    score_below_30: "Do not include in offer list"
    blocked_vessel: "Mark with reason, exclude completely"
    excellent_match: "Flag for immediate attention"

# ═══════════════════════════════════════════════════════════════════
# DATA NORMALIZATION RULES
# ═══════════════════════════════════════════════════════════════════

normalization:
  
  vessel_sizes:
    canonical_ranges:
      SC: [0, 4000]       # Small Coasters
      C:  [4001, 17000]   # Coasters
      SH: [17001, 24000]  # Small Handy
      H:  [24001, 40000]  # Handy
      SS: [40001, 50000]  # Small Supramax
      SM: [50001, 65000]  # Supramax
      PM: [65001, 80000]  # Panamax
    
    rule: "ALL files must use these exact ranges"
  
  regions:
    canonical_names:
      - "Black Sea"
      - "Black Sea Danube"
      - "Mediterranean"
      - "East Mediterranean"
      - "West Mediterranean"
      - "Egypt Mediterranean"
      - "Libya"
      - "Turkey"
      - "Greece"
      - "Marmara Sea"
      - "Adriatic"
      - "Atlantic"
      - "North Europe"
      - "Red Sea"
      - "Arabian Sea"
      - "Far East"
    
    rule: "Use exact names for region_pairs matching"

# ═══════════════════════════════════════════════════════════════════
# REASONING GENERATION RULES
# ═══════════════════════════════════════════════════════════════════

reasoning_templates:
  
  structure: |
    1. Overall Score: {final_score}/100
    2. Strengths: {top_scoring_criteria}
    3. Weaknesses: {low_scoring_criteria}
    4. Key Factors: {decisive_factors}
    5. Recommendation: {action}
  
  criterion_explanations:
    P1: "Vessel is {distance}nm from loading port ({proximity_level})"
    P1A: "{match_level} with typical {region_pair} trade pattern"
    P2: "Owner {preference_level} this region"
    P3: "Vessel {compatibility} with {cargo_type}"
    P4: "Vessel has {percentage}% history in this region"
    P5: "Can load {intake}t vs required {cargo_qty}t ({ratio}%)"
    P6: "Current voyage: {open_area_signal}"
    P7: "ETA {eta_date} vs laycan {laycan} ({timing_category})"
  
  blocking_explanations:
    technical: "Vessel cannot technically carry this cargo"
    capacity: "Insufficient intake capacity ({ratio}% of required)"
    owner_preference: "Owner explicitly avoids {restriction}"
    geopolitical: "Blocked due to {restriction_reason}"
