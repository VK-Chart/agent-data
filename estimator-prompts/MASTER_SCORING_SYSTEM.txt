================================================================================
MASTER SCORING SYSTEM
Version: 6.1
Last updated: 2026-02-20
================================================================================

PURPOSE:
  Central scoring framework for vessel-cargo matching. Defines all criteria,
  dynamic score calculation, priority order, P9 relationship check, and 
  offer opening generation logic.

================================================================================
VESSEL JSON FIELD MAPPING
================================================================================

  AI must use the correct fields from vessel JSON:

  VESSEL SPECS:
    DWT            → field "dwt"
    Max summer draft → field "draft" (NOT "max-draught")
    LOA            → field "length-overall"
    Beam           → field "beam"
    Year built     → field "year-of-build"
    Grain capacity → field "grain-capacity" (cubic feet)
    Class          → field "classification-society"
    Flag           → field "flag"
    Flag MOU status → field "flag-performance" (e.g., "Paris MOU: Grey")
    P&I            → field "pi_information"
    Holds          → field "holds"
    Hatches        → field "hatches"
    Gear           → field "gear-details"

  AIS / POSITION DATA:
    Current draught → field "current-draught" (from AIS, meters)
    Destination    → field "destination"
    ETA            → field "eta" (ISO datetime)
    Speed          → field "speed"
    Nav status     → field "navigation-status"
    Position time  → field "position-received" (when AIS data was received)
    Current area   → field "vessel_current_area"
    Average speed  → field "average-speed"
    AIS vessel name → field "ais-vessel-name" (compare with DB name!)

  DRAUGHT ANALYSIS FIELDS:
    For draught ratio, use: current-draught / draft
    ❌ Do NOT use "max-draught" (this is max recorded, may include tropical)
    ❌ Do NOT use "min-draught" (this is ballast reference)
    ✅ Use "draft" = summer loadline draft from vessel specs

  COMMENTS / PREFERENCES:
    Vessel comments     → field "comments" (array)
    Company comments    → field "companies[].comments" (array per company)
    Person comments     → field "people[].comments" (array per person)
    OpenArea           → field "open_area" (string or null)

  PORT HISTORY:
    Vessel top ports    → field "top_ports.vessel" (array)
    Company top ports   → field "top_ports.company.items" (array)
    Both sources should be used for P4 scoring.

================================================================================
ALL CRITERIA — OVERVIEW
================================================================================

  Code  Name                    Max    Type       Reference File
  ────  ────────────────────    ───    ────       ──────────────
  P1    Proximity               20     Always     proximity_scoring_matrix.txt
  P1A   Regional Patterns       15     Always     P1A_REGIONAL_SCORING_RULES.txt
  P2    Owner Preferences       15     Dynamic    COMMENTS_PROCESSING_GUIDE.txt
  P2A   PSC Port Accessibility  20     Always     P2A_PSC_PORT_ACCESSIBILITY_SCORING.txt
  P3    Cargo Preferences       15     Dynamic    COMMENTS_PROCESSING_GUIDE.txt
  P4    Last Ports              10     Always     P4_LAST_PORTS_SCORING.txt
  P5    Intake / Cargo Fit      15     Always     intake_calculator_formula.txt
  P6    OpenArea Comments       15     Dynamic    OPEN_AREA_COMMENTS_SCORING.txt
  P7    Readiness / ETA         10     Always     READINESSETA_TO_LOADING_PORT_SCORING.txt
  P8    Restrictions            20     Dynamic    P8_RESTRICTIONS_COMPLIANCE_SCORING.txt
  P9    Relationship Check      —      Warning    (this file, section below)

================================================================================
CRITICAL RULES — READ FIRST
================================================================================

  ╔═══════════════════════════════════════════════════════════════════════════╗
  ║  IACS members: ABS, BV, CCS, CRS, DNV, IRClass (IRS), LR, KR, ClassNK,    ║
  ║               PRS, RINA, Türk Loydu (TL)                                  ║
  ║  NOT IACS: (examples) non-IACS class societies;                            ║
  ║           NOTE: RS/RMRS (Russian Maritime Register) was withdrawn in 2022 ║
  ╚═══════════════════════════════════════════════════════════════════════════╝

  - total_score is ALWAYS a PERCENTAGE (0-100)
  - Field "draft" = summer loadline. NEVER use "max-draught"
  - Draft restrictions → P5. NEVER in P8
  - Age NEVER triggers BLOCK in P8. NEVER.
  - classification-society = null → "No class on record" (not "Non-IACS")
  - pi_information = null → "No P&I on record" (not "Non-IG")
  - AIS name ≠ DB name → first question = "did you sell yr lady?"

================================================================================
DYNAMIC MAX_SCORE CALCULATION
================================================================================

  ALWAYS ACTIVE (max_score is always set):
    P1  = 20
    P1A = 15
    P2A = 20
    P4  = 10
    P5  = 15
    P7  = 10
    ────────
    Base always-active MAX = 90

  DYNAMIC (max_score = 0 if no data, otherwise max):
    P2  = 15 or 0 (no owner preference data → excluded)
    P3  = 15 or 0 (no cargo preference data → excluded)
    P6  = 15 or 0 (no OpenArea comments → excluded)
    P8  = 20 or 0 (no restrictions set → excluded)

  FORMULA:
    dynamic_max_score = SUM of max_score for ALL criteria where max_score > 0
    
    Minimum: 90 (only always-active criteria)
    Maximum: 90 + 15 + 15 + 15 + 20 = 155 (all criteria active)

  ╔══════════════════════════════════════════════════════════════════╗
  ║  FINAL SCORE — ALWAYS EXPRESSED AS PERCENTAGE:                  ║
  ║                                                                 ║
  ║  total_score = ROUND((total_score_raw / dynamic_max_score)×100) ║
  ║                                                                 ║
  ║  total_score is a number from 0 to 100 (percentage).            ║
  ║  NEVER report total_score as raw points.                        ║
  ╚══════════════════════════════════════════════════════════════════╝

================================================================================
EVALUATION PRIORITY ORDER
================================================================================

  1. P8  — Restrictions Compliance (BLOCK potential — but NOT for age)
  2. P5  — Intake / Cargo Fit (BLOCK potential — includes draft restrictions)
  3. P2A — PSC Port Accessibility (BLOCK potential)
  4. P2  — Owner Preferences (BLOCK potential for "no X")
  5. P3  — Cargo Preferences
  6. P6  — OpenArea Comments
  7. P4  — Last Ports
  8. P1A — Regional Patterns
  9. P1  — Proximity (BLOCK for non-viable distances)
  10. P7  — Readiness / ETA (BLOCK for missed laycan)
  11. P9  — Relationship Check (warning only, no score)

  IMPORTANT: Even when a BLOCK is found early, score ALL remaining criteria.

================================================================================
CRITICAL — RESTRICTION SCOPE RULES
================================================================================

  P5 handles: Draft/draught restrictions, cargo quantity fit, cubature
  P8 handles: ONLY Class, P&I, IMO, Holds Type, DWT, Age, LOA, Beam
  P2A handles: PSC risk based on flag, class, P&I, port strictness
  P2 handles: Owner's regional preferences from comments
  P3 handles: Cargo type preferences from comments (NOT geographic specs)

  Draft restrictions → P5. NEVER in P8.
  "spec: [country]" → P2 (location preference). NEVER P3.

================================================================================
KEY SCORING RULES SUMMARY (cross-file)
================================================================================

  P2A — THREE ELEMENTS STATUS:
    Element 1: IACS class | Element 2: IG P&I | Element 3: White flag
    HIGH = 3 of 3 | MEDIUM = 2 of 3 | LOW = 1 or 0 of 3
    PRS is NOT IACS. If "POLISH" in class → NOT IACS element.

  P2 — ADJACENT REGIONS:
    "spec: italy" → adjacent countries (Greece, Croatia, etc.) score 8-10/15
    See COMMENTS_PROCESSING_GUIDE for adjacency map.

  P5 — FIXED vs FLEXIBLE QTY:
    FIXED (m/m): BLOCK threshold at 85% of min_qty
    FLEXIBLE (no m/m): BLOCK threshold at 75% of min_qty
    Grain capacity = 0 + high SF cargo → P5 capped at 10/15

  P7 — EARLY ARRIVAL (granular):
    -1 to -3d: 10/10 | -4 to -7d: 9/10 | -8 to -10d: 7/10
    -11 to -14d: 4/10 | -15 to -20d: 2/10 | < -20d: 1/10
    Draught anomaly check FIRST (current > summer draft)

================================================================================
BLOCK LOGIC
================================================================================

  Any criterion can produce a BLOCK. A single BLOCK = vessel is not viable.
  
  When BLOCK is triggered:
    - recommendation = "BLOCKED"
    - Still score ALL other criteria
    - Mark blocked criterion with "decision": "blocked", "critical": true
    - short_summary explains why vessel is blocked
    - Offer opening IS STILL generated (see below)

  Multiple BLOCKs: Report all. Summary mentions the most impactful.

================================================================================
RECOMMENDATION CATEGORIES
================================================================================

  BLOCKED — One or more criteria triggered BLOCK
  STRONG (80%+) — Excellent match
  GOOD (65-80%) — Solid match with minor issues
  CONDITIONAL (50-65%) — Decent match, has concerns
  WEAK (35-50%) — Poor match but may work
  SKIP (<35%) — Not worth offering

================================================================================
P9 — RELATIONSHIP CHECK (WARNING ONLY)
================================================================================

  P9 is NOT a scoring criterion. It generates a warning flag.

  DATA SOURCES:
    - companies[].comments
    - people[].comments
    - vessel comments[]
    
  WARNING TYPES:

    DIRECT_RELATIONSHIP
      Trigger: "works direct with [charterer]"
      Offer impact: "in case you haven't seen this yet"
               
    BROKER_RELATIONSHIP
      Trigger: "[charterer] cargoes via [broker]"
      Offer impact: Owner may redirect to their broker.
               
    NO_RELATIONSHIP (CLEAR)
      Warning: null

  OUTPUT:
    "relationship_warning": { "status": "CLEAR" }
    or
    "relationship_warning": {
      "status": "WARNING",
      "type": "direct_relationship",
      "details": "...",
      "offer_guidance": "..."
    }

  OFFER_GUIDANCE (always output):
    Extract from person_comments any communication instructions:
    - Greeting style, nicknames, timezone, channel preference, etc.
    If no special instructions → "No special instructions"

================================================================================
OFFER OPENING GENERATION — ALWAYS REQUIRED
================================================================================

  ╔══════════════════════════════════════════════════════════════════╗
  ║  Offer opening is ALWAYS generated, including for BLOCKED       ║
  ║  vessels. For BLOCKED vessels, use intent "blocked_info".       ║
  ║  Always use first person "I" — NEVER "we/us/our".             ║
  ╚══════════════════════════════════════════════════════════════════╝

  See: OFFER_OPENING_STYLE_GUIDE.txt for detailed style rules.

  INTENT based on recommendation:

    BLOCKED:         intent = "blocked_info"
    STRONG (80%+):   intent = "attract"
    GOOD (65-80%):   intent = "attract" or "inquire"
    CONDITIONAL (50-65%): intent = "inquire"
    WEAK (35-50%):   intent = "inform"
    SKIP (<35%):     intent = "inform"

  PROXIMITY OVERRIDE (mandatory check):
    P1 + P1A ≥ 25/35 → no cap
    P1 + P1A 15-24/35 → max "inquire"
    P1 + P1A < 15/35 → strictly "inform"
    P1 = BLOCK → "blocked_info"

  VERY EARLY VESSEL (-14d+ before layday):
    Maximum intent: "inquire" (usually "inform")
    NEVER "attract" for -14d+ early.

  GENERATION STEPS:
    1. Determine intent from recommendation
    2. Apply proximity override and early-vessel cap
    3. Check AIS name vs DB name — mismatch → first question
    4. Extract selling points from high-scoring criteria
    5. Extract concerns from low-scoring criteria
    6. Generate email_text (2-4 sentences, shipping English, "I" not "we")
    7. Generate messenger_text (1-2 sentences, max abbreviations)

  RULES:
    - NO greetings in offer_opening text
    - Always use shipping abbreviations
    - Reference vessel by name
    - First person "I" — never "we/us/our"
    - Never expose CRM data, vessel limitations, or scoring concepts
    - For BLOCKED: mention what makes it blocked + what could change

================================================================================
AI INSTRUCTIONS
================================================================================

  ai_must:
    - Evaluate ALL criteria, even when BLOCK is found early
    - Include ALL criteria in output (even excluded 0/0)
    - Calculate dynamic_max_score correctly
    - Express total_score as PERCENTAGE (0-100)
    - ALWAYS generate offer_opening (including for BLOCKED)
    - Perform P9 relationship check
    - Route draft → P5, age/DWT/class → P8
    - Check PRS — it is NOT IACS
    - Use THREE ELEMENTS test for P2A status
    - Apply proximity override to offer intent
    - Check AIS name vs DB name for mismatch
    - Check P7 draught anomaly (current > summer draft)
    - Parse cargo qty as FIXED (m/m) or FLEXIBLE
    - Cap P5 at 10/15 when grain-capacity = 0 for high SF cargo
    
  ai_must_not:
    - ❌ Never use "max-draught" for draught ratio (use "draft")
    - ❌ Never skip offer_opening for BLOCKED vessels
    - ❌ Never use intent "do_not_offer" — use "blocked_info" for BLOCKED
    - ❌ Never report total_score as raw points
    - ❌ Never omit excluded criteria from output
    - ❌ Never put draft in P8
    - ❌ Never let P9 affect numerical score
    - ❌ Never BLOCK vessel for age alone
    - ❌ Never write offer_opening in AI explanation style
    - ❌ Never use "we/us/our" in offer_opening — use "I"
    - ❌ Never classify PRS as IACS
    - ❌ Never expose CRM data or vessel limitations in offer text
    - ❌ Never use intent "attract" for -14d+ early vessels
    - ❌ Never activate P3 based on geographic specializations

================================================================================
