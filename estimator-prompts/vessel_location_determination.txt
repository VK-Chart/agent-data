# ═══════════════════════════════════════════════════════════════════
# VESSEL LOCATION DETERMINATION - UPDATED v2.0
# VK Charts AI Scoring System
# ═══════════════════════════════════════════════════════════════════
#
# CHANGES IN v2.0:
# - Added Istanbul/Canakkale as TRANSIT CHANNELS (not actual ports)
# - Added Tuzla as DRY DOCK location (+30 days for repairs)
# - Clarified priority logic for determining opening position
# - Added special handling rules for edge cases
#
# ═══════════════════════════════════════════════════════════════════

version: "2.0"
date: "2026-01-19"
priority: "CRITICAL - Location determines P1, P1A, P7 scoring"

# ═══════════════════════════════════════════════════════════════════
# OVERVIEW
# ═══════════════════════════════════════════════════════════════════

purpose: |
  Determine vessel's effective opening position for scoring purposes.
  
  This affects:
  - P1 (Proximity): Distance to loading port
  - P1A (Regional Patterns): Trade pattern viability
  - P7 (Readiness): When vessel will be ready
  
  KEY PRINCIPLE:
  Use most specific/reliable data available, following priority order.

# ═══════════════════════════════════════════════════════════════════
# DATA PRIORITY ORDER
# ═══════════════════════════════════════════════════════════════════

priority_order:
  
  priority_1_open_area:
    source: "OpenArea field (manually entered)"
    reliability: "HIGHEST - owner's stated position"
    format: "Port name + Date"
    example: "Constanta, Jan 20"
    
    usage: |
      If open_area is provided, this is DEFINITIVE.
      Use this location and date for all scoring.
      Ignore destination and current_area.
    
  priority_2_destination:
    source: "Destination field (from AIS)"
    reliability: "MEDIUM - vessel heading there, but purpose unclear"
    format: "Port name"
    additional: "ETA (Estimated Time of Arrival)"
    example: "Mersin, ETA Jan 25"
    
    usage: |
      If destination is set (and no open_area):
      - Vessel is likely going there to load OR discharge
      - Opening location = destination port
      - Opening date = ETA + 7 days (operations buffer)
      
      EXCEPTIONS:
      - Istanbul: Treat as TRANSIT, not destination
      - Canakkale: Treat as TRANSIT, not destination  
      - Tuzla: Treat as DRY DOCK (+30 days)
    
  priority_3_current_area:
    source: "Current Area field (from AIS)"
    reliability: "LOW - only shows current position"
    format: "Geographic region or port name"
    example: "East Mediterranean" or "Sulina"
    
    usage: |
      If no open_area or valid destination:
      - Use current_area as opening location
      - Use position_received as opening date
      - Assume vessel is at anchor/waiting
      
      EXCEPTIONS:
      - Istanbul: Treat as TRANSIT
      - Canakkale: Treat as TRANSIT
      - Tuzla: Treat as DRY DOCK

# ═══════════════════════════════════════════════════════════════════
# SPECIAL LOCATION HANDLING
# ═══════════════════════════════════════════════════════════════════

special_locations:
  
  # ─────────────────────────────────────────────────────────────────
  # ISTANBUL - TRANSIT CHANNEL (NOT A PORT)
  # ─────────────────────────────────────────────────────────────────
  
  istanbul_handling:
    
    principle: |
      Istanbul is a TRANSIT CHANNEL (Bosphorus Strait), not a destination port.
      When vessels pass through Istanbul, it appears in their position data,
      but this is NOT an actual port call - just transit between Black Sea
      and Marmara/Mediterranean.
    
    recognition:
      port_names:
        - "Istanbul"
        - "Bosphorus"
        - "Bosporus"
      
      context_clues:
        - "Appears in top_ports with high percentage"
        - "Vessel track shows brief passage"
        - "No long stays (just hours, not days)"
    
    ai_interpretation:
      
      if_in_destination:
        condition: "destination = Istanbul"
        action: "IGNORE - treat as null destination"
        reasoning: "Vessel transiting through straits, not calling Istanbul port"
        fallback: "Use current_area or treat as in-transit"
        
        example:
          vessel_destination: "Istanbul"
          vessel_current_area: "Black Sea"
          interpretation: "Vessel exiting Black Sea via Bosphorus, NOT opening in Istanbul"
          use_for_scoring: "Black Sea (current_area)"
      
      if_in_current_area:
        condition: "current_area = Istanbul"
        action: "Determine direction of transit"
        
        if_heading_to_black_sea:
          interpretation: "Vessel entering Black Sea"
          use_for_scoring: "Marmara Sea (origin) or Black Sea (destination)"
          
        if_heading_to_mediterranean:
          interpretation: "Vessel exiting Black Sea"
          use_for_scoring: "Black Sea (origin) or Marmara/Med (destination)"
      
      if_in_top_ports:
        condition: "Istanbul appears in vessel's top_ports history"
        action: "DO NOT count as actual port experience"
        reasoning: |
          High Istanbul percentage simply means vessel transits frequently
          between Black Sea and Med. It does NOT indicate familiarity with
          Istanbul as a loading/discharge port.
        
        citations:
          - "Correction (valmiera): Istanbul is transit channel, not port"
          - "Correction: Do not treat Istanbul as port call in P4 scoring"
  
  # ─────────────────────────────────────────────────────────────────
  # CANAKKALE - TRANSIT CHANNEL (NOT A PORT)
  # ─────────────────────────────────────────────────────────────────
  
  canakkale_handling:
    
    principle: |
      Canakkale is DARDANELLES STRAIT transit, similar to Istanbul.
      Same logic applies: transit channel, not destination port.
    
    recognition:
      port_names:
        - "Canakkale"
        - "Dardanelles"
        - "Çanakkale"
    
    ai_interpretation:
      same_as_istanbul: true
      
      if_in_destination:
        action: "IGNORE - treat as null destination"
        
      if_in_current_area:
        action: "Determine direction (Marmara ↔ Aegean)"
        
      if_in_top_ports:
        action: "DO NOT count as port experience"
  
  # ─────────────────────────────────────────────────────────────────
  # TUZLA - DRY DOCK / REPAIRS
  # ─────────────────────────────────────────────────────────────────
  
  tuzla_handling:
    
    principle: |
      Tuzla (Turkey) is a major SHIPYARD and DRY DOCK location.
      If vessel is in Tuzla or heading to Tuzla, assume repairs.
      Repair durations are UNCERTAIN, typically 1+ months.
    
    recognition:
      port_names:
        - "Tuzla"
        - "Tuzla Shipyard"
      
      location:
        country: "Turkey"
        region: "Marmara Sea"
        near: "Istanbul"
    
    ai_interpretation:
      
      if_currently_in_tuzla:
        condition: "current_area = Tuzla OR destination = Tuzla (already arrived)"
        
        impact_on_p7:
          assumption: "Vessel undergoing repairs"
          duration_estimate: "+30 days minimum"
          uncertainty: "HIGH - repair completion dates very uncertain"
          
          scoring:
            p7_score: 2
            confidence: 60
            reasoning: |
              "Vessel currently in Tuzla (dry dock). Repairs typically take
              1+ months with uncertain completion. Position highly unreliable
              for near-term cargo."
        
        impact_on_other_criteria:
          p1_proximity: "Calculate from Tuzla, but add uncertainty note"
          p1a_regional: "Normal assessment, but flag repair status"
        
        warning_to_user: |
          "⚠️ Vessel is currently in Tuzla shipyard. This typically indicates
          repairs/dry docking. Completion date uncertain."
      
      if_heading_to_tuzla:
        condition: "destination = Tuzla AND not yet arrived"
        
        impact_on_p7:
          vessel_ready_date: "ETA + 30 days (minimum)"
          
          scoring:
            p7_score: 3
            confidence: 65
            reasoning: |
              "Vessel heading to Tuzla (ETA {date}). Tuzla is a major shipyard,
              suggesting scheduled repairs. Assume +30 days for dry docking."
        
        warning_to_user: |
          "⚠️ Vessel is heading to Tuzla shipyard (ETA {date}). This likely
          indicates planned repairs. Opening date highly uncertain."
  
  # ─────────────────────────────────────────────────────────────────
  # SULINA ANCHORAGE - SPECIAL POSITIONING
  # ─────────────────────────────────────────────────────────────────
  
  sulina_handling:
    
    principle: |
      Sulina is a WAITING AREA / ANCHORAGE, not a commercial port.
      Vessels wait here before either:
      a) Entering Danube River, OR
      b) Proceeding to POC ports
      
      This is NOT an issue like Istanbul - Sulina IS a valid opening position.
    
    recognition:
      port_names:
        - "Sulina"
        - "Sulina Anchorage"
      
    ai_interpretation:
      treat_as: "Valid opening position"
      
      impact_on_p1:
        proximity_to_poc: "Level 3 (very close, ~80nm)"
        proximity_to_danube: "Level 3 (very close, river entrance)"
      
      impact_on_p1a:
        pattern_to_poc: "Score 14/15 (excellent positioning)"
        pattern_to_danube: "Score 14/15 (excellent positioning)"
        reasoning: "Sulina = neutral waiting area, equal viability for both directions"
        
        citations:
          - "Correction (eleanora): Sulina vessels can go to POC or Danube equally"

# ═══════════════════════════════════════════════════════════════════
# LOCATION DETERMINATION ALGORITHM
# ═══════════════════════════════════════════════════════════════════

determination_algorithm:
  
  step_1_check_open_area:
    if: "open_area field is not null"
    then:
      location: "Use open_area port"
      date: "Use open_area date"
      confidence: "HIGH"
      stop: true
  
  step_2_check_destination:
    if: "destination field is not null"
    then:
      
      check_special_cases:
        
        if_istanbul_or_canakkale:
          action: "SKIP destination, continue to step 3"
          reasoning: "Transit channel, not valid destination"
        
        if_tuzla:
          location: "Tuzla (dry dock)"
          date: "ETA + 30 days"
          confidence: "LOW (repair uncertainty)"
          add_warning: true
          stop: true
        
        if_normal_port:
          location: "Use destination port"
          date: "ETA + 7 days (operations)"
          confidence: "MEDIUM"
          stop: true
  
  step_3_check_current_area:
    if: "current_area is not null"
    then:
      
      check_special_cases:
        
        if_istanbul_or_canakkale:
          action: "Interpret as in-transit, use broader region"
          location: "Use adjacent sea (Black Sea or Marmara)"
          date: "position_received"
          confidence: "LOW"
          stop: true
        
        if_tuzla:
          location: "Tuzla (dry dock)"
          date: "position_received + 30 days"
          confidence: "LOW"
          add_warning: true
          stop: true
        
        if_normal_location:
          location: "Use current_area"
          date: "position_received"
          confidence: "LOW (no confirmed destination)"
          stop: true
  
  step_4_no_data:
    if: "All fields are null"
    then:
      action: "ERROR - insufficient data"
      recommendation: "Request owner clarification"

# ═══════════════════════════════════════════════════════════════════
# P4 (LAST PORTS) SPECIAL HANDLING
# ═══════════════════════════════════════════════════════════════════

p4_top_ports_filtering:
  
  principle: |
    When analyzing vessel's top_ports historical data, EXCLUDE
    transit channels from port experience calculation.
  
  exclude_from_p4:
    - "Istanbul"
    - "Canakkale"
    - "Bosphorus"
    - "Dardanelles"
  
  rationale: |
    These locations appear frequently in AIS data due to transit,
    but they do NOT represent actual port calling experience.
    
    Including them inflates P4 scores incorrectly.
  
  example:
    raw_top_ports:
      - "Istanbul: 25.7%"
      - "Sulina: 12.2%"
      - "Izmail: 8.5%"
      - "Constanta: 6.3%"
    
    filtered_top_ports:
      - "Sulina: 12.2%"
      - "Izmail: 8.5%"
      - "Constanta: 6.3%"
      - "(Istanbul removed as transit)"
    
    p4_calculation:
      use: "Filtered list only"
      reasoning: "Istanbul removed - transit channel, not port experience"
    
    citations:
      - "Correction (valmeira, eleanora): Istanbul is transit, not port call"

# ═══════════════════════════════════════════════════════════════════
# CRITICAL AI INSTRUCTIONS
# ═══════════════════════════════════════════════════════════════════

ai_must:
  - "ALWAYS follow priority order: open_area > destination > current_area"
  - "ALWAYS treat Istanbul/Canakkale as transit (not valid destinations)"
  - "ALWAYS treat Tuzla as dry dock (+30 days)"
  - "ALWAYS exclude Istanbul/Canakkale from P4 top_ports analysis"
  - "ALWAYS add +7 days to destination ETA for operations"
  - "ALWAYS add warning if vessel in/heading to Tuzla"

ai_must_not:
  - "Never use Istanbul/Canakkale as opening position"
  - "Never count Istanbul/Canakkale in P4 port experience"
  - "Never assume vessel ready at destination ETA without operations buffer"
  - "Never ignore Tuzla dry dock implications"

# ═══════════════════════════════════════════════════════════════════
# END OF VESSEL LOCATION DETERMINATION v2.0
# ═══════════════════════════════════════════════════════════════════
