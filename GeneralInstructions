MASTER_SCORING_SYSTEM

SHORT SUMMARY

This is the SINGLE SOURCE OF TRUTH for the VK Charts vessel-cargo scoring system.
It defines all 7 scoring criteria (P1-P7), their weights, ranges, calculation sources, and how they combine into a final compatibility score (0-100 points).

The system evaluates:
• P1 (20pts): Geographic proximity (distance-based)
• P1A (15pts): Regional trade patterns (market logic)
• P2 (15pts): Regional preferences (manual owner settings)
• P3 (15pts): Cargo type compatibility
• P4 (10pts): Last ports familiarity
• P5 (15pts): Intake capacity match
• P6 (modifier, -50 to +25): Current voyage preferences (OpenArea comments)
• P7 (10pts): Timing and readiness (ETA vs laycan)

BASE_SCORE = P1 + P1A + P2 + P3 + P4 + P5 + P7 (max 100)
MODIFIED_SCORE = BASE_SCORE + P6
FINAL_SCORE = CLAMP(MODIFIED_SCORE, 0, 100)

Blocking conditions: technical impossibility, insufficient capacity, geopolitical restrictions, or P6 ≤ -40.

**Quick Reference - Scoring Ranges:**
P1: [0, 20] | P1A: [0, 15] | P2: [0, 15] | P3: [0, 15] | P4: [0, 10] | P5: [0, 15] | P6: [-50, +25] | P7: [0, 10]

# ═══════════════════════════════════════════════════════════════════
# SCORING CRITERIA STRUCTURE
# ═══════════════════════════════════════════════════════════════════

scoring_criteria:
  
  # ─────────────────────────────────────────────────────────────────
  P1_PROXIMITY:
    name: "Geographic Proximity"
    weight: 20  # out of 100
    range: [0, 20]
    
    description: |
      Measures geographic distance and economic viability of ballast leg
      from vessel's current position to loading port.
      
    calculation_source: "https://github.com/VK-Chart/agent-data/blob/develop-1/proximity_scoring_matrix.txt"
    
    dependencies:
      - file: "https://github.com/VK-Chart/agent-data/blob/develop-1/vessel_location_determination.txt"
        purpose: "Determine vessel's effective location"
      - file: "https://github.com/VK-Chart/agent-data/blob/develop-1/vessel_size_classification.txt"
        purpose: "Size-based distance penalties"
      - file: "https://github.com/VK-Chart/agent-data/blob/develop-1/port_restrictions_map.txt"
        purpose: "Port accessibility validation"
    
    key_factors:
      - "Distance in nautical miles"
      - "Vessel size (affects ballast economics)"
      - "Geographic barriers (straits, canals)"
      - "Geopolitical restrictions"
    
    scoring_logic: |
      1. Determine vessel location via vessel_location_determination
      2. Calculate proximity level (same port → far region)
      3. Apply size-based adjustments
      4. Scale to 0-20 range
    
    blocking_conditions:
      - "Ukraine-Russia sanctions block"
      - "Port physically inaccessible for vessel size"

  # ─────────────────────────────────────────────────────────────────
  P1A_REGIONAL_PATTERNS:
    name: "Regional Trade Patterns"
    weight: 15
    range: [0, 15]
    
    description: |
      Evaluates market logic of vessel positioning from current region
      to loading region based on typical trade flows.
      
    calculation_source: "regional_trade_patterns.txt"
    
    dependencies:
      - file: "cargo_export_map.txt"
        purpose: "Typical cargo flows and vessel sizes"
      - file: "https://github.com/VK-Chart/agent-data/blob/develop-1/vessel_size_classification.txt"
        purpose: "Size economics and behavior"
      - file: "learning_session_1.txt"
        purpose: "Expert corrections and overrides"
    
    key_factors:
      - "Region pairs (from → to patterns)"
      - "Vessel size economics"
      - "Seasonal patterns"
      - "Backhaul probability"
    
    scoring_logic: |
      1. Find region_pair pattern for vessel_location → loading_region
      2. Apply vessel size bucket rules
      3. Apply seasonal adjustments
      4. Scale to 0-15 range
      
    important_note: |
      Uses CURRENT vessel position region, NOT last discharge region

  # ─────────────────────────────────────────────────────────────────
  P2_REGIONAL_PREFERENCES:
    name: "Owner's Regional Preferences"
    weight: 15
    range: [0, 15]
    
    description: |
      Manual preferences for countries/regions from company/vessel settings
      and comments history.
      
    calculation_source: "COMMENTS_PROCESSING_GUIDE.txt"
    
    data_sources:
      - "Company settings (specializes/prefers/avoids)"
      - "Vessel snapshot settings"
      - "Historical comments patterns"
    
    preference_levels:
      specializes: "+15 points"
      prefers: "+10 points"
      can_work: "+5 points"
      neutral: "0 points"
      avoids: "-10 points"
      cannot_work: "-15 points"
    
    priority_hierarchy:
      1: "Vessel-specific settings"
      2: "Person preferences"
      3: "Company-wide settings"
      4: "Formal UI settings"

  # ─────────────────────────────────────────────────────────────────
  P3_CARGO_PREFERENCES:
    name: "Cargo Type Compatibility"
    weight: 15
    range: [0, 15]
    
    description: |
      Compatibility with cargo type, technical requirements, and
      vessel capabilities.
      
    calculation_sources:
      - "https://github.com/VK-Chart/agent-data/blob/develop-1/COMMENTS_PROCESSING_GUIDE.txt"
      - "cargo_export_map.txt"
    
    key_factors:
      - "Cargo type match (grain/steel/fertilizers)"
      - "Technical requirements (gear/grabs/IMO)"
      - "Stowage factor compatibility"
      - "Historical cargo patterns"
    
    preference_levels:
      specializes_in_cargo: "+15 points"
      regularly_carries: "+10 points"
      can_carry: "+5 points"
      neutral: "0 points"
      avoids_cargo: "-10 points"
      cannot_carry_technically: "BLOCK"

  # ─────────────────────────────────────────────────────────────────
  P4_LAST_PORTS:
    name: "Last Ports of Call Familiarity"
    weight: 10
    range: [0, 10]
    
    description: |
      Vessel's historical familiarity with loading/discharge regions
      based on port call statistics.
      
    data_sources:
      - "Vessel's port call history (%)"
      - "Company fleet patterns (if vessel new)"
    
    scoring_logic: |
      >30% calls in region: +10 points
      20-30% calls: +7 points
      10-20% calls: +5 points
      5-10% calls: +3 points
      <5% calls: +1 point
      Never been: 0 points

  # ─────────────────────────────────────────────────────────────────
  P5_INTAKE_CAPACITY:
    name: "Cargo Intake Match"
    weight: 15
    range: [0, 15]
    
    description: |
      Vessel's ability to load required cargo quantity considering
      port restrictions and technical limitations.
      
    calculation_source: "https://github.com/VK-Chart/agent-data/blob/develop-1/intake_calculator_formula.txt"
    
    scoring_logic: |
      Ratio = vessel_intake / cargo_quantity
      
      ≥110%: 15 points (comfortable margin)
      100-110%: 12 points (exact fit)
      95-100%: 8 points (tight fit)
      90-95%: 3 points (requires negotiation)
      <90%: BLOCK (cannot carry)
    
    override_priority:
      1: "Manual intake from vessel comments"
      2: "Calculated intake"
      3: "DWT-based estimation"

  # ─────────────────────────────────────────────────────────────────
  P6_OPEN_AREA_COMMENTS:
    name: "Current Voyage Preferences"
    type: "MODIFIER"
    range: [-50, +25]
    
    description: |
      Owner's specific requirements for CURRENT voyage from OpenArea
      comments. Acts as modifier on top of base score.
      
    calculation_source: "https://github.com/VK-Chart/agent-data/blob/develop-1/OPEN_AREA_COMMENTS_SCORING.txt"
    
    key_signals:
      cargo_related:
        - "no grains / only grains"
        - "no steel / prefer steel"
        - "high SF only / no low SF"
      geography_related:
        - "no Black Sea / only Black Sea"
        - "nearby only / no long ballast"
        - "seeking backhaul to X"
      strategy_related:
        - "short trip only"
        - "repositioning to X"
        - "waiting for rates"
    
    impact_levels:
      full_conflict: "-40 to -50 → BLOCK OFFER"
      partial_conflict: "-15 to -25"
      neutral: "0"
      partial_match: "+10 to +15"
      perfect_match: "+20 to +25"
    
    blocking_rule: |
      If P6 score ≤ -40: Do not send offer, regardless of other scores

  # ─────────────────────────────────────────────────────────────────
  P7_READINESS_ETA:
    name: "Timing and Readiness"
    weight: 10
    range: [0, 10]
    
    description: |
      Vessel's ability to meet laycan dates considering current position
      and operational factors.
      
    calculation_source: "https://github.com/VK-Chart/agent-data/blob/develop-1/READINESSETA_TO_LOADING_PORT_SCORING.txt"
    
    key_factors:
      - "Current position and status (laden/ballast)"
      - "Distance to loading port"
      - "ETA calculation vs laycan window"
      - "Discharge time if laden"
    
    scoring_categories:
      perfect_fit: "9-10 points (within laycan)"
      slightly_early: "7-8 points (1-3 days wait)"
      slightly_late: "4-6 points (needs extension)"
      too_early_or_late: "1-3 points"
      unknown_eta: "0 points"
    
    important_note: |
      P7 focuses on CALENDAR FIT, not distance economics (that's P1)

# ═══════════════════════════════════════════════════════════════════
# SCORING CALCULATION FORMULA
# ═══════════════════════════════════════════════════════════════════

scoring_formula:
  
  base_score_calculation: |
    BASE_SCORE = P1 + P1A + P2 + P3 + P4 + P5 + P7
    (Maximum: 100 points)
  
  modifier_application: |
    MODIFIED_SCORE = BASE_SCORE + P6
    (P6 can push score above 100 or below 0)
  
  final_score: |
    FINAL_SCORE = CLAMP(MODIFIED_SCORE, 0, 100)
    (Bounded between 0 and 100)
  
  blocking_conditions:
    - condition: "P3 = CANNOT_CARRY_TECHNICALLY"
      action: "BLOCK → No score, no offer"
      
    - condition: "P5_ratio < 0.90"
      action: "BLOCK → Insufficient capacity"
      
    - condition: "P6 ≤ -40"
      action: "BLOCK → Owner explicitly avoids"
      
    - condition: "Geopolitical restriction"
      action: "BLOCK → Sanctions/war"

# ═══════════════════════════════════════════════════════════════════
# SCORING THRESHOLDS
# ═══════════════════════════════════════════════════════════════════

thresholds:
  
  classification:
    excellent_match:
      range: [85, 100]
      action: "High priority, immediate offer"
      email_template: "CASE A - Strong Match"
      
    good_match:
      range: [70, 85]
      action: "Standard offer"
      email_template: "CASE A - Standard"
      
    acceptable_match:
      range: [60, 70]
      action: "Offer with caveats"
      email_template: "CASE B - Not Ideal"
      
    marginal_match:
      range: [50, 60]
      action: "Low priority or positioning"
      email_template: "CASE B - Positioning"
      
    poor_match:
      range: [30, 50]
      action: "Only if requested"
      email_template: "CASE B - Unlikely"
      
    do_not_offer:
      range: [0, 30]
      action: "Skip unless manual override"
      email_template: "Do not send"
  
  automatic_actions:
    score_below_30: "Do not include in offer list"
    blocked_vessel: "Mark with reason, exclude completely"
    excellent_match: "Flag for immediate attention"

# ═══════════════════════════════════════════════════════════════════
# DATA NORMALIZATION RULES
# ═══════════════════════════════════════════════════════════════════

normalization:
  
  vessel_sizes:
    canonical_ranges:
      SC: [0, 4000]       # Small Coasters
      C:  [4001, 17000]   # Coasters
      SH: [17001, 24000]  # Small Handy
      H:  [24001, 40000]  # Handy
      SS: [40001, 50000]  # Small Supramax
      SM: [50001, 65000]  # Supramax
      PM: [65001, 80000]  # Panamax
    
    rule: "ALL files must use these exact ranges"
  
  regions:
    canonical_names:
      - "Black Sea"
      - "Black Sea Danube"
      - "Mediterranean"
      - "East Mediterranean"
      - "West Mediterranean"
      - "Egypt Mediterranean"
      - "Libya"
      - "Turkey"
      - "Greece"
      - "Marmara Sea"
      - "Adriatic"
      - "Atlantic"
      - "North Europe"
      - "Red Sea"
      - "Arabian Sea"
      - "Far East"
    
    rule: "Use exact names for region_pairs matching"

# ═══════════════════════════════════════════════════════════════════
# REASONING GENERATION RULES
# ═══════════════════════════════════════════════════════════════════

reasoning_templates:
  
  structure: |
    1. Overall Score: {final_score}/100
    2. Strengths: {top_scoring_criteria}
    3. Weaknesses: {low_scoring_criteria}
    4. Key Factors: {decisive_factors}
    5. Recommendation: {action}
  
  criterion_explanations:
    P1: "Vessel is {distance}nm from loading port ({proximity_level})"
    P1A: "{match_level} with typical {region_pair} trade pattern"
    P2: "Owner {preference_level} this region"
    P3: "Vessel {compatibility} with {cargo_type}"
    P4: "Vessel has {percentage}% history in this region"
    P5: "Can load {intake}t vs required {cargo_qty}t ({ratio}%)"
    P6: "Current voyage: {open_area_signal}"
    P7: "ETA {eta_date} vs laycan {laycan} ({timing_category})"
  
  blocking_explanations:
    technical: "Vessel cannot technically carry this cargo"
    capacity: "Insufficient intake capacity ({ratio}% of required)"
    owner_preference: "Owner explicitly avoids {restriction}"
    geopolitical: "Blocked due to {restriction_reason}"





# ═══════════════════════════════════════════════════════════════════
# PROXIMITY SCORING MATRIX
# VK Charts AI Scoring System - Criterion P1
# ═══════════════════════════════════════════════════════════════════
#
# SHORT SUMMARY
#
# This file defines P1 (Proximity) scoring - how AI evaluates geographic
# distance compatibility between vessel's current position and cargo's
# loading port. P1 contributes 0-20 points to the total score (100 max).
#
# WHAT THIS FILE CONTAINS:
#
# 1. INTERNAL SCORING LEVELS (0-50 internal points)
#    - Level 1: Same port = 50 internal points
#    - Level 7: Marmara Sea = 20 internal points
#    - Level 12: Beyond viable range = -10 internal points
#    - These are SCALED to final P1 range [0, 20]
#
# 2. VESSEL SIZE ADJUSTMENTS
#    - Coasters (4001-17000 DWT): Limited range, higher penalties
#    - Small Handy (17001-24000 DWT): Better tolerance
#    - Handy (24001-40000 DWT): Good long-distance capability
#    - Supramax/Panamax (40000+ DWT): Can ballast globally
#
# 3. DISTANCE PENALTIES
#    - Fine-tuning based on actual nautical miles within same level
#    - Penalty per 100nm varies by vessel size
#
# 4. GEOPOLITICAL RESTRICTIONS
#    - Ukraine-Russia war sanctions (IMPOSSIBLE scoring)
#    - Port accessibility by vessel size
#
# 5. AI USAGE INSTRUCTIONS
#    - Step-by-step scoring process
#    - Location determination logic
#    - Score calculation and scaling
#
# CRITICAL NOTE:
# Internal scores (0-50) in this file are SCALED to P1 final range [0, 20]
# according to MASTER_SCORING_SYSTEM.txt formula.
#
# ═══════════════════════════════════════════════════════════════════
  
  for_ai_langchain:
    role: "Proximity Scoring Implementation"
    process:
      step_1: "Read vessel location from input"
      step_2: "Read cargo loading port from input"
      step_3: "Determine vessel size category (DWT)"
      step_4: "Find matching proximity level in this file"
      step_5: "Get internal base score (0-50 range)"
      step_6: "Apply distance penalty if applicable"
      step_7: "Apply geopolitical restrictions if applicable"
      step_8: "Scale final internal score to P1 range [0-20]"
      step_9: "Generate explanation and reasoning"
    
      example: |
        {
          "criterion_1_proximity": {
            "score": 7.6,
            "score_range": "[0-20]",
            "internal_calculation": "level_7_marmara_sea: 20 internal points - 0.96 penalty = 19.04 → scaled to 7.6/20",
            "explanation": "Vessel in Marmara Sea, cargo loading Black Sea. Acceptable ballast through Bosphorus.",
            "reasoning": "For coaster-size vessel, Marmara to Black Sea is Level 7 proximity..."
          }
        }
    
    scaling_formula:
      internal_to_final: "P1_final = (internal_score / 50) * 20"
      example_1: "Internal 50 → P1 = 20 (maximum)"
      example_2: "Internal 25 → P1 = 10 (mid-range)"
      example_3: "Internal 0 → P1 = 0 (minimum)"
      example_4: "Internal -10 → P1 = 0 (blocked, cannot be negative)"


# ═══════════════════════════════════════════════════════════════════
# SCORING PRINCIPLE
# ═══════════════════════════════════════════════════════════════════

scoring_principle: |
  Proximity = Lower ballast cost = Higher score
  
  Чем ближе судно к порту погрузки, тем выше score
  
  INTERNAL SCORING: 0-50 points (used for detailed level differentiation)
  FINAL P1 SCORE: 0-20 points (scaled from internal score)
  
  Scaling formula: P1_final = (internal_score / 50) * 20

# ═══════════════════════════════════════════════════════════════════
# GEOGRAPHIC HIERARCHY
# ═══════════════════════════════════════════════════════════════════
  
  hierarchy:
    - "Port (lowest level)"
    - "Country"
    - "Region (optional sub-grouping)"
    - "Sea"
    - "Global Region (highest level)"
  
  example:
    port: "Odessa"
    country: "Ukraine"
    region: "POC"
    sea: "Black Sea"
    global_region: "Eastern Europe"

# ═══════════════════════════════════════════════════════════════════
# BLACK SEA SUB-REGIONS
# ═══════════════════════════════════════════════════════════════════

black_sea_subregions:
  
  poc:
    name: "POC (Pivdenny-Odessa-Chornomorsk)"
    country: "Ukraine"
    ports:
      - "Odessa"
      - "Pivdenny (Yuzhny)"
      - "Chornomorsk (Ilyichevsk)"
    characteristics:
      - "Major grain export hub"
      - "Close proximity to each other"
      - "Shared anchorage areas"
  
  sulina_anchorage:
    name: "Sulina Anchorage"
    country: "Romania/International waters"
    characteristics:
      - "Strategic position"
      - "Can access BOTH Danube AND POC"
      - "Excellent positioning for either direction"
    
  danube_ports:
    name: "Danube River Ports"
    countries: ["Romania", "Moldova", "Ukraine"]
    ports:
      romania:
        - "Galati"
        - "Braila"
      moldova:
        - "Giurgiulesti"
      ukraine:
        - "Kiliya"
        - "Orlovka"
        - "Izmail"
        - "Reni"
    characteristics:
      - "River ports"
      - "Draft restrictions"
      - "Smaller vessel sizes"
  
  cvb:
    name: "CVB (Constanta-Varna-Burgas)"
    countries: ["Romania", "Bulgaria"]
    ports:
      romania:
        - "Constanta"
      bulgaria:
        - "Varna"
        - "Burgas"
    characteristics:
      - "Major Black Sea ports"
      - "Good facilities"
      - "Western Black Sea"
  
  turkish_black_sea:
    name: "Turkish Black Sea Ports"
    country: "Turkey"
    ports:
      - "Samsun"
      - "Trabzon"
      - "Zonguldak"
      - "Eregli"
      - "And other Turkish Black Sea ports"
  
  russian_black_sea:
    name: "Russian Black Sea Ports"
    country: "Russia"
    ports:
      - "Novorossiysk"
      - "Kavkaz (Caucasus)"
      - "Other Russian Black Sea ports"
    
    geopolitical_restriction:
      status: "BLOCKED due to Ukraine-Russia war"
      ukraine_to_russia: "IMPOSSIBLE - sanctions"
      russia_to_ukraine: "IMPOSSIBLE - sanctions"
      effective_date: "2022-present"
  
  georgian_black_sea:
    name: "Georgian Black Sea Ports"
    country: "Georgia"
    ports:
      - "Poti"
      - "Batumi"

# ═══════════════════════════════════════════════════════════════════
# PROXIMITY SCORING - COASTERS (4001-17000 DWT)
# ═══════════════════════════════════════════════════════════════════

proximity_scoring_coasters:
  vessel_size_range: [4001, 17000]
  cargo_loading_example: "Black Sea (Odessa)"
  
  levels:
    
    level_1_same_port:
      internal_score: 50
      p1_equivalent: "~20 points"
      description: "Vessel in same port as loading port"
      examples:
        - vessel_location: "Odessa"
          cargo_loading: "Odessa"
          result: "Perfect - zero ballast"
      
    level_2_same_port_cluster:
      internal_score: 45
      p1_equivalent: "~18 points"
      description: "Vessel in same port cluster/region"
      examples:
        - vessel_location: "Pivdenny"
          cargo_loading: "Odessa"
          result: "POC cluster - minimal ballast (few hours)"
        - vessel_location: "Chornomorsk"
          cargo_loading: "Odessa"
          result: "POC cluster - minimal ballast"
      
    level_3_sulina_anchorage:
      internal_score: 48
      p1_equivalent: "~19 points"
      description: "Special case - Sulina Anchorage"
      reasoning: "Can access both POC and Danube easily"
      examples:
        - vessel_location: "Sulina Anchorage"
          cargo_loading: "Odessa"
          result: "Very close, excellent positioning"
        - vessel_location: "Sulina Anchorage"
          cargo_loading: "Reni (Danube)"
          result: "Also very close"
    
    level_4_same_subregion:
      internal_score: 40
      p1_equivalent: "~16 points"
      description: "Vessel in different port within same Black Sea sub-region"
      examples:
        - vessel_location: "Constanta"
          cargo_loading: "POC"
          result: "Both CVB region - short ballast"
      
    level_5_nearby_subregion:
      internal_score: 35
      p1_equivalent: "~14 points"
      description: "Vessel in nearby Black Sea sub-region"
      examples:
        - vessel_location: "CVB"
          cargo_loading: "POC"
          result: "Short cross-Black Sea ballast"
     
    level_6_same_black_sea:
      internal_score: 30
      p1_equivalent: "~12 points"
      description: "Vessel anywhere in Black Sea"
      examples:
        - vessel_location: "Turkish Black Sea"
          cargo_loading: "Odessa"
          result: "Same sea but longer ballast"
        - vessel_location: "Batumi (Georgia)"
          cargo_loading: "Odessa"
          result: "Cross Black Sea ballast"
      
      geopolitical_exceptions:
        ukraine_russia_block:
          condition: "Ukraine port ↔ Russian vessel OR Russia port ↔ Ukrainian vessel"
          score: "IMPOSSIBLE"
          reason: "War, sanctions, blocked"
          examples:
            - vessel: "Russian flag in Novorossiysk"
              cargo: "Loading in Odessa"
              result: "IMPOSSIBLE - cannot enter Ukraine"
            - vessel: "Any vessel in Ukraine"
              cargo: "Loading in Novorossiysk"  
              result: "IMPOSSIBLE - cannot enter Russia"
    
    level_7_marmara_sea:
      internal_score: 20
      p1_equivalent: "~8 points"
      description: "Vessel in Marmara Sea"
      examples:
        - vessel_location: "Istanbul"
          cargo_loading: "Odessa"
          result: "Bosphorus crossing + Black Sea ballast"
        - vessel_location: "Derince"
          cargo_loading: "Constanta"
          result: "Acceptable ballast"
      
    level_8_izmir_nemrut_east_greece:
      internal_score: 12
      p1_equivalent: "~5 points"
      description: "Vessel in line of Izmir-Nemrut Bay area and east coast Greece"
      examples:
        - vessel_location: "Izmir"
          cargo_loading: "Odessa"
          result: "Med → Dardanelles → Marmara → Bosphorus → Black Sea"
        - vessel_location: "Nemrut Bay"
          cargo_loading: "Constanta"
          result: "Short to Dardanelles, then Black Sea"
        - vessel_location: "Thessaloniki"
          cargo_loading: "Varna"
          result: "Eastern Greece → Black Sea acceptable"
      
    level_9_east_med:
      internal_score: 8
      p1_equivalent: "~3 points"
      description: "Vessel in East Mediterranean"
      examples:
        - vessel_location: "Limassol (Cyprus)"
          cargo_loading: "Odessa"
          result: "Longer Med → Black Sea ballast"
        - vessel_location: "Lebanon"
          cargo_loading: "Constanta"
          result: "East Med → Black Sea feasible but long"
      
    level_10_adriatic_ionian:
      internal_score: 4
      p1_equivalent: "~2 points"
      description: "Vessel in Adriatic or Ionian Sea"
      examples:
        - vessel_location: "Bar (Montenegro)"
          cargo_loading: "Odessa"
          result: "Adriatic → Med → Black Sea - long ballast"
        - vessel_location: "Durres (Albania)"
          cargo_loading: "Constanta"
          result: "Ionian → Med → Black Sea - marginal for coasters"
      notes: "Approaching limit for coasters"
    
    level_11_west_med:
      internal_score: 0
      p1_equivalent: "0 points"
      description: "Vessel in West Mediterranean - RARE for coasters"
      examples:
        - vessel_location: "Barcelona"
          cargo_loading: "Odessa"
          result: "Very long ballast - unlikely for coaster"
      notes: "Coasters typically won't ballast from this distance"
    
    level_12_beyond:
      internal_score: -10
      p1_equivalent: "0 points (blocked)"
      description: "Further than West Med - NOT VIABLE for coasters"
      examples:
        - vessel_location: "Atlantic"
        - vessel_location: "North Europe"
        - vessel_location: "Asia"
      notes: "Coasters working in these areas, not positioning to Black Sea"

# ═══════════════════════════════════════════════════════════════════
# PROXIMITY SCORING - SMALL HANDY (17001-24000 DWT)
# ═══════════════════════════════════════════════════════════════════

proximity_scoring_small_handy:
  vessel_size_range: [17001, 24000]
  cargo_loading_example: "Black Sea (Odessa)"
  
  levels:
    # Same top levels as coasters
    level_1_same_port:
      internal_score: 50
      p1_equivalent: "~20 points"
      
    level_2_same_port_cluster:
      internal_score: 45
      p1_equivalent: "~18 points"
      
    level_3_sulina_anchorage:
      internal_score: 48
      p1_equivalent: "~19 points"
      
    level_4_same_subregion:
      internal_score: 40
      p1_equivalent: "~16 points"
      
    level_5_nearby_subregion:
      internal_score: 35
      p1_equivalent: "~14 points"
      
    level_6_same_black_sea:
      internal_score: 30
      p1_equivalent: "~12 points"
      
    level_7_marmara_sea:
      internal_score: 22
      p1_equivalent: "~9 points"
      note: "Slightly higher than coasters"
      
    level_8_izmir_nemrut_east_greece:
      internal_score: 15
      p1_equivalent: "~6 points"
      note: "Better tolerance"
      
    level_9_east_med:
      internal_score: 10
      p1_equivalent: "~4 points"
      
    level_10_adriatic_ionian:
      internal_score: 6
      p1_equivalent: "~2 points"
      
    level_11_west_med:
      internal_score: 3
      p1_equivalent: "~1 point"
      description: "Feasible but not optimal"
      
    level_12_italy_spain:
      internal_score: 1
      p1_equivalent: "~0.4 points"
      description: "Marginal for small handy"
      
    level_13_beyond:
      internal_score: -5
      p1_equivalent: "0 points (blocked)"
      description: "Atlantic, North Europe - unlikely"

# ═══════════════════════════════════════════════════════════════════
# PROXIMITY SCORING - HANDY (24001-40000 DWT)
# ═══════════════════════════════════════════════════════════════════

proximity_scoring_handy:
  vessel_size_range: [24001, 40000]
  cargo_loading_example: "Black Sea (Odessa)"
  
  levels:
    # Same top levels (1-10)
    level_1_same_port:
      internal_score: 50
      p1_equivalent: "~20 points"
      
    level_2_same_port_cluster:
      internal_score: 45
      p1_equivalent: "~18 points"
      
    level_3_sulina_anchorage:
      internal_score: 48
      p1_equivalent: "~19 points"
      
    level_4_same_subregion:
      internal_score: 40
      p1_equivalent: "~16 points"
      
    level_5_nearby_subregion:
      internal_score: 35
      p1_equivalent: "~14 points"
      
    level_6_same_black_sea:
      internal_score: 30
      p1_equivalent: "~12 points"
      
    level_7_marmara_sea:
      internal_score: 22
      p1_equivalent: "~9 points"
      
    level_8_izmir_nemrut_east_greece:
      internal_score: 15
      p1_equivalent: "~6 points"
      
    level_9_east_med:
      internal_score: 10
      p1_equivalent: "~4 points"
      
    level_10_adriatic_ionian:
      internal_score: 6
      p1_equivalent: "~2 points"
    
    level_11_west_med:
      internal_score: 8
      p1_equivalent: "~3 points"
      description: "Acceptable for handy size"
      
    level_12_italy_france_spain:
      internal_score: 8
      p1_equivalent: "~3 points"
      
    level_13_gibraltar_area:
      internal_score: 8
      p1_equivalent: "~3 points"
      
    level_14_north_europe_baltic:
      internal_score: 2
      p1_equivalent: "~1 point"
      description: "Long but possible for handy"
      
    level_15_atlantic:
      internal_score: 0
      p1_equivalent: "0 points"
      description: "Very long ballast - marginal"
      
    level_16_beyond:
      internal_score: -10
      p1_equivalent: "0 points (blocked)"
      description: "Americas, Asia - not viable"

# ═══════════════════════════════════════════════════════════════════
# PROXIMITY SCORING - SUPRAMAX/PANAMAX (40000+ DWT)
# ═══════════════════════════════════════════════════════════════════

proximity_scoring_large_vessels:
  vessel_size_range: [40000, 80000]
  cargo_loading_example: "Black Sea (Odessa)"
  
  levels:
    # Same top levels (1-10)
    level_1_same_port:
      internal_score: 50
      p1_equivalent: "~20 points"
      
    level_2_same_port_cluster:
      internal_score: 45
      p1_equivalent: "~18 points"
      
    level_3_sulina_anchorage:
      internal_score: 48
      p1_equivalent: "~19 points"
      
    level_4_same_subregion:
      internal_score: 40
      p1_equivalent: "~16 points"
      
    level_5_nearby_subregion:
      internal_score: 35
      p1_equivalent: "~14 points"
      
    level_6_same_black_sea:
      internal_score: 30
      p1_equivalent: "~12 points"
      
    level_7_marmara_sea:
      internal_score: 22
      p1_equivalent: "~9 points"
      
    level_8_izmir_nemrut_east_greece:
      internal_score: 15
      p1_equivalent: "~6 points"
      
    level_9_east_med:
      internal_score: 10
      p1_equivalent: "~4 points"
      
    level_10_adriatic_ionian:
      internal_score: 6
      p1_equivalent: "~2 points"
    
    level_11_west_med:
      internal_score: 15
      p1_equivalent: "~6 points"
      description: "Good for large vessels"
      
    level_12_atlantic_islands:
      internal_score: 10
      p1_equivalent: "~4 points"
      
    level_13_north_europe:
      internal_score: 8
      p1_equivalent: "~3 points"
      description: "Long haul acceptable"
      
    level_14_uk_ireland:
      internal_score: 6
      p1_equivalent: "~2 points"
      
    level_15_west_africa:
      internal_score: 5
      p1_equivalent: "~2 points"
      description: "Can ballast if rates justify"
      
    level_16_americas_ecsa:
      internal_score: 3
      p1_equivalent: "~1 point"
      description: "Very long but possible"
      
    level_17_far_east_asia:
      internal_score: 0
      p1_equivalent: "0 points"
      description: "Extremely long - only if positioning for major cargo program"
      
    level_18_beyond:
      internal_score: -5
      p1_equivalent: "0 points (blocked)"

# ═══════════════════════════════════════════════════════════════════
# DISTANCE FACTOR (Nautical Miles)
# ═══════════════════════════════════════════════════════════════════

distance_adjustment:
  description: "Fine-tune score based on actual distance within same level"
  
  formula: "final_internal_score = base_level_score - (distance_penalty × MARITIME_distance_nm / 100)"
  
  note: "After distance adjustment, scale internal score to P1 range [0-20]"
  
  distance_penalty_by_vessel_size:
    small_coasters:
      penalty_per_100nm: 0.5
      max_penalty: 10
      
    coasters:
      penalty_per_100nm: 0.3
      max_penalty: 8
      
    small_handy:
      penalty_per_100nm: 0.2
      max_penalty: 6
      
    handy:
      penalty_per_100nm: 0.15
      max_penalty: 5
      
    supramax_panamax:
      penalty_per_100nm: 0.1
      max_penalty: 3
  
  examples:
    - vessel: "Coaster in Constanta"
      cargo: "Loading Odessa"
      distance: "~250 nm"
      base_internal_score: 35  # level_5_nearby_subregion
      distance_penalty: "0.3 × 250/100 = 0.75"
      final_internal_score: "35 - 0.75 = 34.25"
      p1_final: "(34.25 / 50) * 20 = 13.7 points"
      
    - vessel: "Coaster in Istanbul"
      cargo: "Loading Odessa"
      distance: "~320 nm"
      base_internal_score: 20  # level_7_marmara_sea
      distance_penalty: "0.3 × 320/100 = 0.96"
      final_internal_score: "20 - 0.96 = 19.04"
      p1_final: "(19.04 / 50) * 20 = 7.6 points"

# ═══════════════════════════════════════════════════════════════════
# PORT SIZE FACTOR
# ═══════════════════════════════════════════════════════════════════

port_size_impact:
  description: "Smaller ports restrict vessel sizes"
  
  rule: "If vessel DWT > port max DWT capacity → IMPOSSIBLE"
  
  examples:
    major_ports:
      ports: ["Odessa", "Constanta", "Novorossiysk", "Varna", "Burgas", "Batumi"]
      max_capacity: "Up to Panamax (80000 DWT)"
      
    medium_ports:
      ports: ["Crete island"]
      max_capacity: "Up to Handymax (~35000 DWT)"
      
    small_ports_danube:
      ports: ["Reni", "Izmail", "Galati"]
      max_capacity: "Up to small handy (~12000 DWT)"
      restriction: "Draft limited by Danube"
      
  scoring_adjustment:
    - condition: "Vessel size > port capacity"
      score: "IMPOSSIBLE"
      
    - condition: "Vessel size close to port limit (within 10%)"
      penalty: -5
      reason: "Tight fit, operational risk"

# ═══════════════════════════════════════════════════════════════════
# GEOPOLITICAL RESTRICTIONS
# ═══════════════════════════════════════════════════════════════════

geopolitical_blocks:
  
  ukraine_russia_war:
    status: "ACTIVE"
    effective_since: "2022-02-24"
    
    restrictions:
      - description: "Russian vessels CANNOT enter Ukrainian ports"
        reason: "War, sanctions"
        score_impact: "IMPOSSIBLE"
        
      - description: "Vessels in Ukraine CANNOT enter Russian ports"
        reason: "War, sanctions"
        score_impact: "IMPOSSIBLE"
        
      - description: "Russian-flagged vessels restrictions in EU"
        reason: "EU sanctions"
        note: "May affect scoring for EU ports"
    
    future_considerations:
      - "Situation may change"
      - "System must be flexible to update restrictions"
      - "May need temporal logic (restrictions valid from/to dates)"

# ═══════════════════════════════════════════════════════════════════
# USAGE INSTRUCTIONS FOR AI
# ═══════════════════════════════════════════════════════════════════

ai_usage_instructions:
  
  step_1_identify_locations:
    vessel_location:
      - "Determine: Port, Country, Region, Sea, Global Region"
      - "Use Airtable geographic hierarchy"
      - "Refer to vessel_location_determination.txt for logic"
      
    cargo_loading_location:
      - "Determine: Port, Country, Region, Sea, Global Region"
  
  step_2_determine_vessel_size:
    - "Get vessel DWT"
    - "Classify into size category (coaster/small handy/handy/supramax/panamax)"
    - "Select appropriate proximity_scoring table"
  
  step_3_find_proximity_level:
    - "Match vessel location to cargo loading location"
    - "Find the closest matching level"
    - "Get base internal score (0-50 range)"
  
  step_4_apply_adjustments:
    - "Calculate distance in nautical miles (use VesselFinder API if available)"
    - "Apply distance penalty formula"
    - "Check port size restrictions"
    - "Check geopolitical blocks"
    - "Calculate final internal score"
  
  step_5_scale_to_p1_range:
    - "Use formula: P1_final = (internal_score / 50) * 20"
    - "Ensure P1_final is within [0, 20] range"
    - "If internal_score <= 0, P1_final = 0"
  
  step_6_generate_explanation:
    - "Explain which level matched"
    - "Explain any adjustments applied"
    - "Show internal calculation and P1 final score"
    - "Provide reasoning for offer text"
  
  example_process:
    vessel:
      name: "MV EXAMPLE"
      dwt: 7500
      location: "Istanbul, Turkey"
      location_note: "See vessel_location_determination.txt for how to determine this"
      
    cargo:
      loading_port: "Odessa, Ukraine"
      loading_region: "POC"
      loading_sea: "Black Sea"
      
    ai_calculation:
      step_1: "Vessel: Marmara Sea | Cargo: Black Sea POC"
      step_2: "Vessel 7500 DWT = Coaster (4001-17000)"
      step_3: "Match: level_7_marmara_sea → base_internal_score = 20"
      step_4: "Distance ~320nm → penalty 0.96 → adjusted_internal = 19.04"
      step_5: "P1_final = (19.04 / 50) * 20 = 7.6 points"
      step_6: "Generate explanation below"
      
    example_output:
      {
        "criterion_1_proximity": {
          "score": 7.6,
          "score_range": "[0-20]",
          "internal_calculation": "Level 7 (Marmara Sea): 20 internal points - 0.96 distance penalty = 19.04 internal → scaled to 7.6/20 P1",
          "explanation": "Vessel is in Marmara Sea (Istanbul), loading port is Black Sea (Odessa). This is Level 7 proximity for coasters - acceptable ballast through Bosphorus. Distance approximately 320 nautical miles reduces score slightly.",
          "reasoning": "For a 7500 DWT coaster, positioning from Marmara Sea to Black Sea represents moderate ballast economics. The vessel needs to transit the Bosphorus Strait, which is a routine operation. While not optimal, this proximity level is commercially acceptable for the cargo opportunity. The P1 score of 7.6/20 (38%) reflects that ballast costs are manageable but not negligible."
        }
      }


# ═══════════════════════════════════════════════════════════════════
# SHORT SUMMARY
# ═══════════════════════════════════════════════════════════════════

DOCUMENT: Vessel Location Determination - Geographic Origin for Proximity Scoring
PURPOSE: Define how AI determines vessel's actual location before applying proximity scoring
SCOPE: Pre-processing step for P1 (Proximity) criterion
INTEGRATION: Critical input for proximity_scoring_matrix.txt - determines vessel_location

WHAT THIS DOCUMENT DEFINES:
This file establishes the authoritative methodology for determining a vessel's 
geographic location before calculating proximity scores. Since proximity scoring
requires knowing where the vessel is, this logic must execute FIRST to establish
the vessel_location input for the Proximity Scoring Matrix.

PRIORITY SYSTEM (4 levels):
1. Open Information (HIGHEST) - Vessel's declared open position
   - open_area, open_port, alternative_open_areas
2. Destination - Where vessel is heading (if valid geographic)
   - Must validate: real location vs non-geographic text
3. Current Area - Where vessel currently is (fallback)
   - From AIS or last known position
4. Unknown - Location cannot be determined (skip proximity scoring)

KEY FEATURES:
- Strict priority hierarchy (always check in order)
- Geographic validation (filters "to order", "TBN", crew info, etc.)
- Multiple open areas handling (select closest to loading port)
- Fuzzy matching for ports/regions (handles typos, variations)
- Edge case handling (outdated dates, contradictory data, ambiguous regions)
- Returns normalized geographic entity (port, region, country, sea)

CRITICAL DEPENDENCIES:
- proximity_scoring_matrix.txt: Uses output as vessel_location input
- Ports database: For geographic validation
- Regions/Seas lists: For fuzzy matching

VALIDATION LOGIC:
Valid Geographic:
- Port names: "Istanbul", "Constanta", "Odessa"
- Regions: "Black Sea", "Marmara Sea", "East Med"
- Countries: "Turkey", "Romania", "Ukraine"

Invalid Non-Geographic:
- Orders: "to order", "for orders", "awaiting orders"
- Nominations: "TBN", "TBA", "to be nominated"
- Crew info: "Syrian crew", "Greek crew onboard"
- Instructions: "INCO", "awaiting instructions", "owners option"

MULTIPLE OPEN AREAS SELECTION:
When vessel has multiple alternative open areas (e.g., ["Marmara Sea", "East Med", "Adriatic"]):
- Calculate proximity score from each area to cargo loading port
- Select area with HIGHEST proximity score
- Use selected area for all downstream scoring

EXAMPLE USAGE:
Input:
  open_area: null
  destination: "to order"
  current_area: "Marmara Sea"
Output:
  selected_location: "Marmara Sea"
  reasoning: "Destination invalid (non-geographic), using current_area (priority 3)"


# ═══════════════════════════════════════════════════════════════════
# HOW TO USE DOCUMENT
# ═══════════════════════════════════════════════════════════════════

## FOR DEVELOPERS (Laravel ↔ LangChain Integration)

### Data Flow:
1. **Laravel** retrieves vessel position data:
   - vessel_data table: open_date, open_port, open_area, destination, current_area
   - vessel_attributes table: alternative_open_areas (if exists)
   - Parse from email positions or AIS data

2. **Laravel** sends to **LangChain Python microservice**:
   ```json
   {
     "vessel_data": {
       "open_date": "2024-12-10",
       "open_port": "Istanbul",
       "open_area": "Marmara Sea",
       "alternative_open_areas": ["Marmara Sea", "East Med"],
       "destination": "Black Sea",
       "current_area": "Turkish Straits"
     },
     "cargo": {
       "loading_port": "Odessa, Ukraine",
       "loading_region": "Black Sea"
     }
   }
   ```

### Important Notes:
- Location determination MUST run BEFORE proximity scoring
- If location = null → skip proximity scoring (P1 = 0)
- Multiple open areas require proximity calculation for selection
- Geographic validation is critical (filters non-geographic text)
- Priority order is strict - never skip steps

### Database Field Names:
```
Verify actual field names in production:
- vessel_data.open_date
- vessel_data.open_port_id (FK to ports)
- vessel_data.open_area
- vessel_data.destination
- vessel_data.current_area
- vessel_attributes.alternative_open_areas (if exists)
```

# ═══════════════════════════════════════════════════════════════════
# LOCATION DETERMINATION ALGORITHM
# ═══════════════════════════════════════════════════════════════════

location_determination_algorithm:
  
  step_1_check_open_information:
    priority: 1
    
    check_open_area:
      condition: "open_area IS NOT NULL AND open_area != ''"
      action: "Use open_area as vessel location"
      
      special_case_multiple_open_areas:
        condition: "alternative_open_areas array has multiple values"
        action: "Select open area closest to cargo loading port"
        method: "Calculate distance from each alternative to loading port, choose minimum"
        
        example:
          vessel: "MV EXAMPLE"
          open_areas:
            - "Marmara Sea"
            - "East Med"
            - "Adriatic"
          cargo_loading: "Odessa, Black Sea"
          
          distance_calculation:
            - area: "Marmara Sea"
              distance_to_odessa: "320 nm"
              proximity_score: 20
              
            - area: "East Med"
              distance_to_odessa: "450 nm"
              proximity_score: 8
              
            - area: "Adriatic"
              distance_to_odessa: "650 nm"
              proximity_score: 4
          
          selected_area: "Marmara Sea"
          reason: "Closest to loading port, highest proximity score"
    
    check_open_port:
      condition: "open_port IS NOT NULL AND open_port != ''"
      action: "Use open_port as vessel location"
      notes: "More specific than open_area"
      
    check_open_date:
      condition: "open_date in the future or recent past"
      validation: "Ensure open date is realistic (not too far in past/future)"
      
  step_2_check_destination:
    priority: 2
    condition: "IF open_information is NULL or empty"
    
    check_destination_value:
      condition: "destination IS NOT NULL AND destination != ''"
      
      validate_geographic:
        description: "Check if destination is valid geographic location"
        
        valid_destinations:
          - "Specific port name"
          - "Country name"
          - "Region name"
          - "Sea name"
          - "Anchorage name"
          
        invalid_destinations:
          - "to order"
          - "TO ORDER"
          - "for orders"
          - "Syrian crew"
          - "Greek crew onboard"
          - "TBN" (to be nominated)
          - "TBA" (to be advised)
          - "INCO" (intent confirmation)
          - "awaiting instructions"
          - "owners option"
          - Any crew information
          - Any non-geographic text
          
        validation_method:
          step_1: "Check against known ports/countries/regions database"
          step_2: "Use fuzzy matching for variations"
          step_3: "If no match in database → consider invalid"
          step_4: "Detect keywords indicating non-geographic (order, crew, TBN, etc)"
          
      action_if_valid:
        - "Use destination as vessel location"
        - "Apply to proximity scoring"
        
      action_if_invalid:
        - "Proceed to Step 3 (current_area)"
        - "Log invalid destination for future analysis"
  
  step_3_check_current_area:
    priority: 3
    condition: "IF both open_information and valid destination are unavailable"
    
    check_current_area:
      condition: "current_area IS NOT NULL AND current_area != ''"
      action: "Use current_area as vessel location"
      notes: "Last resort - where vessel currently is according to AIS or last update"
      
  step_4_fallback:
    priority: 4
    condition: "IF all above steps fail"
    action: "CANNOT DETERMINE LOCATION"
    scoring_impact: "Skip proximity scoring or assign default low score"
    user_notification: "Vessel location unknown - manual review required"

# ═══════════════════════════════════════════════════════════════════
# EXAMPLES OF LOCATION DETERMINATION
# ═══════════════════════════════════════════════════════════════════

examples:
  
  example_1_open_area_available:
    vessel_data:
      open_date: "2024-12-05"
      open_port: "Istanbul"
      open_area: "Marmara Sea"
      destination: "Black Sea"
      current_area: "Turkish Straits"
      
    result:
      selected_location: "Istanbul, Marmara Sea"
      reason: "Open information available (priority 1)"
      specific_port: true
      proximity_level: "level_7_marmara_sea"
      
  example_2_multiple_open_areas:
    vessel_data:
      open_date: "2024-12-10"
      open_area: null
      alternative_open_areas:
        - "East Med"
        - "Marmara Sea"
        - "West Med"
      destination: null
      current_area: "Mediterranean"
      
    cargo_loading:
      port: "Odessa"
      sea: "Black Sea"
      
    calculation:
      east_med_distance: "450 nm"
      marmara_distance: "320 nm"
      west_med_distance: "1200 nm"
      
    result:
      selected_location: "Marmara Sea"
      reason: "Closest alternative open area to loading port"
      proximity_level: "level_7_marmara_sea"
      score: 20
      
  example_3_destination_fallback:
    vessel_data:
      open_date: null
      open_port: null
      open_area: null
      destination: "Constanta"
      current_area: "Black Sea"
      
    validation:
      is_geographic: true
      matched_port: "Constanta, Romania"
      
    result:
      selected_location: "Constanta"
      reason: "Open info unavailable, using destination (priority 2)"
      proximity_level: "level_5_nearby_subregion"
      
  example_4_invalid_destination:
    vessel_data:
      open_date: null
      open_port: null
      open_area: null
      destination: "to order"
      current_area: "Mediterranean"
      
    validation:
      is_geographic: false
      reason: "Non-geographic keyword detected"
      
    result:
      selected_location: "Mediterranean"
      reason: "Invalid destination, using current_area (priority 3)"
      proximity_level: "depends on specific Med area"
      
  example_5_crew_information:
    vessel_data:
      open_date: null
      open_area: null
      destination: "Syrian crew onboard"
      current_area: "East Med"
      
    validation:
      is_geographic: false
      reason: "Crew information is not location"
      
    result:
      selected_location: "East Med"
      reason: "Invalid destination (crew info), using current_area"
      proximity_level: "level_9_east_med"
      
  example_6_no_location_data:
    vessel_data:
      open_date: null
      open_area: null
      destination: null
      current_area: null
      
    result:
      selected_location: "UNKNOWN"
      reason: "No location data available"
      action: "Skip proximity scoring or assign default low score (0)"
      user_notification: "Manual review required"

# ═══════════════════════════════════════════════════════════════════
# NON-GEOGRAPHIC DESTINATION PATTERNS
# ═══════════════════════════════════════════════════════════════════

non_geographic_patterns:
  description: "Patterns to detect invalid destinations"
  
  keywords_to_detect:
    orders:
      - "to order"
      - "for orders"
      - "awaiting orders"
      - "owners order"
      - "charterers order"
      
    nominations:
      - "TBN"
      - "to be nominated"
      - "TBA"
      - "to be advised"
      - "to be declared"
      
    crew_information:
      - "crew"
      - "Syrian crew"
      - "Greek crew"
      - "Ukrainian crew"
      - "onboard"
      
    awaiting_instructions:
      - "INCO"
      - "intent confirmation"
      - "awaiting instructions"
      - "awaiting details"
      
    options:
      - "owners option"
      - "charterers option"
      - "to be decided"
      
  regex_patterns:
    - "(?i)to\\s+order"
    - "(?i)for\\s+orders?"
    - "(?i)\\b(tbn|tba)\\b"
    - "(?i)crew\\b"
    - "(?i)onboard"
    - "(?i)awaiting"
    - "(?i)option"
    
  detection_method:
    step_1: "Convert destination to lowercase"
    step_2: "Check against keyword list"
    step_3: "Apply regex patterns"
    step_4: "If ANY match → invalid destination"

# ═══════════════════════════════════════════════════════════════════
# GEOGRAPHIC VALIDATION
# ═══════════════════════════════════════════════════════════════════

geographic_validation:
  description: "How to validate if destination is geographic location"
  
  data_sources:
    - "Airtable ports database"
    - "Countries list"
    - "Regions list"
    - "Seas list"
    - "Known anchorages"
    
  validation_steps:
    step_1_exact_match:
      - "Check destination against ports table"
      - "Check against countries table"
      - "Check against regions table"
      - "Check against seas table"
      
    step_2_fuzzy_match:
      - "Use fuzzy string matching (Levenshtein distance)"
      - "Account for typos and variations"
      - "Examples: 'Odesa' → 'Odessa', 'Konstanca' → 'Constanta'"
      
    step_3_common_abbreviations:
      known_abbreviations:
        - "POC → Pivdenny-Odessa-Chornomorsk"
        - "CVB → Constanta-Varna-Burgas"
        - "E Med → East Mediterranean"
        - "W Med → West Mediterranean"
        - "BS → Black Sea"
        - "MS → Marmara Sea"
        
    step_4_negative_keywords:
      - "If contains non-geographic keywords → invalid"
      - "Even if partially matches geographic location"
      - "Example: 'Odessa to order' → invalid (contains 'to order')"

# ═══════════════════════════════════════════════════════════════════
# MULTIPLE OPEN AREAS SELECTION
# ═══════════════════════════════════════════════════════════════════

multiple_open_areas_logic:
  description: "How to choose when vessel has multiple alternative open areas"
  
  selection_criteria:
    primary: "Proximity to cargo loading port"
    method: "Calculate distance or proximity score for each option"
    
  calculation_method:
    step_1: "For each alternative open area"
    step_2: "Calculate proximity score to cargo loading port"
    step_3: "Select area with HIGHEST proximity score"
    step_4: "Use selected area for all subsequent scoring"
    
  distance_calculation_options:
    
    option_a_use_proximity_matrix:
      description: "Apply proximity scoring matrix to each alternative"
      pros: "Reuses existing scoring logic"
      cons: "Need to know vessel size first"
      
    option_b_simple_distance:
      description: "Calculate nautical miles from each area to loading port"
      pros: "Size-agnostic, simpler"
      cons: "Less nuanced than scoring matrix"
      
    recommended: "option_a_use_proximity_matrix"
    
  tie_breaking:
    condition: "If two alternatives have same proximity score"
    rule_1: "Prefer more specific location over general region"
    rule_2: "Prefer area with better backhaul opportunities"
    rule_3: "If still tied, use first in list (arbitrary)"
    
  example_detailed:
    vessel:
      name: "MV EXAMPLE"
      dwt: 8500
      size_category: "coaster"
      
    alternatives:
      - "Istanbul (Marmara)"
      - "Piraeus (East Greece)"
      - "Limassol (Cyprus, East Med)"
      
    cargo:
      loading_port: "Odessa"
      loading_sea: "Black Sea"
      
    scoring_each:
      istanbul:
        proximity_level: "level_7_marmara_sea"
        base_score: 20
        distance: "320 nm"
        adjusted_score: 19.04
        
      piraeus:
        proximity_level: "level_8_izmir_nemrut_east_greece"
        base_score: 12
        distance: "520 nm"
        adjusted_score: 10.44
        
      limassol:
        proximity_level: "level_9_east_med"
        base_score: 8
        distance: "680 nm"
        adjusted_score: 5.96
        
    selected: "Istanbul (Marmara)"
    reason: "Highest adjusted proximity score (19.04)"

# ═══════════════════════════════════════════════════════════════════
# EDGE CASES & SPECIAL HANDLING
# ═══════════════════════════════════════════════════════════════════

edge_cases:
  
  case_1_ambiguous_destination:
    example: "Med"
    problem: "Could be East Med, West Med, Central Med"
    solution: "Use current_area for more specificity, or ask user"
    
  case_2_very_old_open_date:
    example: "open_date: 2024-06-01" (current date: 2024-12-01)
    problem: "Open date 6 months old, likely outdated"
    solution: "Prefer current_area over open_area if open_date > 30 days old"
    
  case_3_contradictory_data:
    example:
      open_area: "Black Sea"
      destination: "Singapore"
      current_area: "Marmara Sea"
    problem: "Data doesn't make sense together"
    solution: "Trust priority order, but flag for manual review"
    
  case_4_multiple_ports_in_destination:
    example: "Constanta/Varna/Burgas"
    solution: "Parse as region 'CVB', use center point or all options"
    
  case_5_range_in_open_area:
    example: "open_area: East Med - West Med"
    solution: "Treat as two alternatives, select closest"


# ═══════════════════════════════════════════════════════════════════
# SHORT SUMMARY
# ═══════════════════════════════════════════════════════════════════

DOCUMENT: Vessel Size Classification - Size Category Definitions
PURPOSE: Single source of truth for vessel size categorization in VK Charts AI
SCOPE: Dry cargo bulk carriers and general cargo vessels (bulk operations)
INTEGRATION: Used across all scoring criteria (P1-P7) for size-dependent logic

WHAT THIS DOCUMENT DEFINES:
This file establishes the official VK Charts vessel size classification system
for all dry-cargo vessels (bulk + general cargo). It provides the authoritative
DWT ranges, category codes, and size-specific behavioral characteristics that
drive AI scoring decisions across all criteria.

SIZE CATEGORIES (7 total):
1. Small Coasters (SC): 0-4,000 DWT - River/coastal vessels
2. Coasters (C): 4,001-17,000 DWT - Regional bulk trades (most common Black Sea-Med)
3. Small Handy (SH): 17,001-24,000 DWT - Medium haul bulk carriers
4. Handy (H): 24,001-40,000 DWT - Long haul capable (NOT common in Greek trades)
5. Small Supramax (SS): 40,001-50,000 DWT - Deep sea bulk carriers
6. Supramax (SM): 50,001-65,000 DWT - Global bulk trades
7. Panamax (PM): 65,000-80,000 DWT - Maximum size for Panama Canal

KEY FEATURES:
- Precise DWT ranges for each category
- Size-specific economic behavior (ballast tolerance, operating cost)
- Typical trade patterns and routes for each size
- Impact on proximity scoring (smaller vessels = higher distance penalty)
- Cargo-vessel size compatibility rules
- Integration with all scoring criteria

CRITICAL DEPENDENCIES:
- proximity_scoring_matrix.txt: Uses size categories for distance penalties
- regional_trade_patterns_corrected.txt: References size categories in vessel_size_rules
- MASTER_SCORING_SYSTEM.txt: All criteria use vessel size for score adjustments

SIZE IMPACT ON SCORING:
- Small vessels (SC, C): Very sensitive to distance, seek backhaul aggressively
- Medium vessels (SH, H): Moderate distance tolerance, selective on backhaul
- Large vessels (SS, SM, PM): High distance tolerance, can ballast for positioning

SCOPE LIMITATIONS:
✓ INCLUDED: Dry cargo bulk carriers, general cargo (bulk ops)
✗ EXCLUDED: Oil tankers, chemical tankers, LNG/LPG, containers, RoRo, pure breakbulk

EXAMPLE USAGE:
- Vessel DWT 8,500 → Category C (Coaster) → High ballast sensitivity
- Vessel DWT 55,000 → Category SM (Supramax) → Low ballast sensitivity
- Cargo Black Sea-Med grain → Prefer C/SH sizes (4,001-24,000 DWT)

**Size category used across all scoring criteria:**
   - P1 (Proximity): Distance penalty scaling
   - P1A (Regional Patterns): Size-specific trade pattern rules
   - P2 (Regional Preferences): Size preferences for regions
   - P3 (Cargo Preferences): Cargo-vessel size compatibility
   - P4 (Last Ports): Size-specific return patterns
   - P6 (Intake Capacity): Size-based capacity calculations
   - P7 (OpenArea Comments): Size-specific readiness interpretation

### Important Notes:
- DWT is the ONLY input needed for size categorization
- Categories are mutually exclusive (no overlap in ranges)
- This file is the SINGLE SOURCE OF TRUTH - never hardcode ranges elsewhere
- If vessel type is not bulk carrier, skip size-based scoring
- Size category must be included in all scoring responses for transparency

---

## FOR AI/LangChain (Size Categorization Implementation)

### Step-by-Step Algorithm:

**STEP 1: Validate Input**
```
Required: vessel_dwt (integer or float, > 0)
Optional: vessel_type (for scope validation)

Validation:
- IF vessel_dwt <= 0: REJECT with error "Invalid DWT"
- IF vessel_type NOT in [bulk_carrier, general_cargo, multi_purpose]: 
    WARN "Vessel may be outside scope" but CONTINUE
```

**STEP 2: Determine Size Category**
```
Based on vessel_dwt, match to ONE category:

IF dwt >= 0 AND dwt <= 4000:
    category = "SC" (Small Coasters)
    
ELSE IF dwt >= 4001 AND dwt <= 17000:
    category = "C" (Coasters)
    
ELSE IF dwt >= 17001 AND dwt <= 24000:
    category = "SH" (Small Handy)
    
ELSE IF dwt >= 24001 AND dwt <= 40000:
    category = "H" (Handy)
    
ELSE IF dwt >= 40001 AND dwt <= 50000:
    category = "SS" (Small Supramax)
    
ELSE IF dwt >= 50001 AND dwt <= 65000:
    category = "SM" (Supramax)
    
ELSE IF dwt >= 65000 AND dwt <= 80000:
    category = "PM" (Panamax)
    
ELSE IF dwt > 80000:
    category = "OVERSIZED" (outside current scope)
    NOTE: "Vessel larger than Panamax, may need special handling"
```

**STEP 3: Retrieve Category Characteristics**
```
Look up category in vessel_sizes section:
- dwt_range
- typical_characteristics
- typical_uses
- examples
- notes (if any)
```

**STEP 4: Retrieve Economic Behavior**
```
Look up category in economics_by_size section:
- daily_operating_cost
- ballast_cost_sensitivity
- backhaul_seeking_behavior
- viable_ballast_distance
```

**STEP 5: Retrieve Trade Patterns**
```
Determine size group for trade patterns:
- small_coasters_and_coasters: SC, C
- small_handy_and_handy: SH, H
- supramax_and_panamax: SS, SM, PM

Retrieve:
- primary_regions
- typical_routes
- ballast_strategy
- notes (if any)
```

**STEP 6: Calculate Scoring Impact**
```
Based on category, determine impact on scoring:

Proximity Penalty (from ai_scoring_guidelines):
- SC: "Very high penalty per 100nm" → -30 to -50 for long ballast
- C: "High penalty per 100nm" → -20 to -40 for long ballast
- SH: "Medium penalty per 100nm" → -15 to -30 for long ballast
- H: "Medium-low penalty per 100nm" → -10 to -20 for long ballast
- SS/SM/PM: "Low penalty per 100nm" → -5 to -15 for long ballast
```

## QUICK REFERENCE

**Size Categories (7 total):**
- SC: 0-4,000 DWT (Small Coasters)
- C: 4,001-17,000 DWT (Coasters) ← Most common Black Sea-Med
- SH: 17,001-24,000 DWT (Small Handy)
- H: 24,001-40,000 DWT (Handy) ← NOT common in Greek trades
- SS: 40,001-50,000 DWT (Small Supramax)
- SM: 50,001-65,000 DWT (Supramax)
- PM: 65,000-80,000 DWT (Panamax)

**Ballast Tolerance:**
- SC/C: Very low/low - avoid long ballast
- SH/H: Medium - selective on ballast
- SS/SM/PM: High/very high - can ballast for positioning

**Typical Trades:**
- SC/C: Black Sea-Med, regional short haul
- SH/H: Medium to long haul, cross-Med
- SS/SM/PM: Global deep sea, trans-ocean

**Proximity Impact:**
- Smaller vessels = higher distance penalty
- Larger vessels = lower distance penalty

**Cargo Type Fit:**
- Black Sea-Med grain: C, SH preferred
- Black Sea-Far East grain: SM, PM preferred
- Steel/fertilizers: C, SH preferred

**Scope:**
- ✓ Dry cargo bulk, general cargo (bulk ops)
- ✗ Tankers, containers, RoRo, LNG/LPG

# ═══════════════════════════════════════════════════════════════════
# VESSEL SIZE CATEGORIES - DRY CARGO
# ═══════════════════════════════════════════════════════════════════

vessel_sizes:
  
  small_coasters:
    dwt_range: [0, 4000]
    dwt_min: 0
    dwt_max: 4000
    category_code: "SC"
    
    typical_characteristics:
      trade_area: "Very short haul, coastal, inland waterways"
      ballast_tolerance: "Very low - must find cargo"
      
    typical_uses:
      - "River navigation"
      - "Small coastal parcels"
      - "Short sea shipping"
      - "Inland waterways (Danube, Rhine, etc)"
      
    examples:
      - "Small river-sea vessels"
      - "Coastal feeders"
      
  coasters:
    dwt_range: [4001, 17000]
    dwt_min: 4001
    dwt_max: 17000
    category_code: "C"
    
    typical_characteristics:
      trade_area: "Short to medium haul"
      ballast_tolerance: "Low - prefer backhaul"
      typical_routes: "Black Sea-Med, Med-Med, regional trades"
      
    typical_uses:
      - "Regional grain trades"
      - "Steel products"
      - "Fertilizers"
      - "General bulk"
      - "Bagged cargoes"
      
    sub_categories:
      small_coasters:
        dwt_range: [4001, 8000]
        notes: "Lower end coasters"
        
      medium_coasters:
        dwt_range: [8001, 12000]
        notes: "Most common coaster size"
        
      large_coasters:
        dwt_range: [12001, 17000]
        notes: "Upper end coasters"
    
    examples:
      - "Typical Black Sea grain vessels"
      - "Med short haul bulk"
      
  small_handy:
    dwt_range: [17001, 24000]
    dwt_min: 17001
    dwt_max: 24000
    category_code: "SH"
    
    typical_characteristics:
      trade_area: "Medium to long haul"
      ballast_tolerance: "Medium"
      typical_routes: "Cross-Med, Black Sea-North Africa, regional"
      
    typical_uses:
      - "Larger grain parcels"
      - "Steel products"
      - "Fertilizers"
      - "Ore parcels"
      
    examples:
      - "Transitional size between coaster and handy"
      
  handy:
    dwt_range: [24001, 40000]
    dwt_min: 24001
    dwt_max: 40000
    category_code: "H"
    
    typical_characteristics:
      trade_area: "Long haul capable"
      ballast_tolerance: "Medium-high"
      typical_routes: "Trans-ocean, long distance trades"
      
    typical_uses:
      - "Large grain parcels"
      - "Coal"
      - "Iron ore"
      - "Long haul bulk"
      
    notes:
      - "NOT common in Greek trades (per Vitaly)"
      - "More common in Atlantic, long haul trades"
      
    examples:
      - "Handysize bulk carriers"
      
  small_supramax:
    dwt_range: [40001, 50000]
    dwt_min: 40001
    dwt_max: 50000
    category_code: "SS"
    
    typical_characteristics:
      trade_area: "Long haul, deep sea"
      ballast_tolerance: "High"
      typical_routes: "Trans-ocean, far distances"
      
    typical_uses:
      - "Large grain parcels to Far East"
      - "Coal"
      - "Iron ore"
      - "Major bulk commodities"
      
  supramax:
    dwt_range: [50001, 65000]
    dwt_min: 50001
    dwt_max: 65000
    category_code: "SM"
    
    typical_characteristics:
      trade_area: "Global deep sea"
      ballast_tolerance: "Very high - can absorb long ballast"
      typical_routes: "Major trade routes, long haul"
      
    typical_uses:
      - "Major bulk commodity trades"
      - "Grain to Far East"
      - "Coal, iron ore"
      - "Trans-ocean routes"
      
  panamax:
    dwt_range: [65000, 80000]
    dwt_min: 65000
    dwt_max: 80000
    category_code: "PM"
    
    typical_characteristics:
      trade_area: "Global major routes"
      ballast_tolerance: "Very high"
      typical_routes: "Major bulk trade lanes"
      
    typical_uses:
      - "Large grain shipments"
      - "Major coal/ore trades"
      - "Trans-ocean bulk"
      
    notes:
      - "Maximum size for Panama Canal (hence name)"
      - "Maximum practical size ex-Black Sea ports"
      
  other_sizes:
    notes: "Larger sizes (Capesize, etc) can be added later if needed"
    not_relevant_for_current_scope: true

# ═══════════════════════════════════════════════════════════════════
# VESSEL SIZE ECONOMICS
# ═══════════════════════════════════════════════════════════════════

economics_by_size:
  
  small_coasters:
    daily_operating_cost: "lowest"
    ballast_cost_sensitivity: "very high"
    backhaul_seeking_behavior: "aggressive - must find cargo"
    viable_ballast_distance: "< 300 nm"
    
  coasters:
    daily_operating_cost: "low"
    ballast_cost_sensitivity: "high"
    backhaul_seeking_behavior: "strong preference for backhaul"
    viable_ballast_distance: "< 800 nm"
    
  small_handy:
    daily_operating_cost: "medium-low"
    ballast_cost_sensitivity: "medium-high"
    backhaul_seeking_behavior: "moderate"
    viable_ballast_distance: "< 1200 nm"
    
  handy:
    daily_operating_cost: "medium"
    ballast_cost_sensitivity: "medium"
    backhaul_seeking_behavior: "selective"
    viable_ballast_distance: "< 2000 nm"
    
  small_supramax:
    daily_operating_cost: "medium-high"
    ballast_cost_sensitivity: "low-medium"
    backhaul_seeking_behavior: "selective"
    viable_ballast_distance: "< 3000 nm"
    
  supramax:
    daily_operating_cost: "high"
    ballast_cost_sensitivity: "low"
    backhaul_seeking_behavior: "opportunistic - can ballast if rates justify"
    viable_ballast_distance: "< 5000 nm"
    
  panamax:
    daily_operating_cost: "very high"
    ballast_cost_sensitivity: "very low"
    backhaul_seeking_behavior: "strategic - ballast acceptable for positioning"
    viable_ballast_distance: "> 5000 nm possible"

# ═══════════════════════════════════════════════════════════════════
# SIZE-SPECIFIC TRADE PATTERNS
# ═══════════════════════════════════════════════════════════════════

trade_patterns_by_size:
  
  small_coasters_and_coasters:
    primary_regions:
      - "Black Sea"
      - "Mediterranean"
      - "Marmara Sea"
      - "Adriatic"
      - "Short sea shipping"
      
    typical_routes:
      - "Black Sea → Mediterranean"
      - "Black Sea → North Africa"
      - "Mediterranean internal"
      - "Marmara → Black Sea"
      
    ballast_strategy:
      - "Avoid long ballast at all costs"
      - "Seek backhaul aggressively"
      - "Prefer short positioning legs"
      
  small_handy_and_handy:
    primary_regions:
      - "Regional to medium distance"
      - "Can do longer hauls but prefer medium"
      
    typical_routes:
      - "Black Sea → North Africa"
      - "Mediterranean → Atlantic"
      - "Regional bulk trades"
      
    ballast_strategy:
      - "Can consider medium ballast legs"
      - "Still prefer backhaul when economical"
      
    notes:
      - "Handy size NOT common in Greek trades"
      
  supramax_and_panamax:
    primary_regions:
      - "Global trades"
      - "Long haul routes"
      
    typical_routes:
      - "Black Sea → Far East"
      - "Atlantic → Pacific"
      - "Major bulk trade lanes"
      
    ballast_strategy:
      - "Can ballast long distances if rates justify"
      - "Less pressure to find backhaul"
      - "Strategic positioning for high-paying cargoes"

# ═══════════════════════════════════════════════════════════════════
# IMPORTANT NOTES FOR AI SCORING
# ═══════════════════════════════════════════════════════════════════

ai_scoring_guidelines:
  
  critical_rules:
    - "ALWAYS use correct DWT ranges from this file"
    - "Smaller vessels = higher penalty for long ballast"
    - "Larger vessels = more tolerant of ballast positioning"
    - "Coasters in Asia = likely working local market, not positioning"
    - "Supramax+ in Asia = could be positioning from Black Sea"
    
  size_impact_on_scoring:
    - "Small coaster long ballast: -30 to -50 score"
    - "Coaster long ballast: -20 to -40 score"
    - "Small handy long ballast: -15 to -30 score"
    - "Handy long ballast: -10 to -20 score"
    - "Supramax+ long ballast: -5 to -15 score"
    
  proximity_multiplier:
    concept: "Closer = Better, scaled by vessel size"
    formula: "Base score × (1 - distance_penalty)"
    distance_penalty_by_size:
      small_coasters: "Very high penalty per 100nm"
      coasters: "High penalty per 100nm"
      small_handy: "Medium penalty per 100nm"
      handy: "Medium-low penalty per 100nm"
      supramax_panamax: "Low penalty per 100nm"

# ═══════════════════════════════════════════════════════════════════
# CARGO TYPE vs VESSEL SIZE PREFERENCES
# ═══════════════════════════════════════════════════════════════════

cargo_vessel_size_fit:
  
  grain_black_sea_to_med:
    preferred_sizes:
      - "Coasters: 4001-17000 DWT"
      - "Small handy: 17001-24000 DWT"
    rare_sizes:
      - "Handy: 24001-40000 DWT (not common for Med)"
      
  grain_black_sea_to_far_east:
    preferred_sizes:
      - "Supramax: 50001-65000 DWT"
      - "Panamax: 65000-80000 DWT"
    minimum_practical:
      - "Small supramax: 40001-50000 DWT"
      
  steel_products:
    preferred_sizes:
      - "Coasters: 4001-17000 DWT"
      - "Small handy: 17001-24000 DWT"
      
  fertilizers:
    preferred_sizes:
      - "Coasters: 4001-17000 DWT"
      - "Small handy: 17001-24000 DWT"
      
  bauxite_ore:
    preferred_sizes:
      - "Coasters: 8001-17000 DWT"
      - "Small handy: 17001-24000 DWT"

# ═══════════════════════════════════════════════════════════════════
# SCOPE DEFINITION
# ═══════════════════════════════════════════════════════════════════

scope:
  included:
    - "Dry cargo bulk carriers"
    - "General cargo vessels (if carrying bulk)"
    - "Multi-purpose vessels (for bulk operations)"
    
  excluded:
    - "Oil tankers"
    - "Chemical tankers"
    - "LNG/LPG carriers"
    - "Container ships"
    - "RoRo vessels"
    - "Pure breakbulk (non-bulk cargo)"
    
  notes:
    - "This system focuses exclusively on DRY BULK shipping"
    - "Oil and liquid cargo not considered"


port_restrictions_map

Short Summary — Port Restrictions Map

This file contains the physical and operational limitations of ports, terminals, and regions.
It defines what a vessel can or cannot do in a specific port based on:

Draft restrictions

LOA / Beam limits

Water type (fresh / brackish / sea)

Seasonal restrictions (ice, low water, draft reduction)

Gear requirements (required / preferred / optional)

Maximum vessel size (typical DWT ranges)

Terminal-level depth and operational constraints

It also includes regional-level patterns, explaining where gear is typically required (Africa, Red Sea, Asia) or rarely needed (Black Sea, America).

This file is the authoritative source for all port-related compatibility checks in the VK Charts AI scoring system.

▶️ How to Use — Short Instructions
1. Use this file to check whether the vessel can physically load/discharge

AI must compare:

vessel draft

LOA

beam

presence/absence of vessel gear

with the port’s restrictions.

If any restriction is violated →
AI must assign a low score or mark the vessel incompatible for this cargo.

2. Apply regional patterns when port-level data is missing

If a specific port is not in the file:

Use region_patterns (e.g., “Africa → gear required”)

This acts as a fallback rule to avoid incorrect assumptions

3. Use seasonal rules for ports like Izmail/Reni

AI must adjust scoring if:

winter ice requires ice-class

low water reduces draft

Danube limitations restrict DWT

These conditions directly influence vessel–cargo compatibility.

4. Use gear_requirement rules for cargo types

Example:
Sugar in bags → vessel gear required (both ends).
If the vessel has no gear → −20 penalty.

This connects port restrictions with cargo-specific requirements.

5. Determine maximum vessel size compatibility

File provides typical DWT limits:

Odessa/Constanta → up to Panamax

Izmail/Reni → ~3–8K DWT

Egypt Med ports → 5–20K DWT

AI must ensure vessel DWT is within the acceptable range.

6. Use “aliases” for correct port matching

Odessa, Chornomorsk, Ilyichevsk → same port group.
Constanta → may require gear only during roadstead ops.

This prevents false negatives in matching.

# ═══════════════════════════════════════════════════════════════════
# METADATA & DEFINITIONS
# ═══════════════════════════════════════════════════════════════════

definitions:
  draft: "Maximum vessel draft in meters (summer draft)"
  loa: "Maximum Length Overall in meters"
  beam: "Maximum vessel beam/width in meters"
  wlthc: "Winter Load Line Tropical Cargo (needs clarification)"
  water_type:
    - fresh: "Freshwater (rivers, lakes)"
    - brackish: "Mixed fresh/salt water (estuaries, deltas)"
    - sea: "Seawater (open sea ports)"
  
  restriction_stability:
    constant: "Restrictions don't change (infrastructure limitation)"
    seasonal: "Restrictions vary by season (water level, ice, etc)"
    
  gear_requirement:
    required: "Vessel gear absolutely necessary"
    preferred: "Vessel gear gives advantage but not mandatory"
    optional: "Shore gear available, vessel gear not needed"
    
  sources:
    airtable: "Port name from Airtable database"
    user_knowledge: "Expert knowledge (Vitaly)"
    port_authority: "Official port documentation"
    practical_experience: "Real fixture experience"

# ═══════════════════════════════════════════════════════════════════
# REGION-LEVEL PATTERNS
# ═══════════════════════════════════════════════════════════════════

region_patterns:
  
  black_sea:
    general_gear_requirement: "optional"
    notes: "Almost never need vessel gear in Black Sea ports"
    water_type: "sea"
    major_ports_capacity: "Up to Panamax size"
    
  mediterranean:
    coaster_gear_requirement: "optional"
    handysize_plus_gear_requirement: "preferred"
    notes: "Coasters rarely need gear, larger vessels sometimes do"
    
  asia:
    general_gear_requirement: "required"
    notes: "Vessel gear often needed for loading operations"
    
  red_sea:
    general_gear_requirement: "required"
    notes: "Vessel gear frequently needed"
    
  africa:
    general_gear_requirement: "required"
    notes: "Vessel gear often needed"
    
  america:
    general_gear_requirement: "optional"
    notes: "Almost never need vessel gear"

# ═══════════════════════════════════════════════════════════════════
# COUNTRY-LEVEL RESTRICTIONS
# ═══════════════════════════════════════════════════════════════════

countries:
  
  ukraine:
    airtable_id: "TBD"
    general_notes: "Major grain exporter, modern facilities in main ports"
    
    ports:
      
      odessa_chornomorsk:
        airtable_id: "TBD"
        official_name: "Odessa/Chornomorsk Port Complex"
        aliases: ["Odessa", "Chornomorsk", "Ilyichevsk"]
        
        restrictions:
          draft: null  # No specific limit, accepts up to Panamax
          loa: null    # Can handle large vessels
          beam: null
          wlthc: null
          restriction_type: "constant"
          
        water_type: "sea"
        
        vessel_gear:
          requirement: "optional"
          reason: "Modern grain terminals with shore equipment"
          
        max_vessel_size:
          description: "Up to Panamax"
          typical_dwt_range: [3000, 75000]
          
        terminals:
          - name: "TIS Grain Terminal"
            draft: 14.0
            notes: "Deep water terminal"
            
          - name: "Kernel Terminal"
            draft: 12.5
            
          - name: "Nika-Tera"
            draft: 12.0
        
        notes: "Major grain export hub with modern facilities"
        
      izmail_reni:
        airtable_id: "TBD"
        official_name: "Izmail/Reni Danube Ports"
        aliases: ["Izmail", "Reni", "Ismail"]
        region: "Danube Delta"
        
        restrictions:
          draft: 7.0
          loa: null
          beam: null
          wlthc: null
          restriction_type: "seasonal"
          
        seasonal_variations:
          winter:
            months: [12, 1, 2]
            additional_restrictions:
              ice: true
              ice_class_required: true
              notes: "Icebreaker assistance may be needed"
              
          low_water:
            months: [8, 9]
            draft_reduction: 0.3
            notes: "Draft may be reduced in dry season"
        
        water_type: "fresh"
        
        vessel_gear:
          requirement: "required"
          reason: "Danube ports limited shore facilities"
          
        max_vessel_size:
          description: "Small handysize max"
          typical_dwt_range: [3000, 8000]
          
        notes: "Danube river ports with draft and seasonal limitations"
  
  romania:
    airtable_id: "TBD"
    
    ports:
      
      constanta:
        airtable_id: "TBD"
        official_name: "Constanta Port"
        
        restrictions:
          draft: null  # No specific limit, major port
          loa: null
          beam: null
          wlthc: null
          restriction_type: "constant"
          
        water_type: "sea"
        
        vessel_gear:
          requirement: "optional"
          reason: "Modern port with shore equipment"
          exceptions:
            - condition: "Roadstead transhipment operations"
              requirement: "required"
              reason: "Loading from small vessel to larger vessel"
          
        max_vessel_size:
          description: "Up to Panamax"
          typical_dwt_range: [3000, 75000]
          
        operations:
          roadstead_transhipment:
            available: true
            vessel_gear_required: true
            typical_scenario: "Small vessel → Large vessel transfer"
            
        notes: "Major Black Sea port, can handle large vessels"
  
  russia:
    airtable_id: "TBD"
    
    ports:
      
      novorossiysk:
        airtable_id: "TBD"
        official_name: "Novorossiysk"
        
        restrictions:
          draft: null  # Major port, deep water
          loa: null
          beam: null
          wlthc: null
          restriction_type: "constant"
          
        water_type: "sea"
        
        vessel_gear:
          requirement: "optional"
          
        max_vessel_size:
          description: "Up to Panamax and larger"
          typical_dwt_range: [5000, 100000]
          
        notes: "Largest Russian Black Sea port"
  
  egypt:
    airtable_id: "TBD"
    
    ports:
      
      alexandria:
        airtable_id: "TBD"
        restrictions:
          draft: 8.5
          loa: null
          beam: null
          wlthc: null
          restriction_type: "constant"
        water_type: "sea"
        vessel_gear:
          requirement: "optional"
        max_vessel_size:
          typical_dwt_range: [5000, 15000]
          
      damietta:
        airtable_id: "TBD"
        restrictions:
          draft: 9.0
          loa: null
          beam: null
          wlthc: null
          restriction_type: "constant"
        water_type: "sea"
        vessel_gear:
          requirement: "optional"
        max_vessel_size:
          typical_dwt_range: [5000, 20000]
          
      port_said:
        airtable_id: "TBD"
        restrictions:
          draft: 10.0
          loa: null
          beam: null
          wlthc: null
          restriction_type: "constant"
        water_type: "sea"
        vessel_gear:
          requirement: "optional"
        max_vessel_size:
          typical_dwt_range: [8000, 30000]

# ═══════════════════════════════════════════════════════════════════
# SPECIAL CARGO GEAR REQUIREMENTS
# ═══════════════════════════════════════════════════════════════════

cargo_gear_requirements:
  
  sugar_in_bags:
    cargo_type: "Sugar (bagged/big bags)"
    
    gear_requirement:
      loading_ports: "required"
      discharge_ports: "required"
      reason: "Bagged cargo handling typically requires vessel gear"
      
    applies_to:
      - "Sugar in bags"
      - "Sugar in big bags"
      - "Similar bagged agricultural products"
      
    scoring_impact:
      vessel_has_gear: 0
      vessel_no_gear: -20

# ═══════════════════════════════════════════════════════════════════
# TEMPLATE FOR NEW PORTS
# ═══════════════════════════════════════════════════════════════════

port_template:
  port_name_here:
    airtable_id: "TBD"
    official_name: ""
    aliases: []
    country: ""
    region: ""
    
    restrictions:
      draft: null          # meters (null if no restriction)
      loa: null           # meters (null if no restriction)  
      beam: null          # meters (null if no restriction)
      wlthc: null         # (needs clarification)
      restriction_type: "constant"  # or "seasonal"
      
    seasonal_variations:  # only if restriction_type: "seasonal"
      season_name:
        months: []
        additional_restrictions: {}
        
    water_type: "sea"    # fresh/brackish/sea
    
    vessel_gear:
      requirement: "optional"  # required/preferred/optional
      reason: ""
      exceptions: []
      
    max_vessel_size:
      description: ""
      typical_dwt_range: [min, max]
      
    terminals: []        # if port has multiple terminals
    
    operations: {}       # special operations (transhipment, etc)
    
    notes: ""
    source: "user_knowledge"
    last_updated: "YYYY-MM-DD"


regional_trade_patterns

Short Summary — P1A: Regional Pattern Scoring Logic

Этот раздел определяет отдельный критерий оценки (0–15 points), который отражает, насколько рыночные торговые паттерны делают текущую позицию судна подходящей для погрузки в выбранном регионе.

В отличие от Proximity Scoring, который оценивает географическую близость,
P1A оценивает экономическую логику движения флота, используя:

region_pairs (паттерны между регионами)

vessel_size_economics (размер судна → поведение)

seasonal_patterns (зерновой сезон, зима и т. д.)

port_economics (модификаторы конкретных портов погрузки)

Важно:
Оценка основывается только на текущем регионе открытия судна,
а НЕ на последнем порту выгрузки.

▶️ How to Use — Short Instructions

1️⃣ Передать в AI следующие данные:

vessel_location_region

cargo_loading_region

vessel_dwt

cargo_type (optional)

month (optional)

2️⃣ AI выполняет алгоритм:

ищет паттерн (region_pairs[from → to])

определяет size bucket → получает базовый score

применяет seasonal adjustments

применяет port economics modifiers

суммирует, ограничивает результат диапазоном 0–15

3️⃣ Вернуть в итоговом ответе поле:

"criterion_regional_patterns_score": <0-15>


4️⃣ Не путать с proximity:
Этот критерий добавляется поверх географической оценки.
Proximity = «как близко?»
Regional patterns = «насколько логично сюда идти по рынку?»

5️⃣ Если паттерна нет:
AI использует только seasonal + port_economics.
Если нет и их → score = 0.


# ═══════════════════════════════════════════════════════════════════
# REGIONAL TRADE PATTERNS - KNOWLEDGE BASE
# VK Charts AI Scoring System
# ═══════════════════════════════════════════════════════════════════
# 
# Эта база знаний используется для AI-driven scoring совместимости
# судна с грузом на основе региональных торговых паттернов
#
# СТРУКТУРА:
# - Region Pairs: торговые маршруты между регионами
# - Port Economics: экономика конкретных портов
# - Seasonal Patterns: сезонные факторы
# - Vessel Size Economics: экономика по размерам судов
# - Learning Log: история обучения от пользователя
# ═══════════════════════════════════════════════════════════════════

version: "1.0"
last_updated: "2024-11-27"

# ═══════════════════════════════════════════════════════════════════
# SECTION 1: REGION PAIR PATTERNS
# ═══════════════════════════════════════════════════════════════════

region_pairs:
  
  # ─────────────────────────────────────────────────────────────────
  # BLACK SEA → MEDITERRANEAN
  # ─────────────────────────────────────────────────────────────────
  
  black_sea_to_libya:
    id: "BS_TO_LY"
    from_region: "Black Sea"
    to_region: "Libya"
    
    # Основной паттерн
    pattern:
      description: "Vessels discharging in Libya typically return to Black Sea in ballast"
      ballast_return_probability: 0.85  # 85% идут в балласте обратно
      
      # Причины
      reasons:
        primary: "Very low freight rates for backhaul cargo Libya → Black Sea"
        secondary: 
          - "Limited cargo availability ex-Libya northbound"
          - "Most Libya exports go to Europe/Med, not Black Sea"
          - "Time-sensitive for next Black Sea grain cargo"
      
      # Применимость по размеру судна
      # ❗ ИЗМЕНЕНИЕ: Используем категории из vessel_size_classification
      vessel_size_rules:
        handy_plus:  # H + SS + SM + PM (24001+ DWT)
          vessel_categories: ["H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.90
          reasoning: "Economics favor direct ballast return for larger vessels"
          score_impact: +25  # Если судно в Ливии и груз в Black Sea
          
        small_handy:  # SH (17001-24000 DWT)
          vessel_categories: ["SH"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.80
          reasoning: "Still economical to return ballast, but may consider backhaul"
          score_impact: +20
          
        coasters:  # SC + C (0-17000 DWT)
          vessel_categories: ["SC", "C"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.60
          reasoning: "Smaller vessels try harder to find backhaul cargo"
          score_impact: +10
          exceptions:
            - "If vessel has regular Black Sea program, may still ballast"
            - "Turkish/Greek owners more likely to seek Mediterranean backhaul"
      
      # Типичные альтернативы балласту
      backhaul_alternatives:
        - route: "Libya → Turkey"
          cargo_types: ["steel coils", "cement"]
          probability: 0.10
          
        - route: "Libya → Greece"  
          cargo_types: ["bauxite", "clinker"]
          probability: 0.05
      
    # Validation examples (для обучения)
    examples:
      - vessel_dwt: 15000
        vessel_category: "C"  # ❗ ДОБАВЛЕНО
        last_port: "Misrata, Libya"
        cargo_loading_port: "Odessa, Ukraine"
        expected_score_boost: +10  # ❗ ИЗМЕНЕНО с +25 на +10 (coaster rule)
        explanation: "Coaster size vessel discharged in Libya, may seek backhaul but Black Sea grain still attractive"
        
      - vessel_dwt: 7200
        vessel_category: "C"  # ❗ ДОБАВЛЕНО
        last_port: "Tripoli, Libya"
        cargo_loading_port: "Constanta, Romania"
        expected_score_boost: +10
        explanation: "Small vessel may look for backhaul first, but Black Sea grain still attractive"

  # ─────────────────────────────────────────────────────────────────
  
  black_sea_to_egypt_med:
    id: "BS_TO_EG_MED"
    from_region: "Black Sea"
    to_region: "Egypt Mediterranean"
    
    pattern:
      description: "High probability ballast return, but better backhaul opportunities than Libya"
      ballast_return_probability: 0.70
      
      reasons:
        primary: "Egypt Med ports closer to Black Sea than Libya"
        secondary:
          # ❗ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ на основе learning_session_1.txt
          - "Some backhaul opportunities from Egypt (salt in big bags, steel products)"
          - "Salt in big bags common backhaul"
          - "Note: Phosphates come from Red Sea (Aqaba), NOT Egypt Med"
      
      vessel_size_rules:
        handy_plus:
          vessel_categories: ["H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.75
          score_impact: +20
          
        small_handy:
          vessel_categories: ["SH"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.65
          score_impact: +15
          
        coasters:
          vessel_categories: ["SC", "C"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.55
          score_impact: +8
      
      backhaul_alternatives:
        # ❗ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ согласно learning_session_1
        - route: "Egypt → Black Sea"
          cargo_types: ["salt in big bags", "other big bag cargoes", "steel products"]
          probability: 0.20
          source_correction: "learning_session_1.txt - phosphates from Red Sea, not Egypt Med"
          
        - route: "Egypt → Turkey"
          cargo_types: ["cement", "clinker"]
          probability: 0.10

  # ─────────────────────────────────────────────────────────────────
  
  black_sea_to_turkey:
    id: "BS_TO_TR"
    from_region: "Black Sea"
    to_region: "Turkey"
    
    pattern:
      description: "Excellent backhaul opportunities, low ballast probability"
      ballast_return_probability: 0.30
      
      reasons:
        primary: "Turkey has strong export cargo to Black Sea"
        secondary:
          - "Short distance allows quick repositioning"
          - "Turkish steel, marble, cement all available"
      
      vessel_size_rules:
        all_sizes:
          vessel_categories: ["SC", "C", "SH", "H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.30
          score_impact: +5  # Lower because backhaul likely
          reasoning: "Backhaul cargo readily available from Turkey"
      
      backhaul_alternatives:
        - route: "Turkey → Black Sea"
          cargo_types: ["steel products", "marble", "cement", "clinker"]
          probability: 0.70

  # ─────────────────────────────────────────────────────────────────
  
  black_sea_to_greece:
    id: "BS_TO_GR"
    from_region: "Black Sea"
    to_region: "Greece"
    
    pattern:
      description: "Moderate backhaul probability, depends on Greek ports"
      ballast_return_probability: 0.55
      
      vessel_size_rules:
        all_sizes:
          vessel_categories: ["SC", "C", "SH", "H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.55
          score_impact: +12
      
      backhaul_alternatives:
        - route: "Greece → Black Sea"
          cargo_types: ["bauxite", "alumina", "clinker"]
          probability: 0.45
          ports: ["Volos", "Thessaloniki"]

  # ─────────────────────────────────────────────────────────────────
  
  mediterranean_to_black_sea:
    id: "MED_TO_BS"
    from_region: "Mediterranean"
    to_region: "Black Sea"
    
    pattern:
      description: "Generally good for positioning, especially before grain season"
      ballast_return_probability: 0.20  # Low - most find cargo
      
      reasons:
        primary: "Black Sea is major loading area, good for positioning"
        secondary:
          - "Grain season creates demand"
          - "Short ballast leg to major cargo hub"
      
      seasonal_variations:
        grain_season:  # July-December
          months: [7, 8, 9, 10, 11, 12]
          ballast_probability: 0.15
          score_impact: +30
          reasoning: "Peak demand for Black Sea grain exports"
          
        off_season:  # January-June
          months: [1, 2, 3, 4, 5, 6]
          ballast_probability: 0.25
          score_impact: +15
          reasoning: "Lower demand, but still active"

  # ─────────────────────────────────────────────────────────────────
  
  atlantic_to_black_sea:
    id: "ATL_TO_BS"
    from_region: "Atlantic"
    to_region: "Black Sea"
    
    pattern:
      description: "Long ballast leg, but economical during grain season"
      ballast_return_probability: 0.40
      
      reasons:
        primary: "Long distance makes ballast expensive"
        secondary:
          - "Vessels prefer to find intermediate cargo"
          - "But Black Sea grain rates can justify ballast"
      
      vessel_size_rules:
        large_vessels:
          vessel_categories: ["H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.35
          score_impact: +15
          reasoning: "Larger vessels can absorb ballast cost better"
          
        small_vessels:
          vessel_categories: ["SC", "C", "SH"]
          reference: "vessel_size_classification.txt"
          ballast_probability: 0.50
          score_impact: +8
          reasoning: "Smaller vessels seek intermediate cargo more actively"
      
      seasonal_variations:
        peak_grain_season:
          months: [9, 10, 11]
          score_adjustment: +10
          reasoning: "High grain rates justify long ballast"

  # ─────────────────────────────────────────────────────────────────
  
  black_sea_internal:
    id: "BS_INTERNAL"
    from_region: "Black Sea"
    to_region: "Black Sea"
    
    pattern:
      description: "Short repositioning, very favorable"
      ballast_return_probability: 0.10
      
      vessel_size_rules:
        all_sizes:
          vessel_categories: ["SC", "C", "SH", "H", "SS", "SM", "PM"]
          reference: "vessel_size_classification.txt"
          score_impact: +35
          reasoning: "Minimal repositioning cost, already in prime cargo area"
      
      special_cases:
        ukraine_to_romania:
          score_impact: +40
          reasoning: "Main grain corridor, multiple cargo opportunities"
          
        georgia_to_ukraine:
          score_impact: +30
          reasoning: "Good positioning for Ukrainian grain"

# ═══════════════════════════════════════════════════════════════════
# SECTION 2: PORT-SPECIFIC ECONOMICS
# ═══════════════════════════════════════════════════════════════════

port_economics:
  
  # Порты погрузки (loading ports)
  loading_ports:
    
    odessa_ukraine:
      port_name: "Odessa/Chornomorsk"
      country: "Ukraine"
      region: "Black Sea"
      
      characteristics:
        typical_cargoes: ["wheat", "corn", "barley", "sunflower oil"]
        vessel_size_preference: [3000, 12000]  # DWT sweet spot
        draft_restriction: 8.5  # meters
        
      scoring_modifiers:
        vessels_in_black_sea: +30
        vessels_in_mediterranean: +15
        vessels_in_atlantic: +5
        vessels_in_far_east: -20
        
      special_considerations:
        - "Major grain export hub"
        - "High cargo availability"
        - "Good for vessels returning from Mediterranean"
    
    constanta_romania:
      port_name: "Constanta"
      country: "Romania"
      region: "Black Sea"
      
      characteristics:
        typical_cargoes: ["wheat", "corn", "barley"]
        vessel_size_preference: [3000, 10000]
        draft_restriction: 8.0
        
      scoring_modifiers:
        vessels_in_black_sea: +32
        vessels_in_mediterranean: +18
        vessels_in_bosphorus_area: +25
    
    izmail_ukraine:
      port_name: "Izmail/Reni"
      country: "Ukraine"
      region: "Black Sea Danube"
      
      characteristics:
        typical_cargoes: ["wheat", "corn", "barley"]
        vessel_size_preference: [3000, 8000]  # Smaller due to Danube
        draft_restriction: 7.0
        gear_required: true  # Often requires ship's gear
        
      seasonal_restrictions:
        winter_ice:
          months: [12, 1, 2]
          score_penalty: -15
          requirement: "Ice class or icebreaker assistance"
          
      scoring_modifiers:
        vessels_in_danube_area: +35
        vessels_with_gear: +10
        vessels_without_gear: -5
  
  # Порты выгрузки (discharge ports)
  discharge_ports:
    
    egypt_mediterranean:
      port_group: "Egypt Med Ports"
      ports: ["Alexandria", "Damietta", "Port Said"]
      country: "Egypt"
      region: "Mediterranean"
      
      characteristics:
        typical_imports: ["wheat", "corn", "barley"]
        vessel_size_preference: [5000, 15000]
        draft_restrictions:
          alexandria: 8.5
          damietta: 9.0
          port_said: 10.0
        
      return_cargo_analysis:
        ballast_to_black_sea:
          probability: 0.70
          economic_justification: "Good grain rates justify ballast"
          
        alternative_routes:
          - destination: "Turkey"
            probability: 0.15
            cargo: "phosphates, steel"
          - destination: "East Med"
            probability: 0.15
            cargo: "trans-shipment"
    
    libya_ports:
      port_group: "Libya Ports"
      ports: ["Misrata", "Tripoli", "Benghazi"]
      country: "Libya"
      region: "North Africa"
      
      characteristics:
        typical_imports: ["wheat", "flour", "barley"]
        vessel_size_preference: [8000, 20000]
        
      return_cargo_analysis:
        ballast_to_black_sea:
          probability: 0.85
          economic_justification: "Limited backhaul options, direct ballast economical"
          
        alternative_routes:
          - destination: "Turkey"
            probability: 0.10
            cargo: "steel products"
          - destination: "Italy"
            probability: 0.05
            cargo: "scrap metal"

# ═══════════════════════════════════════════════════════════════════
# SECTION 3: SEASONAL PATTERNS
# ═══════════════════════════════════════════════════════════════════

seasonal_patterns:
  
  black_sea_grain_season:
    name: "Black Sea Grain Export Season"
    peak_months: [8, 9, 10, 11]  # August-November
    active_months: [7, 8, 9, 10, 11, 12]
    
    effects:
      vessel_demand:
        description: "High demand for vessels to load Black Sea grain"
        score_boost_for_positioning: +25
        
      freight_rates:
        level: "high"
        impact: "Justifies longer ballast legs to position"
        
      port_congestion:
        risk: "medium"
        delay_probability: 0.30
  
  black_sea_winter:
    name: "Black Sea Winter Restrictions"
    months: [12, 1, 2, 3]
    
    effects:
      ice_restrictions:
        affected_ports: ["Izmail", "Reni", "Mariupol", "Berdyansk"]
        requirements: "Ice class or icebreaker assistance"
        score_penalty: -15
        
      reduced_activity:
        description: "Lower cargo volumes in winter months"
        freight_rate_impact: "lower"
  
  mediterranean_summer:
    name: "Mediterranean Peak Season"
    months: [5, 6, 7, 8, 9]
    
    effects:
      increased_demand:
        description: "Higher demand for grain imports before harvest"
        score_boost: +10

# ═══════════════════════════════════════════════════════════════════
# SECTION 4: VESSEL SIZE ECONOMICS
# ❗ ПОЛНАЯ ПЕРЕРАБОТКА - убираем дублирование
# ═══════════════════════════════════════════════════════════════════

vessel_size_economics:
  
  # ❗ ИЗМЕНЕНИЕ: Полностью ссылаемся на vessel_size_classification.txt
  reference_source: "vessel_size_classification.txt"
  
  note: |
    ALL vessel size economics are defined in vessel_size_classification.txt
    This section only contains TRADE-SPECIFIC exceptions not covered there
    
  size_category_mapping:
    SC: "vessel_size_classification.small_coasters"
    C:  "vessel_size_classification.coasters"
    SH: "vessel_size_classification.small_handy"
    H:  "vessel_size_classification.handy"
    SS: "vessel_size_classification.small_supramax"
    SM: "vessel_size_classification.supramax"
    PM: "vessel_size_classification.panamax"
  
  # Только специфичные для региональных паттернов исключения
  regional_specific_rules:
    
    handy_greece_exception:
      vessel_categories: ["H"]
      note: "Handy size NOT common in Greek trades per learning_session_1"
      impact: "Reduce score for Greece destinations"
      source: "learning_session_1.txt"
    
    coasters_black_sea_preference:
      vessel_categories: ["SC", "C"]
      note: "Coasters optimal for Black Sea-Med grain trades"
      impact: "+5 bonus for Black Sea grain cargoes"

# ═══════════════════════════════════════════════════════════════════
# SECTION 5: CARGO TYPE PATTERNS
# ═══════════════════════════════════════════════════════════════════

cargo_type_patterns:
  
  grain_cargoes:
    types: ["wheat", "corn", "barley", "soy"]
    
    vessel_requirements:
      size_preference: [3000, 15000]
      gear_requirement:
        optional_ports: ["Odessa", "Constanta"]  # Grain terminals have shore gear
        required_ports: ["Izmail", "Reni"]  # Grain terminals have shore gear
      
    trade_routes:
      main_flows:
        - from: "Black Sea"
          to: ["Egypt", "Libya", "Tunisia", "Morocco"]
          seasonality: "Year-round, peak Aug-Dec"
          
        - from: "Black Sea"
          to: ["Far East", "Bangladesh"]
          seasonality: "Mainly Oct-Feb"
    
    return_patterns:
      after_north_africa:
        ballast_probability: 0.75
        reasoning: "Limited backhaul cargo"
        
      after_far_east:
        ballast_probability: 0.30
        reasoning: "Good backhaul opportunities from Far East"

# ═══════════════════════════════════════════════════════════════════
# SECTION 6: LEARNING LOG
# История обучения от пользователя
# ═══════════════════════════════════════════════════════════════════

learning_log:
  # Здесь будут сохраняться corrections от пользователя
  # Формат:
  # 
  # - timestamp: "2024-11-27T10:30:00Z"
  #   scenario:
  #     vessel_dwt: 7500
  #     last_port: "Tripoli, Libya"
  #     cargo_loading_port: "Constanta, Romania"
  #     cargo_type: "wheat"
  #   
  #   ai_initial_score: 65
  #   user_corrected_score: 80
  #   
  #   ai_question: "Why score higher? Small vessel from Libya should seek backhaul first?"
  #   user_explanation: "This specific owner has regular Black Sea program, always ballasts back"
  #   
  #   new_rule_created:
  #     rule_id: "owner_specific_pattern_001"
  #     pattern: "Certain owners with regular Black Sea programs ballast directly regardless of vessel size"
  #     confidence: 0.8
  
  corrections: []
  
  # Статистика обучения
  statistics:
    total_corrections: 0
    rules_generated_from_corrections: 0
    average_score_adjustment: 0
    most_corrected_scenarios: []

# ═══════════════════════════════════════════════════════════════════
# SECTION 7: METADATA & VERSIONING
# ═══════════════════════════════════════════════════════════════════

metadata:
  created_by: "Vitaly (VK Charts)"
  created_date: "2024-11-27"
  last_modified: "2024-11-27"
  version: "1.0.0"
  
  changelog:
    - version: "1.0.0"
      date: "2024-11-27"
      changes:
        - "Initial structure created"
        - "Added Libya-Black Sea pattern (from user example)"
        - "Added basic seasonal patterns"
        - "Added vessel size economics"
        - "Added learning log structure"
  
  notes:
    - "This knowledge base will grow through behavioral learning"
    - "User corrections will automatically generate new rules"
    - "Confidence scores will increase as patterns are validated"


# ═══════════════════════════════════════════════════════════════════
# SECTION 8: REGIONAL PATTERN SCORING LOGIC
# ═══════════════════════════════════════════════════════════════════

regional_pattern_scoring:

  # Общая идея:
  # - Это ОТДЕЛЬНЫЙ критерий, независимый от proximity
  # - Использует:
  #   - region_pairs
  #   - port_economics.loading_ports
  #   - seasonal_patterns
  #   - vessel_size_economics
  #
  # ВАЖНО:
  # - Используем ТОЛЬКО текущий регион открытия судна
  #   (vessel_location_region из vessel_location_determination)
  # - НЕ используем "регион последней выгрузки"

  score_range: [0, 15]   # ❗ ИЗМЕНЕНО с 0-25 на 0-15 согласно MASTER_SCORING

  inputs:
    vessel_location_region: "Нормализованный регион текущего открытия судна (Black Sea, Libya, Egypt Mediterranean, Mediterranean, Atlantic, Turkey, Greece, etc.)"
    cargo_loading_region:   "Нормализованный регион порта погрузки (из портовой иерархии/Ports DB)"
    vessel_dwt:             "DWT судна (для выбора size bucket)"
    cargo_type:             "Тип груза (grain, steel, fertilizers, etc.) — опционально"
    month:                  "Текущий месяц (1-12) для сезонности — опционально"
    market_strength:        "Опционально: soft / neutral / strong (можно добавить позже)"

  algorithm:

    step_1_resolve_regions:
      description: |
        Определить нормализованные регионы:
        - from_region = vessel_location_region
        - to_region   = cargo_loading_region

        Здесь мы не смотрим на историю рейсов, только на:
        - где судно открыто СЕЙЧАС
        - откуда груз будет грузиться

    step_2_find_region_pair_pattern:
      description: |
        Найти подходящий элемент в region_pairs:

        1) Сначала ищем точное совпадение:
           (from_region, to_region) → region_pairs[from_region_to_to_region]

           Примеры:
           - ("Libya", "Black Sea") → black_sea_to_libya
           - ("Egypt Mediterranean", "Black Sea") → black_sea_to_egypt_med
           - ("Mediterranean", "Black Sea") → mediterranean_to_black_sea
           - ("Atlantic", "Black Sea") → atlantic_to_black_sea
           - ("Black Sea", "Black Sea") → black_sea_internal

        2) Если точного нет — можно использовать более общий паттерн:
           - from_region = "Mediterranean", to_region = "Black Sea"
           - from_region = "Black Sea internal" и т.п.

        3) Если паттерна нет вообще:
           - base_pattern_score = 0
           - дальше используем только port_economics + seasonal_patterns (если есть)

    step_3_base_score_from_region_pair:
      description: |
        ❗ UPDATED: Now uses vessel categories from vessel_size_classification
        
        1. Determine vessel category (SC/C/SH/H/SS/SM/PM)
        2. Find matching vessel_size_rules by category
        3. Apply score_impact
        4. Scale to 0-15 range (was 0-25)

        Пример:
          black_sea_to_libya.pattern.vessel_size_rules:
            handy_plus:
              vessel_categories: ["H", "SS", "SM", "PM"]
              score_impact: +25
            small_handy:
              vessel_categories: ["SH"]
              score_impact: +20
            coasters:
              vessel_categories: ["SC", "C"]
              score_impact: +10

        Логика:
        - Находим правило, где vessel_category входит в vessel_categories
        - Применяем score_impact
        - Масштабируем к диапазону 0-15

      pseudocode: |
        # Get vessel category
        vessel_category = get_category_from_dwt(vessel_dwt)  # uses vessel_size_classification
        
        # Find pattern
        pattern = find_region_pair(from_region, to_region)
        
        if pattern exists:
          # Find rule matching vessel category
          for rule in pattern.vessel_size_rules:
            if vessel_category in rule.vessel_categories:
              raw_score = rule.score_impact
              # Scale from old 0-25 to new 0-15
              base_pattern_score = (raw_score / 25) * 15
              break
        else:
          base_pattern_score = 0

    step_4_apply_seasonality:
      description: |
        Если передан month и/или cargo_type, можно скорректировать base_pattern_score
        на основе seasonal_patterns и cargo_type_patterns.

        Примеры использования:
        - Если груз зерновой (grain) и месяц входит в black_sea_grain_season.active_months:
            → добавить score_boost_for_positioning / score_impact (но не выходя за общий максимум 15)
        - Если зима и порт в зоне ice-restrictions:
            → вычесть score_penalty

      logic: |
        seasonal_adjustment = 0

        - Если cargo_loading_region в Black Sea и
          month ∈ black_sea_grain_season.active_months:
            seasonal_adjustment += black_sea_grain_season.effects.score_boost_for_positioning
            # Пример: +25 (но масштабировать к 0-15 диапазону)

        - Если cargo_loading_region попадает в порты из black_sea_winter.effects.ice_restrictions.affected_ports
          и month ∈ black_sea_winter.months:
            seasonal_adjustment += black_sea_winter.effects.ice_restrictions.score_penalty
            # Пример: -15 (но масштабировать)

        seasonal_adjustment = может быть положительным или отрицательным
        # Важно: масштабировать к новому диапазону 0-15

    step_5_apply_port_economics:
      description: |
        Если для порта погрузки или его группы есть запись в port_economics.loading_ports,
        используем scoring_modifiers.

        Идея:
        - loading_port_entry = port_economics.loading_ports[porto_group_or_name]
        - Внутри него есть scoring_modifiers:
            vessels_in_black_sea: +30
            vessels_in_mediterranean: +15
            vessels_in_atlantic: +5
            ...

        - В зависимости от vessel_location_region добавляем соответствующий модификатор.
        - Важно: модификаторы также нужно масштабировать к диапазону 0-15

      logic: |
        port_modifier = 0

        loading_port_entry = find_loading_port_entry(cargo_loading_region / конкретный порт)
        if loading_port_entry and loading_port_entry.scoring_modifiers exists:
          if vessel_location_region == "Black Sea":
            port_modifier += loading_port_entry.scoring_modifiers.vessels_in_black_sea
          else if vessel_location_region == "Mediterranean":
            port_modifier += loading_port_entry.scoring_modifiers.vessels_in_mediterranean
          else if vessel_location_region == "Atlantic":
            port_modifier += loading_port_entry.scoring_modifiers.vessels_in_atlantic
          # и т.д. по наличию ключей
          
        # Масштабировать модификаторы к диапазону 0-15
        port_modifier = (port_modifier / 50) * 15  # assuming original max was ~50

    step_6_combine_and_normalize:
      description: |
        Финальный score для Regional patterns:

        raw_score = base_pattern_score
                    + seasonal_adjustment
                    + port_modifier

        final_score = clamp(raw_score, 0, 15)

      pseudocode: |
        raw_score = base_pattern_score + seasonal_adjustment + port_modifier

        if raw_score < 0:
          final_score = 0
        else if raw_score > 15:
          final_score = 15
        else:
          final_score = raw_score

    output:
      field_name: "criterion_regional_patterns_score"
      description: "Оценка позиции судна с точки зрения региональных торговых паттернов (независимо от расстояния/proximity)"
      range: [0, 15]

  examples:

    - name: "Libya vessel → Odessa grain loading (large vessel)"
      input:
        vessel_location_region: "Libya"
        cargo_loading_region:   "Black Sea"
        vessel_dwt:             25000
        vessel_category:        "H"  # ❗ ДОБАВЛЕНО
        cargo_type:             "wheat"
        month:                  9   # сентябрь, пик зернового сезона

      reasoning: |
        1) Region pair:
           from_region = "Libya"
           to_region   = "Black Sea"
           → используем black_sea_to_libya

           size_rule (handy_plus):
             vessel_categories: ["H", "SS", "SM", "PM"]
             score_impact: +25
           → base_pattern_score = 25 * (15/25) = 15

        2) Сезонность:
           month = 9 → входит в black_sea_grain_season.active_months
           → seasonal_adjustment ≈ +25 * (15/25) = +15 (но общий максимум 15, поэтому по сути усиливает уверенность)

        3) Port economics:
           loading_port_entry = odessa_ukraine
           scoring_modifiers.vessels_in_black_sea / mediterranean / atlantic
           (для Libya отдельного модификатора может не быть → port_modifier = 0)

        4) Комбинация:
           raw_score ≈ 15 + 15 + 0 = 30 → clamp до 15

      expected_final_score: 15
      comment: "Очень сильный паттерн: судно в Ливии, груз в Черном море в зерновой сезон"

    - name: "Atlantic small vessel → Black Sea grain off-season"
      input:
        vessel_location_region: "Atlantic"
        cargo_loading_region:   "Black Sea"
        vessel_dwt:             6000
        vessel_category:        "C"  # ❗ ДОБАВЛЕНО
        cargo_type:             "wheat"
        month:                  3   # март, не пик

      reasoning: |
        1) Region pair:
           from_region = "Atlantic"
           to_region   = "Black Sea"
           → atlantic_to_black_sea

           size_rule (small_vessels/coasters):
             vessel_categories: ["SC", "C", "SH"]
             score_impact: +8
           → base_pattern_score = 8 * (15/25) = 4.8

        2) Сезонность:
           month = 3 → не в peak_grain_season
           → seasonal_adjustment ≈ 0 (или небольшой штраф, если решим)

        3) Port economics:
           loading_port_entry = odessa_ukraine
           scoring_modifiers.vessels_in_atlantic: +5
           → port_modifier = +5 * (15/25) = +3

        4) Комбинация:
           raw_score = 4.8 + 0 + 3 = 7.8 → final_score = 8

      expected_final_score: 8
      comment: "Сценарий экономически возможен, но не идеальный: маленькое судно, длинный балласт, не пик сезона"


COMMENTS_PROCESSING_GUIDE

SHORT SUMMARY

This document defines how AI must read, interpret, and apply comments from Companies, Vessels, and Persons during scoring and offer/message generation.

The comments contain expert, non-structured knowledge:
– cargo preferences,
– geographic restrictions,
– intake data,
– technical limitations,
– behavioral and communication notes.

AI must extract structured meaning from unstructured comments, filter them by relevance to the current cargo, resolve contradictions, and incorporate them into:

Regional scoring

Cargo scoring

Intake evaluation

Offer text reasoning

Communication tone and formatting

The guide also defines keyword detection patterns, priority order (vessel > person > company), parsing rules, and examples for every scoring criterion.

HOW TO USE THIS DOCUMENT (INSTRUCTIONS)

Feed all three comment blocks to AI

company_comments

vessel_comments

person_comments

AI must parse them into structured meaning
Use the keyword groups defined in the document:

specialization

geographic preferences

cargo preferences

technical info

behavioral notes

Filter only relevant parts
AI should keep only the parts that match:

ports / countries / regions of this cargo

cargo type

draft / gear needs

communication style for messaging

Resolve conflicts using defined priority:

Vessel comments

Person comments

Company comments

Formal preferences from UI
AI must mention the conflict in reasoning if necessary.

Apply extracted info to scoring

Regional preferences → regional scoring

Cargo preferences → cargo scoring

Intake comments → override calculated intake

Technical limits → adjust feasibility

Behavioral info → message personalization

Apply comments to offer text generation

Highlight good matches (“You specialize in Black Sea grains…”)

Address concerns (“I know you avoid Egypt routes…”)

Mention technical readiness (“Your gear is suitable…”)

Adjust communication tone (“Prefers short messages, WhatsApp…”)

Include comment summary in AI prompt
Use the template block from the document under PROMPT ADDITIONS.

# ═══════════════════════════════════════════════════════════════════
# COMMENTS PROCESSING GUIDE
# VK Charts AI Scoring System - Extension
# ═══════════════════════════════════════════════════════════════════
#
# Как AI должен обрабатывать и использовать comments из карточек
# компании и судна при scoring и генерации текстов
#
# ═══════════════════════════════════════════════════════════════════

version: "1.0"
date: "2024-11-28"
priority: "CRITICAL - Комментарии содержат ключевую экспертную информацию"

# ═══════════════════════════════════════════════════════════════════
# OVERVIEW
# ═══════════════════════════════════════════════════════════════════

purpose: |
  Company comments и Vessel comments содержат экспертные знания о:
  - Предпочтениях и специализации
  - Ограничениях и проблемах
  - Особенностях работы
  - Историческом поведении
  - Технических деталях
  
  AI ОБЯЗАН учитывать эти комментарии при:
  - Scoring по всем критериям
  - Генерации offer texts
  - Оценке compatibility
  - Формулировании reasoning

# ═══════════════════════════════════════════════════════════════════
# DATA SOURCES
# ═══════════════════════════════════════════════════════════════════

data_sources:
  
  company_comments:
    database_field: "companies.comments"
    example: "spec: turkish domestic cargoes, Italy ok, greece ok, eu ok, cvb ok, continent ok"
    
    typical_content:
      - "Specialization patterns"
      - "Geographic preferences"
      - "Cargo type preferences"
      - "Communication preferences"
      - "Payment history"
      - "Reliability notes"
      - "Special requirements"
      
  vessel_comments:
    database_field: "vessels.comments"
    example: "Real intake: Corn, draft 7m, Izmail = 4800t"
    
    typical_content:
      - "Technical specifications"
      - "Performance data"
      - "Intake records"
      - "Port restrictions"
      - "Maintenance issues"
      - "Crew information"
      - "Historical behavior"
      
  person_comments:
    database_field: "people.comments"
    example: "Prefers WhatsApp communication, responds within 1 hour"
    
    typical_content:
      - "Communication style"
      - "Response patterns"
      - "Decision-making authority"
      - "Language preferences"
      - "Time zone considerations"

# ═══════════════════════════════════════════════════════════════════
# PARSING STRATEGY
# ═══════════════════════════════════════════════════════════════════

parsing_strategy:
  
  principle: "Extract structured information from unstructured text"
  
  step_1_keyword_detection:
    description: "Identify key patterns and keywords"
    
    patterns:
      
      specialization:
        keywords: ["spec:", "specializes", "mainly", "mostly"]
        examples:
          - "spec: turkish domestic cargoes"
          - "specializes in grain trades"
          - "mainly works Black Sea"
          
      geographic_preferences:
        keywords: ["ok", "no", "cannot", "avoids", "prefers"]
        examples:
          - "Italy ok, greece ok, eu ok"
          - "no Egypt"
          - "cannot work Libya"
          - "avoids Turkey"
          
      cargo_preferences:
        keywords: ["cargo:", "loads", "carries", "no bulk"]
        examples:
          - "cargo: grain only"
          - "loads steel products"
          - "no bulk fertilizers"
          
      technical_info:
        keywords: ["intake:", "draft", "gear", "speed"]
        examples:
          - "Real intake: Wheat 5200t"
          - "draft restricted to 7m"
          - "geared vessel"
          
      behavioral_notes:
        keywords: ["always", "never", "typically", "usually"]
        examples:
          - "always asks for freight first"
          - "never responds weekends"
          - "typically ballasts to Black Sea"
          
  step_2_relevance_filtering:
    description: "Extract only information relevant to current cargo"
    
    relevance_rules:
      geographic:
        - "If comment mentions cargo loading/discharge region → RELEVANT"
        - "If comment mentions country → RELEVANT"
        - "If general restriction → RELEVANT"
        
      cargo_type:
        - "If comment mentions cargo type → RELEVANT"
        - "If comment about capacity → RELEVANT"
        - "If technical restrictions → RELEVANT"
        
      communication:
        - "Always relevant for offer text generation"
        
  step_3_conflict_resolution:
    description: "Handle contradictions between sources"
    
    priority_order:
      1: "Vessel comments (most specific)"
      2: "Person comments (behavioral patterns)"
      3: "Company comments (general policies)"
      4: "Formal preferences (UI settings)"
      
    example_conflict:
      scenario:
        company_comment: "spec: turkish domestic cargoes"
        vessel_settings: "Specializes: Black Sea international"
        
      resolution:
        selected: "Vessel settings (formal)"
        but_mention: "Note company comment in reasoning"
        explanation: "Formal settings override, but acknowledge pattern"

# ═══════════════════════════════════════════════════════════════════
# INTEGRATION WITH SCORING CRITERIA
# ═══════════════════════════════════════════════════════════════════

integration_by_criterion:
  
  # ─────────────────────────────────────────────────────────────────
  # CRITERION 2: REGIONAL PREFERENCES
  # ─────────────────────────────────────────────────────────────────
  
  criterion_2_regional:
    
    comment_impact: "HIGH - Direct geographic information"
    
    parsing_examples:
      
      example_1:
        comment: "spec: turkish domestic cargoes, Italy ok, greece ok, eu ok, cvb ok, continent ok"
        
        extracted:
          specializes:
            - "Turkey domestic"
            
          acceptable:
            - "Italy"
            - "Greece"
            - "EU"
            - "CVB (Constanta-Varna-Burgas)"
            - "Continent (North Europe)"
            
          not_mentioned:
            - "Egypt"
            - "Libya"
            - "Far East"
            
        scoring_impact:
          if_cargo_turkey: "+15 (specializes)"
          if_cargo_italy: "+10 (ok)"
          if_cargo_greece: "+10 (ok)"
          if_cargo_egypt: "0 (not mentioned, neutral)"
          if_cargo_libya: "0 (not mentioned, neutral)"
          
      example_2:
        comment: "no Egypt, Libya ok but slow response, Black Sea excellent"
        
        extracted:
          cannot_work:
            - "Egypt"
            
          acceptable_with_notes:
            - "Libya (but owner slow to respond)"
            
          excellent:
            - "Black Sea"
            
        scoring_impact:
          if_cargo_egypt: "-35 (cannot work)"
          if_cargo_libya: "+5 (ok but flag communication issue)"
          if_cargo_black_sea: "+20 (excellent)"
          
      example_3:
        comment: "Turkish flag, cannot call Ukrainian ports due to current restrictions"
        
        extracted:
          geopolitical_restriction:
            - "Turkish flag"
            - "Cannot call Ukraine"
            
        scoring_impact:
          if_cargo_ukraine: "-50 (IMPOSSIBLE due to flag restriction)"
          offer_text: "SKIP - Do not send offer for Ukrainian ports"
          
  # ─────────────────────────────────────────────────────────────────
  # CRITERION 3: CARGO PREFERENCES
  # ─────────────────────────────────────────────────────────────────
  
  criterion_3_cargo:
    
    comment_impact: "HIGH - Direct cargo type information"
    
    parsing_examples:
      
      example_1:
        comment: "grain only, no fertilizers, steel ok occasionally"
        
        extracted:
          specializes:
            - "Grain"
            
          cannot_work:
            - "Fertilizers"
            
          occasional:
            - "Steel products"
            
        scoring_impact:
          if_cargo_wheat: "+18 (grain only = strong preference)"
          if_cargo_fertilizers: "-30 (no fertilizers)"
          if_cargo_steel: "+5 (ok occasionally = lukewarm)"
          
      example_2:
        comment: "coils require special dunnage, bagged cargoes preferred"
        
        extracted:
          technical_requirement:
            - "Coils need dunnage"
            
          preference:
            - "Bagged cargoes preferred"
            
        scoring_impact:
          if_cargo_coils: "+0 but NOTE in offer: 'Are you equipped with dunnage?'"
          if_cargo_bagged_wheat: "+12 (preferred)"
          
  # ─────────────────────────────────────────────────────────────────
  # CRITERION 4: LAST PORTS
  # ─────────────────────────────────────────────────────────────────
  
  criterion_4_lastports:
    
    comment_impact: "MEDIUM - Context for statistics"
    
    parsing_examples:
      
      example_1:
        comment: "historically worked Egypt routes, but stopped since 2023"
        statistics: "Egypt: 45 visits (15%)"
        
        interpretation:
          statistics_show: "High familiarity (15%)"
          comment_reveals: "Pattern changed recently"
          
        scoring_impact:
          base_score: "+12 (high historical familiarity)"
          adjustment: "-7 (but stopped working there)"
          final: "+5 (acknowledge history but recent avoidance)"
          
      example_2:
        comment: "new vessel, using company patterns"
        statistics: "No vessel history"
        
        interpretation:
          fallback: "Use company-level statistics"
          
        scoring_impact:
          use_company_stats: true
          note_in_text: "Vessel is new but company knows the route well"
          
  # ─────────────────────────────────────────────────────────────────
  # CRITERION 5: INTAKE
  # ─────────────────────────────────────────────────────────────────
  
  criterion_5_intake:
    
    comment_impact: "CRITICAL - Manual intake overrides calculation"
    
    parsing_examples:
      
      example_1:
        comment: "Real intake: Corn, draft 7m, Izmail = 4800t"
        cargo: "Wheat 5000t, Izmail → Egypt"
        
        parsing:
          regex: "Real intake:\\s*(\\w+),\\s*draft\\s*([\\d.]+)m,\\s*(\\w+)\\s*=\\s*(\\d+)t"
          extract:
            cargo_match: "Corn" (similar to Wheat - grain)
            draft: "7m"
            port_match: "Izmail" (EXACT match)
            intake: "4800t"
            
        scoring_impact:
          use_manual: true
          intake_value: 4800
          vs_cargo: 5000
          fit: "tight" (4800 < 5000)
          score: "-10 (insufficient capacity)"
          
      example_2:
        comment: "Shallow draft, max 6.5m in fresh water"
        port: "Izmail (freshwater, 7m limit)"
        
        interpretation:
          port_allows: "7m"
          vessel_max: "6.5m"
          restriction: "Vessel draft more restrictive than port"
          
        scoring_impact:
          recalculate: "Use 6.5m as effective draft limit"
          note: "Vessel has tighter draft restriction than port"

# ═══════════════════════════════════════════════════════════════════
# OFFER TEXT GENERATION WITH COMMENTS
# ═══════════════════════════════════════════════════════════════════

offer_text_integration:
  
  principle: "Use comments to personalize and strengthen offer"
  
  techniques:
    
    acknowledge_specialization:
      comment: "spec: turkish domestic cargoes, Italy ok"
      cargo: "Turkey → Italy"
      
      offer_text: |
        "I know you specialize in Turkish domestic trades and also
         work Italy routes - this cargo is right in your wheelhouse."
         
    address_concerns:
      comment: "slow payers in Egypt, prefer advance payment"
      cargo: "Discharge Egypt"
      
      offer_text: |
        "I understand you prefer advance payment arrangements.
         This charterer has good payment record and can discuss terms."
         
    highlight_fit:
      comment: "grain only, no fertilizers"
      cargo: "Wheat"
      
      offer_text: |
        "Pure grain cargo - exactly what your vessel is specialized for."
        
    technical_confirmation:
      comment: "geared vessel, can handle bagged cargoes"
      cargo: "Bagged wheat"
      
      offer_text: |
        "Bagged cargo needs vessel's gear - you're equipped for this."
        
    avoid_mismatch:
      comment: "no Egypt"
      cargo: "Discharge Egypt"
      
      offer_text: |
        "I know you typically don't work Egypt routes, but wanted to
         check if anything has changed or if this particular cargo
         might be interesting given [strong point]."

# ═══════════════════════════════════════════════════════════════════
# AI PROMPT ADDITIONS
# ═══════════════════════════════════════════════════════════════════

prompt_template_addition:
  
  section: |
    ═══════════════════════════════════════════════════════════════
    EXPERT COMMENTS AND NOTES
    ═══════════════════════════════════════════════════════════════
    
    Company Comments:
    {company_comments}
    
    Vessel Comments:
    {vessel_comments}
    
    Person Comments:
    {person_comments}
    
    ---
    
    IMPORTANT: These comments contain expert knowledge from past
    interactions and manual observations. Extract and apply ONLY
    the information RELEVANT to current cargo:
    
    1. Geographic preferences → Regional scoring
    2. Cargo preferences → Cargo type scoring
    3. Technical specs → Intake calculation
    4. Behavioral patterns → Offer text tone
    5. Communication style → Message formatting
    
    If comment contradicts formal settings, mention both but
    prioritize formal settings for scoring. Use comments to
    add context and nuance to explanations.

# ═══════════════════════════════════════════════════════════════════
# EXAMPLES OF COMMENT PROCESSING
# ═══════════════════════════════════════════════════════════════════

processing_examples:
  
  # ─────────────────────────────────────────────────────────────────
  # EXAMPLE 1: FULL PARSING
  # ─────────────────────────────────────────────────────────────────
  
  example_1_imamoglu:
    
    raw_data:
      company_comment: "spec: turkish domestic cargoes, Italy ok, greece ok, eu ok, cvb ok, continent ok"
      vessel_comment: null
      person_comment: null
      
    cargo:
      type: "Wheat"
      load: "Izmail, Ukraine"
      discharge: "Egypt Mediterranean"
      
    parsing_output:
      
      specialization:
        primary: "Turkish domestic cargoes"
        relevance_to_cargo: "NOT RELEVANT (cargo is Ukraine → Egypt)"
        
      acceptable_regions:
        - region: "Italy"
          relevance: "NOT RELEVANT"
        - region: "Greece"
          relevance: "NOT RELEVANT"
        - region: "EU"
          relevance: "NOT RELEVANT"
        - region: "CVB (Constanta-Varna-Burgas)"
          relevance: "PARTIALLY RELEVANT (loading area nearby)"
        - region: "Continent (North Europe)"
          relevance: "NOT RELEVANT"
          
      not_mentioned:
        - region: "Ukraine"
          interpretation: "No explicit preference"
        - region: "Egypt"
          interpretation: "No explicit preference"
        - region: "Black Sea"
          interpretation: "No explicit preference"
          
    scoring_impact:
      
      regional_preferences:
        base_score: 10  # Neutral (no strong match)
        reasoning: |
          "Company specializes in Turkish domestic trades, which is
           not relevant to this cargo. Loading from Ukraine and
           discharging in Egypt are not mentioned in their typical
           areas. CVB region (nearby) is listed as 'ok', suggesting
           vessel can work broader Black Sea area.
           
           Score: 10/20 (neutral - not their specialty but acceptable)"
           
      offer_text_adjustment: |
        "I know you primarily work Turkish domestic cargoes, but this
         Black Sea to Med route is adjacent to your CVB operations
         and might be interesting given..."
         
  # ─────────────────────────────────────────────────────────────────
  # EXAMPLE 2: INTAKE FROM COMMENTS
  # ─────────────────────────────────────────────────────────────────
  
  example_2_manual_intake:
    
    raw_data:
      vessel_comment: "Real intake: Wheat 5200t, Odessa summer. Real intake: Corn, draft 7m, Izmail = 4800t"
      
    cargo:
      type: "Wheat"
      quantity: 5000
      load: "Izmail"
      
    parsing_output:
      
      intakes_found:
        - intake_1:
            cargo: "Wheat"
            quantity: 5200
            port: "Odessa"
            conditions: "summer"
            match_quality: "PARTIAL (same cargo type, different port)"
            
        - intake_2:
            cargo: "Corn"
            quantity: 4800
            draft: "7m"
            port: "Izmail"
            match_quality: "GOOD (same port, similar cargo - grain)"
            
      selected_intake:
        value: 4800
        source: "intake_2"
        reason: "Better port match (Izmail), grain cargo similar"
        
    scoring_impact:
      
      intake_assessment:
        vessel_capacity: 4800
        cargo_requirement: 5000
        ratio: 0.96  # 4800/5000
        category: "tight_fit"
        score: "-10 (insufficient by 200t)"
        
        reasoning: |
          "Based on manual intake record, vessel loaded 4800t of corn
           in Izmail at 7m draft. Current cargo requires 5000t wheat.
           This is a tight fit with 4% shortfall.
           
           Options:
           1. Request cargo reduction to 4800t
           2. Verify if wheat stowage allows slightly higher intake
           3. Check if summer draft allows more
           
           Score: 10/20 (tight capacity)"
           
  # ─────────────────────────────────────────────────────────────────
  # EXAMPLE 3: COMMUNICATION STYLE
  # ─────────────────────────────────────────────────────────────────
  
  example_3_communication:
    
    raw_data:
      person_comment: "Prefers WhatsApp, responds quickly during Turkish business hours, speaks English but prefers short messages"
      
    offer_adjustments:
      
      channel_priority:
        primary: "WhatsApp"
        secondary: "Email"
        
      message_style:
        length: "Short, concise"
        language: "Simple English"
        timing: "Turkish business hours (GMT+3)"
        
      offer_text_whatsapp: |
        "Hi Birol! 👋
        
        Got wheat cargo for NECIBE IMAMOGLU:
        🌾 6500t Wheat
        📍 Izmail → Egypt Med
        📅 December
        
        Your vessel in Marmara - good position!
        
        Interested? What's your freight idea?
        
        /Vitaly"
        
      offer_text_email: |
        Subject: Wheat 6500t Izmail-Egypt | NECIBE IMAMOGLU | Dec
        
        Hi Birol,
        
        Quick cargo offer for NECIBE IMAMOGLU:
        
        - 6,500t Wheat
        - Izmail → Egypt Med
        - December laycan
        
        Vessel's current Marmara position works well.
        
        Let me know if interested and your freight idea.
        
        Thanks,
        Vitaly

# ═══════════════════════════════════════════════════════════════════
# EDGE CASES
# ═══════════════════════════════════════════════════════════════════

edge_cases:
  
  contradictory_comments:
    scenario:
      company: "no Egypt"
      vessel: "Egypt ok if good rate"
      
    resolution:
      priority: "Vessel comment (more specific)"
      score_impact: "-15 (company policy) + 10 (vessel exception) = -5"
      reasoning: "Company generally avoids Egypt, but this vessel willing if rate is good"
      offer_text: "I know company typically doesn't work Egypt, but understand your vessel makes exceptions for good rates. This cargo pays well..."
      
  outdated_comments:
    scenario:
      comment: "no Libya (date: 2022-06-15)"
      current_date: "2024-11-28"
      
    resolution:
      approach: "Mention but verify"
      score_impact: "-20 (historical avoidance)"
      offer_text: "I see from past notes you avoided Libya routes, but that was 2+ years ago. Has policy changed? This cargo might be worth reconsidering..."
      
  ambiguous_comments:
    scenario:
      comment: "ok sometimes"
      
    resolution:
      interpretation: "Neutral to slightly positive"
      score_impact: "+5 (lukewarm acceptance)"
      ai_note: "Comment is vague - treat as neutral with slight positive bias"
      
  multiple_comments:
    scenario:
      comments: "grain only; no fertilizers; steel ok; marble occasionally; cement yes"
      
    resolution:
      parse_all: true
      create_list:
        specializes: ["grain", "cement"]
        acceptable: ["steel"]
        occasional: ["marble"]
        cannot_work: ["fertilizers"]

# ═══════════════════════════════════════════════════════════════════
# IMPLEMENTATION CHECKLIST
# ═══════════════════════════════════════════════════════════════════

implementation:
  
  laravel_service:
    class: "CommentProcessorService"
    
    methods:
      - parseComments(string $comments): array
      - extractRelevantInfo(array $parsed, Cargo $cargo): array
      - applyToScoring(array $info, array $scores): array
      - generateOfferAdjustments(array $info): string
      
  ai_prompt_builder:
    additions:
      - "Include ALL comments in prompt"
      - "Add instruction to extract relevant info"
      - "Emphasize comment priority over generic rules"
      - "Request explanation of how comments influenced score"
      
  validation:
    tests:
      - "Parse complex multi-region comments"
      - "Handle contradictory information"
      - "Extract intake data correctly"
      - "Apply relevance filtering"
      
# ═══════════════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════════════

summary:
  
  key_principles:
    1: "Comments contain expert knowledge - ALWAYS consider"
    2: "Extract ONLY relevant information for current cargo"
    3: "Vessel comments > Person comments > Company comments > Formal settings"
    4: "Use comments to personalize offer texts"
    5: "When in doubt, mention comment in reasoning"
    
  ai_responsibilities:
    - "Parse unstructured text intelligently"
    - "Filter for relevance"
    - "Resolve conflicts logically"
    - "Apply to scoring with explanation"
    - "Incorporate into offer text naturally"
    
  quality_indicators:
    good_processing:
      - "AI mentions relevant comment in reasoning"
      - "Scoring adjusted based on comment"
      - "Offer text acknowledges comment info"
      
    poor_processing:
      - "AI ignores available comments"
      - "Uses comment info that's not relevant"
      - "Contradicts comment without explanation"


intake_calculator_formula

Short Summary — Intake Calculator Formula

This file defines the official VK Charts formula for calculating a vessel’s maximum cargo intake, taking into account:

Port draft limits

Water density (fresh / brackish / sea)

Under Keel Clearance (UKC)

Squat

Hydrostatic properties (Lpp, TPC, displacement)

Bunkers & stores (ROB)

Cargo stowage factor (SF)

Volume limitations (grain space)

Loading vs discharge port limitations

Manual overrides from vessel comments

It is the authoritative logic behind Criterion 4 – Intake in the VK Charts scoring system (VC-149).
This document contains the full step-by-step workflow, formulas, the original Excel LET formula, examples, error handling rules, and integration guidelines.

▶️ How to Use — Short Instructions
1. Gather all required inputs

From vessel database:

DWT, T_summer, Lpp or LOA, Beam, Grain_m³, Vessel type

From port restrictions:

Port draft limit

Water type / water density

From cargo:

Stowage factor (SF)

If any critical data is missing → return ERROR and skip intake scoring.

2. Calculate hydrostatic parameters

AI follows the formulas in the file to compute:

Lpp_used

CWP (bulk vs non-bulk rule)

TPC_salt

TPC_rho

Summer displacement (Δ_summer)

FWA / DWA (water density corrections)

The AI should copy this logic exactly.

3. Determine allowable draft in port

AI calculates:

T_allow = port_limit − UKC − SQUAT

T_allow_SW = corrected for water density

dT (draft reduction needed)

Loss_t (tonnage lost)

4. Compute weight-limited intake

AI calculates:

Available DWT after draft reduction

Minus ROB (4% of DWT)

Result = Intake_weight

5. Compute volume-limited intake (if applicable)

If grain_m³ and SF exist:

Convert SF to m³/t

Intake_volume = grain_m³ / SF

Final intake = min(weight, volume)

If cargo is heavy → weight-limited.
If cargo is light → volume-limited.

6. If two ports (load + discharge) are known

AI must:

Calculate intake for loading port

Calculate intake for discharge port

Take the minimum

Use this as the final intake value

7. Manual intake overrides

If vessel comments contain patterns like:

Real intake: Wheat, draft 7m, Izmail = 4800t


Then:

AI must use manual intake as highest priority

If manual intake does not match the current cargo/port → ignore

If matched → override all formulas

8. Output for scoring

AI must produce:

"intake_final": <tonnes>,
"limiting_factor": "weight" | "volume" | "port restriction",
"supports_cargo": true/false,
"intake_score": <score impact based on ratio>

9. Apply scoring logic (Criterion 4)

Score depends on intake / cargo quantity ratio:

≥ 110% → perfect fit (0 penalty)

100–110% → exact fit (0 penalty)

95–100% → tight fit (−10)

< 95% → too small (−30)

150% → too large (−5)

10. Error handling

If critical data is missing (T_summer, T_port_limit, Beam, LOA/Lpp):

AI must output:

Intake: UNKNOWN
Reason: Missing critical data
Require: Manual review


Scoring for intake is skipped.

# ═══════════════════════════════════════════════════════════════════
# INTAKE CALCULATOR FORMULA
# VK Charts AI Scoring System - Criterion 4 (VC-149)
# ═══════════════════════════════════════════════════════════════════
#
# Формула расчета Intake (загрузочной способности) судна
# С учетом ограничений порта, плотности воды, и cargo stowage factor
#
# ═══════════════════════════════════════════════════════════════════

version: "1.0"
last_updated: "2024-11-28"
source: "Vitaly + Excel LET formula"
jira_task: "VC-149"

# ═══════════════════════════════════════════════════════════════════
# OVERVIEW
# ═══════════════════════════════════════════════════════════════════

calculator_purpose: |
  Calculate vessel's maximum cargo intake for specific:
  - Port (with draft restrictions)
  - Cargo type (with stowage factor)
  - Water type (sea/fresh/brackish density)
  
  Takes into account:
  - Vessel hydrostatic characteristics
  - Port draft limitations
  - Water density effects (saltwater allowance)
  - Under Keel Clearance (UKC)
  - Squat
  - Bunkers & stores (ROB)
  - Cargo volume vs weight limitations

# ═══════════════════════════════════════════════════════════════════
# INPUT PARAMETERS
# ═══════════════════════════════════════════════════════════════════

inputs:
  
  from_vessel_database:
    marineman_data:
      - field: "DWT"
        description: "Deadweight tonnage"
        unit: "metric tons"
        required: true
        alternative: "Can calculate from T_summer if missing"
        
      - field: "T_summer"
        description: "Summer draft"
        unit: "meters"
        required: true
        note: "CRITICAL - cannot calculate without this"
        
      - field: "Lpp"
        description: "Length between perpendiculars"
        unit: "meters"
        required: false
        fallback: "Calculate from LOA: 0.965*LOA (bulk) or 0.97*LOA (other)"
        
      - field: "LOA"
        description: "Length overall"
        unit: "meters"
        required: true
        note: "If Lpp is missing"
        
      - field: "B"
        description: "Beam (width)"
        unit: "meters"
        required: true
        
      - field: "Grain_m3"
        description: "Grain cubic capacity"
        unit: "cubic meters"
        required: false
        note: "For volume-limited cargoes"
        
      - field: "VslType"
        description: "Vessel type"
        examples: ["Bulk carrier", "General cargo", "Multi-purpose"]
        note: "Used to determine CWP coefficient"
  
  from_port_restrictions:
    - field: "T_port_limit"
      description: "Port maximum draft restriction"
      unit: "meters"
      required: true
      source: "port_restrictions_map.yaml"
      
    - field: "WaterType"
      description: "Water type or density"
      options:
        - "sea" / "salt" / "морская" → 1.025
        - "fresh" / "пресная" → 1.000
        - "brackish" / "солоноватая" → 1.010
        - or direct number (e.g., 1.015)
      required: true
      
  from_cargo:
    - field: "SF_ft3_per_mt"
      description: "Stowage factor"
      unit: "cubic feet per metric ton"
      required: false
      note: "If cargo is volume-limited (light cargo)"
      source: "Airtable cargo library"

# ═══════════════════════════════════════════════════════════════════
# CONSTANTS & COEFFICIENTS
# ═══════════════════════════════════════════════════════════════════

constants:
  
  UKC:
    value: 0.30
    unit: "meters"
    description: "Under Keel Clearance"
    note: "Safety margin below keel"
    
  SQUAT:
    value: 0.10
    unit: "meters"
    description: "Squat allowance"
    note: "Vessel sinks deeper when moving (dynamic effect)"
    
  ROB_PCT:
    value: 0.04
    description: "Bunkers & stores percentage"
    note: "4% of DWT reserved for fuel, water, stores"
    
  CWP:
    description: "Coefficient of waterplane area"
    values:
      bulk_carriers: 0.87
      other_vessels: 0.80
    logic: |
      IF vessel type contains "bulk" OR DWT > 20000:
        CWP = 0.87
      ELSE:
        CWP = 0.80
        
  water_density:
    sea_salt: 1.025
    fresh: 1.000
    brackish: 1.010

# ═══════════════════════════════════════════════════════════════════
# CALCULATION STEPS
# ═══════════════════════════════════════════════════════════════════

calculation_workflow:
  
  step_1_validate_inputs:
    description: "Check if critical data is available"
    
    critical_fields:
      - B (Beam)
      - T_port_limit (Port draft restriction)
      - WaterType (or density)
      - Lpp or LOA
      - T_summer (Summer draft)
      - DWT or ability to calculate it
      
    error_handling:
      if_missing: "Return ERROR message to user"
      message: "Cannot calculate intake - missing critical data"
      
  step_2_calculate_lpp:
    description: "Determine Lpp if not provided"
    
    logic: |
      IF Lpp exists:
        Lpp_used = Lpp
      ELSE IF LOA exists:
        IF (vessel is bulk OR DWT > 20000):
          Lpp_used = 0.965 * LOA
        ELSE:
          Lpp_used = 0.97 * LOA
      ELSE:
        ERROR - no length data
        
  step_3_determine_water_density:
    description: "Get water density from WaterType"
    
    logic: |
      IF WaterType is number:
        rho = WaterType
      ELSE:
        SWITCH WaterType:
          "sea", "salt", "морская" → rho = 1.025
          "fresh", "пресная" → rho = 1.000
          "brackish", "солоноватая" → rho = 1.010
          
  step_4_hydrostatic_calculations:
    description: "Calculate TPC and displacement"
    
    formulas:
      TPC_salt:
        formula: "0.01025 × CWP × Lpp_used × B"
        description: "Tonnes per centimeter immersion in saltwater"
        unit: "tonnes/cm"
        
      TPC_rho:
        formula: "TPC_salt × (rho / 1.025)"
        description: "TPC adjusted for actual water density"
        
      Delta_summer:
        formula: |
          IF DWT exists:
            Delta_summer = DWT / 0.70
          ELSE:
            Delta_summer = 1.025 × Lpp_used × B × T_summer × 0.74
        description: "Summer displacement (vessel weight at summer draft)"
        unit: "tonnes"
        
  step_5_draft_allowances:
    description: "Calculate saltwater/freshwater allowances"
    
    formulas:
      FWA_cm:
        formula: "Delta_summer / (4 × TPC_salt)"
        description: "Fresh Water Allowance in cm"
        note: "How much draft increases in freshwater vs saltwater"
        
      DWA_cm:
        formula: "FWA_cm × ((1.025 - rho) / 0.025)"
        description: "Dock Water Allowance"
        note: "Adjustment for actual water density vs saltwater"
        
  step_6_allowable_draft:
    description: "Calculate maximum usable draft in port"
    
    formulas:
      T_allow:
        formula: "T_port_limit - UKC - SQUAT"
        description: "Allowable draft with safety margins"
        note: "What draft we can actually use"
        
      T_allow_SW:
        formula: "T_allow - DWA_cm / 100"
        description: "Allowable draft adjusted to saltwater equivalent"
        
  step_7_draft_limitation:
    description: "Calculate weight loss due to draft restriction"
    
    formulas:
      dT:
        formula: "MAX(0, T_summer - T_allow_SW)"
        description: "Draft reduction required"
        note: "How much we must reduce draft to enter port"
        
      Loss_t:
        formula: "TPC_rho × 100 × dT"
        description: "Weight loss in tonnes"
        note: "Cargo we cannot load due to draft restriction"
        
  step_8_weight_limited_intake:
    description: "Calculate intake limited by weight/draft"
    
    formulas:
      DWT_base:
        formula: |
          IF DWT exists:
            DWT_base = DWT
          ELSE:
            DWT_base = 0.70 × Delta_summer
            
      DWT_allow:
        formula: "MAX(0, DWT_base - Loss_t)"
        description: "Deadweight available after draft restriction"
        
      ROB_t:
        formula: "ROB_PCT × DWT_base"
        description: "Bunkers & stores weight"
        note: "4% of DWT reserved"
        
      Intake_weight:
        formula: "MAX(0, DWT_allow - ROB_t)"
        description: "Maximum cargo by weight"
        
  step_9_volume_limitation:
    description: "Check if cargo is volume-limited"
    
    logic: |
      IF Grain_m3 exists AND SF_m3_per_t exists:
        Convert SF from ft³/mt to m³/t:
        SF_m3_per_t = SF_ft3_per_mt / 35.3147
        
        Calculate volume-limited intake:
        Intake_volume = Grain_m3 / SF_m3_per_t
        
        Take minimum of weight and volume:
        Intake_final = MIN(Intake_weight, Intake_volume)
      ELSE:
        Intake_final = Intake_weight
        
  step_10_final_result:
    description: "Return final intake value"
    
    output:
      value: "Intake_final"
      unit: "metric tons"
      note: "Maximum loadable cargo quantity"

# ═══════════════════════════════════════════════════════════════════
# EXCEL LET FORMULA (ORIGINAL)
# ═══════════════════════════════════════════════════════════════════

excel_formula: |
  =LET(
    /* === ВХОД ИЗ ТВОЕЙ БД === */
    DWT;               'Marineman -> Deadweight (DWT)';
    T_summer;          'Marineman -> Draft';
    Lpp;               'Marineman -> Length (BP)';
    LOA;               'Marineman -> Length overall';
    B;                 'Marineman -> Beam';
    Grain_m3;          'Marineman -> Grain capacity';
    VslType;           'Marineman -> Vessel type';

    T_port_limit;      'Port -> Draft limit (m)';
    WaterType;         'Port -> Water type';

    /* === CARGO SF (в кубических футах на метрическую тонну) === */
    SF_ft3_per_mt;     'Cargo -> Stowage factor (ft3/mt)';

    /* === НАСТРОЙКИ === */
    UKC;               0.30;
    SQUAT;             0.10;
    ROB_PCT;           0.04;

    /* CWP по типу/размеру */
    IsBulk;            IFERROR( SEARCH("bulk"; LOWER(TEXT(VslType;"@"))); )>0;
    CWP;               IF( OR( IsBulk; (ISNUMBER(DWT)*(DWT>20000)) ); 0.87; 0.80 );

    /* Lpp по умолчанию, если нет Lpp — из LOA */
    Lpp_used;          IF( ISNUMBER(Lpp);
                           Lpp;
                           IF( ISNUMBER(LOA);
                               IF( OR(IsBulk; (ISNUMBER(DWT)*(DWT>20000)) ); 0.965*LOA; 0.97*LOA );
                               NA()
                           )
                         );

    /* Плотность воды */
    rho;               IF( ISNUMBER(WaterType);
                          WaterType;
                          SWITCH( LOWER(TEXT(WaterType;"@"));
                            "sea";1.025; "salt";1.025; "морская";1.025;
                            "fresh";1.000; "пресная";1.000;
                            "brackish";1.010; "солоноватая";1.010;
                            NA()
                          )
                        );

    /* Проверка критичных полей */
    missing;           OR(
                          NOT(ISNUMBER(B));
                          NOT(ISNUMBER(T_port_limit));
                          AND( NOT(ISNUMBER(DWT)); NOT(ISNUMBER(T_summer)) );
                          NOT(ISNUMBER(Lpp_used));
                          NOT(ISNUMBER(rho))
                        );
    IF( missing; "ERROR: отсутствуют критичные данные";

       /* === ГИДРОСТАТИКА === */
       TPC_salt;       0.01025 * CWP * Lpp_used * B;
       TPC_rho;        TPC_salt * (rho/1.025);

       Delta_summer;   IF( ISNUMBER(DWT);
                           DWT/0.70;
                           1.025 * Lpp_used * B * T_summer * 0.74
                         );

       FWA_cm;         Delta_summer / (4 * TPC_salt);
       DWA_cm;         FWA_cm * ((1.025 - rho)/0.025);

       T_allow;        T_port_limit - UKC - SQUAT;
       T_allow_SW;     T_allow - DWA_cm/100;

       Tsum;           IF( ISNUMBER(T_summer); T_summer; NA() );
       IF( NOT(ISNUMBER(Tsum));
           "ERROR: нет летней осадки";

           dT;             MAX(0; Tsum - T_allow_SW);
           Loss_t;         TPC_rho * 100 * dT;

           DWT_base;       IF( ISNUMBER(DWT); DWT; 0.70 * Delta_summer );
           DWT_allow;      MAX( 0; DWT_base - Loss_t );
           ROB_t;          ROB_PCT * DWT_base;
           Intake_weight;  MAX(0; DWT_allow - ROB_t);

           /* === SF: перевод в м³/т === */
           SF_m3_per_t;    IF( ISNUMBER(SF_ft3_per_mt); SF_ft3_per_mt / 35.3147; NA() );

           /* === Объёмный лимит === */
           Intake_final;   IF( AND(ISNUMBER(Grain_m3); ISNUMBER(SF_m3_per_t); SF_m3_per_t>0);
                               MIN( Intake_weight; Grain_m3 / SF_m3_per_t );
                               Intake_weight
                             );

           Intake_final
       )
    )
  )

# ═══════════════════════════════════════════════════════════════════
# CALCULATION EXAMPLES
# ═══════════════════════════════════════════════════════════════════

examples:
  
  example_1_weight_limited:
    description: "Heavy cargo, weight is limiting factor"
    
    inputs:
      vessel:
        name: "MV EXAMPLE"
        dwt: 52000
        t_summer: 9.8
        loa: 185
        lpp: null  # Will calculate from LOA
        beam: 28
        grain_m3: 65000
        vessel_type: "Bulk carrier"
        
      port:
        name: "Odessa"
        draft_limit: 9.5
        water_type: "sea"
        
      cargo:
        type: "Wheat"
        sf_ft3_per_mt: 47.0
        
    calculation:
      cwp: 0.87  # Bulk carrier
      lpp_used: 178.525  # 0.965 × 185
      rho: 1.025  # Seawater
      
      tpc_salt: 16.25  # 0.01025 × 0.87 × 178.525 × 28
      tpc_rho: 16.25  # Same as salt (rho = 1.025)
      
      delta_summer: 74286  # 52000 / 0.70
      fwa_cm: 1143  # 74286 / (4 × 16.25)
      dwa_cm: 0  # 1143 × ((1.025 - 1.025) / 0.025)
      
      t_allow: 9.1  # 9.5 - 0.3 - 0.1
      t_allow_sw: 9.1  # 9.1 - 0/100
      
      dt: 0.7  # MAX(0, 9.8 - 9.1)
      loss_t: 1137.5  # 16.25 × 100 × 0.7
      
      dwt_allow: 50862.5  # 52000 - 1137.5
      rob_t: 2080  # 0.04 × 52000
      intake_weight: 48782.5  # 50862.5 - 2080
      
      sf_m3_per_t: 1.331  # 47.0 / 35.3147
      intake_volume: 48836  # 65000 / 1.331
      
      intake_final: 48782.5  # MIN(48782.5, 48836)
      
    result:
      intake: 48782.5
      unit: "metric tons"
      limiting_factor: "weight (draft restriction)"
      note: "Vessel can load ~48,780 tons of wheat in Odessa"
      
  example_2_volume_limited:
    description: "Light cargo, volume is limiting factor"
    
    inputs:
      vessel:
        name: "MV COASTER"
        dwt: 7500
        t_summer: 6.2
        loa: 98
        beam: 16
        grain_m3: 9800
        vessel_type: "General cargo"
        
      port:
        name: "Izmail"
        draft_limit: 7.0  # No restriction
        water_type: "fresh"
        
      cargo:
        type: "Wood pellets"
        sf_ft3_per_mt: 70.0  # Light cargo!
        
    calculation:
      cwp: 0.80  # Not bulk, DWT < 20000
      lpp_used: 95.06  # 0.97 × 98
      rho: 1.000  # Freshwater
      
      # ... (similar steps)
      
      intake_weight: 6900  # After all deductions
      
      sf_m3_per_t: 1.982  # 70.0 / 35.3147
      intake_volume: 4943  # 9800 / 1.982
      
      intake_final: 4943  # MIN(6900, 4943)
      
    result:
      intake: 4943
      unit: "metric tons"
      limiting_factor: "volume (light cargo)"
      note: "Grain space fills up before reaching DWT"
      
  example_3_danube_restriction:
    description: "Severe draft restriction - Danube ports"
    
    inputs:
      vessel:
        name: "MV DANUBE"
        dwt: 8000
        t_summer: 8.5
        loa: 115
        beam: 14
        grain_m3: 10500
        
      port:
        name: "Reni"
        draft_limit: 7.0  # SEVERE restriction
        water_type: "fresh"
        
      cargo:
        type: "Wheat"
        sf_ft3_per_mt: 47.0
        
    calculation:
      # ... (steps)
      
      dt: 1.8  # MAX(0, 8.5 - 6.7) - significant reduction!
      loss_t: 2800  # Large loss due to draft
      
      dwt_allow: 5200  # 8000 - 2800
      rob_t: 320  # 0.04 × 8000
      intake_weight: 4880  # 5200 - 320
      
      intake_final: 4880
      
    result:
      intake: 4880
      unit: "metric tons"
      limiting_factor: "draft restriction"
      note: "Can only load 61% of DWT due to shallow port"

# ═══════════════════════════════════════════════════════════════════
# MANUAL INTAKE OVERRIDE
# ═══════════════════════════════════════════════════════════════════

manual_intake_system:
  
  priority: "HIGHEST - overrides calculation"
  
  storage_location:
    current: "Vessel comments field"
    future: "Dedicated intake_records table"
    
  format_in_comments:
    pattern: "Real intake: [Cargo], [conditions], [port/region] = [quantity]t"
    
    examples:
      - "Real intake: Wheat, draft 7m, Izmail = 4800t"
      - "Real intake: Corn, Odessa, summer = 5200t"
      - "Real intake: Barley, Constanta, fresh water = 4950t"
      
  parsing_logic:
    step_1: "Search vessel comments for 'Real intake:' or 'Intake:'"
    step_2: "Extract cargo type, port/region, conditions, quantity"
    step_3: "Match against current cargo and ports"
    step_4: "If match found → use manual intake"
    step_5: "If no match → use calculated intake"
    
  matching_rules:
    exact_match:
      - "Cargo type matches exactly"
      - "Port matches exactly"
      - "Use this intake value"
      
    partial_match:
      - "Cargo type matches"
      - "Port is in same country/region"
      - "Consider using with caution"
      
    no_match:
      - "No relevant manual intake found"
      - "Use calculated value"
      
  future_ui:
    fields:
      - vessel_id
      - cargo_type_id
      - cargo_id (optional)
      - port_id (optional)
      - country_id (optional)
      - region_id (optional)
      - conditions: "Text field (draft, water type, etc)"
      - intake_value: "Tonnes"
      - date_recorded: "When this was entered"
      - source: "Fixture details, owner info, etc"
      
    benefits:
      - "Structured data, no parsing needed"
      - "Easy to query and match"
      - "Historical tracking"
      - "Multiple intakes per vessel"

# ═══════════════════════════════════════════════════════════════════
# LOAD vs DISCHARGE PORTS
# ═══════════════════════════════════════════════════════════════════

two_port_logic:
  
  rule: "Calculate intake for BOTH loading and discharge ports, take MINIMUM"
  
  reasoning: |
    Vessel cannot load more cargo than discharge port can handle.
    If loading port allows 50,000t but discharge port only allows 45,000t,
    then vessel can only load 45,000t.
    
  process:
    step_1: "Calculate intake for LOADING port"
    step_2: "Calculate intake for DISCHARGE port"
    step_3: "Intake_final = MIN(intake_load, intake_discharge)"
    
  example:
    scenario:
      cargo: "Wheat 50,000t"
      load_port: "Constanta (no restriction)"
      discharge_port: "Alexandria (draft 8.5m)"
      
    calculation:
      intake_constanta: 52000  # Vessel can load full
      intake_alexandria: 48000  # Draft restricted
      intake_final: 48000  # MIN(52000, 48000)
      
    result:
      can_carry: true
      intake: 48000
      cargo_quantity: 50000
      fit: "tight"  # 48000 < 50000
      score_impact: -10  # Penalty for insufficient capacity

# ═══════════════════════════════════════════════════════════════════
# AI INTEGRATION
# ═══════════════════════════════════════════════════════════════════

ai_usage:
  
  input_to_ai:
    if_manual_intake_exists:
      format: |
        Intake Data (Manual):
        - Source: Historical fixture
        - Cargo: Wheat
        - Port: Izmail
        - Conditions: Draft 7m, fresh water
        - Intake: 4800 tonnes
        
    if_calculated:
      format: |
        Intake Data (Calculated):
        - Method: Hydrostatic calculation
        - Loading port: Odessa
        - Discharge port: Alexandria  
        - Intake (load): 48782 tonnes
        - Intake (discharge): 45000 tonnes
        - Final intake: 45000 tonnes (limited by discharge)
        - Limiting factor: Draft restriction in discharge port
        
    if_calculation_failed:
      format: |
        Intake Data: UNKNOWN
        - Reason: Missing vessel draft data
        - Recommendation: Manual review required
        
  ai_scoring_logic:
    task: "Compare cargo quantity with vessel intake"
    
    scenarios:
      perfect_fit:
        condition: "Intake >= Cargo × 1.1"
        description: "Vessel has comfortable margin"
        score_impact: "0 (neutral, good fit)"
        
      exact_fit:
        condition: "Intake >= Cargo × 1.0 AND < Cargo × 1.1"
        description: "Vessel can carry exactly"
        score_impact: "0 (acceptable)"
        
      tight_fit:
        condition: "Intake >= Cargo × 0.95 AND < Cargo × 1.0"
        description: "Very tight, risky"
        score_impact: "-10 (penalty for risk)"
        
      too_small:
        condition: "Intake < Cargo × 0.95"
        description: "Cannot carry full cargo"
        score_impact: "-30 (major penalty or block)"
        
      too_large:
        condition: "Intake > Cargo × 1.5"
        description: "Vessel much bigger than cargo"
        score_impact: "-5 (inefficiency penalty)"
        note: "Confirm with Vitaly if this matters"
        
  ai_explanation:
    template: |
      Vessel intake capacity: {intake}t
      Cargo quantity: {cargo_quantity}t
      Ratio: {ratio}
      
      {explanation_based_on_ratio}
      
    examples:
      - intake: 48000
        cargo: 50000
        ratio: 0.96
        explanation: "Vessel intake (48,000t) is slightly below cargo requirement (50,000t). This is a tight fit with 4% shortfall. May require cargo reduction or part cargo arrangement."
        
      - intake: 52000
        cargo: 50000
        ratio: 1.04
        explanation: "Vessel intake (52,000t) comfortably exceeds cargo quantity (50,000t) with 4% margin. Good fit."

# ═══════════════════════════════════════════════════════════════════
# ERROR HANDLING
# ═══════════════════════════════════════════════════════════════════

error_handling:
  
  missing_critical_data:
    errors:
      - "Missing vessel draft (T_summer)"
      - "Missing vessel beam (B)"
      - "Missing vessel length (Lpp and LOA)"
      - "Missing port draft restriction"
      - "Missing water type"
      
    action:
      - "Return ERROR message"
      - "Cannot calculate intake"
      - "Recommend manual review"
      - "Skip intake scoring criterion"
      
  impossible_values:
    checks:
      - "Draft restriction < UKC + SQUAT → Port too shallow"
      - "Calculated intake < 0 → Error in data"
      - "Intake > DWT × 1.2 → Suspicious, check data"
      
    action:
      - "Flag for manual review"
      - "Use fallback estimation if possible"
      
  volume_limited_edge_cases:
    - "Grain_m3 = 0 → Error, invalid data"
    - "SF = 0 → Error, invalid stowage factor"
    - "SF > 300 → Suspicious, ultra-light cargo, verify"

# ═══════════════════════════════════════════════════════════════════
# SHORT SUMMARY
# ═══════════════════════════════════════════════════════════════════

DOCUMENT: OpenArea Comments Scoring - P6 Criterion (Voyage-Specific Owner Comments)
PURPOSE: Evaluate how current voyage-specific owner comments align with cargo parameters
SCORE RANGE: [-50, +25] - Penalty-based modifier (no hard blocks)
INTEGRATION: Part of VK Charts AI Scoring System (criterion P6)

WHAT IS P6 (OpenArea Comments Scoring):
P6 evaluates how well the current cargo matches the vessel owner's voyage-specific
comments in OpenArea fields. Unlike Cargo/Regional Preferences (P2/P3) which are
long-term patterns, OpenArea Comments reflect CURRENT strategy for THIS specific
voyage: what cargoes they want now, what regions they prefer now, what voyage type
they seek now.

KEY FEATURES:
- Interprets CURRENT voyage-specific comments (not historical preferences)
- Three signal categories: Cargo-Type, Geography, Trade Pattern/Strategy
- AI-centric interpretation (extracts signals from unstructured text)
- Penalty-focused: Strong conflicts = -40 to -50, perfect match = +20 to +25
- NO HARD BLOCKS (soft rules philosophy - always show cargo with reasoning)
- High priority criterion (reflects real-time owner intentions)
- Directly influences offer text personalization

CRITICAL DISTINCTIONS:
- P3 (Cargo Preferences) = Long-term cargo type patterns
- P2 (Regional Preferences) = Long-term geographic patterns
- P6 (OpenArea Comments) = CURRENT voyage-specific strategy

These are COMPLEMENTARY criteria - P6 adds real-time context to historical patterns.

COMMENT CATEGORIES (3 types):
1. Cargo-Type Related: "no grains", "prefer high SF cargoes", "only fertilizers"
2. Geography Related: "not going to Black Sea", "only East Med", "no Egypt"
3. Trade Pattern/Strategy: "looking for short trip", "seeking repositioning", "avoid long ballast"

SCORING LOGIC:
- Full Conflict (strong negative): -40 to -50 points
  Example: "no grains" + cargo is grain → -45 points
- Soft Conflict (moderate negative): -10 to -25 points
  Example: "prefer close cargo" + cargo 800nm away → -15 points
- Neutral: 0 points (no relevant comments)
- Positive Match: +10 to +15 points
  Example: "prefer high SF cargo" + cargo SF = 1.45 → +12 points
- Perfect Match: +20 to +25 points
  Example: "looking for short trip to Egypt with high SF" + exact match → +25 points

EXAMPLE USAGE:
- Comment: "no grains, prefer nearby cargo only, seeking short trip"
- Cargo: Wheat 5000t, 800nm ballast, 5-day voyage
- Result: -45 (grain conflict) -15 (far) -10 (long trip) = -70 → clamped to -50
- Reasoning: "Strong mismatch with current preferences, but cargo shown for consideration"

PRIORITY IN SYSTEM:
High priority - placed above LPOC and Proximity because it reflects CURRENT daily
changing intentions, not historical patterns.


### Important Notes:
- OpenArea comments are CURRENT and VOYAGE-SPECIFIC
- P6 complements (not replaces) P2/P3 (historical preferences)
- Score range is ASYMMETRIC: more penalty (-50) than bonus (+25)
- NO HARD BLOCKS - even with -50, cargo is shown with reasoning
- Comments integration with COMMENTS_PROCESSING_GUIDE.txt for parsing

---

## FOR AI/LangChain (OpenArea Comment Processing Implementation)

### Step-by-Step Algorithm:

**STEP 1: Receive and Parse OpenArea Comments**
```
Input: open_area_comments (string, may be empty)

If empty: 
  P6_score = 0 (neutral)
  reasoning = "No current voyage-specific comments available"
  RETURN

Parse comments using COMMENTS_PROCESSING_GUIDE.txt patterns:
- Cargo-type signals
- Geography signals
- Strategy signals
```

**STEP 2: Extract Cargo-Type Signals**
```
Keywords to detect:
- Negative: "no", "avoid", "not", "cannot", "refuse"
- Positive: "prefer", "seeking", "looking for", "only"
- Types: "grains", "steel", "coils", "fertilizers", "high SF", "low SF"

Examples:
  "no grains" → cargo_type_signals.add({type: "grains", sentiment: "REFUSE"})
  "prefer high SF cargoes" → cargo_type_signals.add({type: "high_SF", sentiment: "PREFER"})
  "only fertilizers" → cargo_type_signals.add({type: "fertilizers", sentiment: "ONLY"})

For current cargo, check if cargo.type or cargo.stowage_factor matches:
  IF cargo.type = "Wheat" AND signal = "no grains":
    conflict = FULL
    impact = -45
```

**STEP 3: Extract Geography Signals**
```
Keywords to detect:
- Regions: "Black Sea", "Med", "Egypt", "Libya", "Adriatic", etc.
- Proximity: "nearby", "close", "local", "far", "long ballast"
- Directions: "not going to", "prefer", "only", "avoid"

Examples:
  "not going to Black Sea" → geography_signals.add({region: "Black Sea", sentiment: "REFUSE"})
  "prefer nearby cargo only" → geography_signals.add({proximity: "nearby", sentiment: "PREFER"})
  "only East Med" → geography_signals.add({region: "East Med", sentiment: "ONLY"})

For current cargo, check if regions match:
  IF cargo.loading_region = "Black Sea" AND signal = "not going to Black Sea":
    conflict = FULL
    impact = -40
    
  IF cargo.distance_ballast > 500nm AND signal = "prefer nearby cargo":
    conflict = SOFT
    impact = -15
```

**STEP 4: Extract Strategy Signals**
```
Keywords to detect:
- Voyage length: "short trip", "long haul", "quick turnaround"
- Positioning: "repositioning", "ballast", "backhaul"
- Operations: "fast loading", "avoid long ballast", "canal transit"
- Concerns: "PSC", "flag restrictions", "sanctions"

Examples:
  "looking for short trip" → strategy_signals.add({type: "voyage_length", value: "short"})
  "seeking repositioning to Continent" → strategy_signals.add({type: "positioning", destination: "Continent"})
  "avoid long ballast" → strategy_signals.add({type: "ballast", preference: "avoid_long"})

For current cargo, evaluate match:
  IF cargo.voyage_duration_days <= 3 AND signal = "looking for short trip":
    match = POSITIVE
    impact = +15
    
  IF cargo.distance_ballast > 1000nm AND signal = "avoid long ballast":
    conflict = SOFT
    impact = -20
```

**STEP 5: Calculate Conflict Levels**
```
For each signal, determine conflict level:

FULL CONFLICT:
- Direct refusal + cargo matches refused type
- "no grains" + cargo is grain
- "not going to Egypt" + cargo discharges Egypt
- Impact: -40 to -50

SOFT CONFLICT:
- Preference not met but not explicitly refused
- "prefer close cargo" + cargo 800nm away
- "prefer short trip" + cargo 7-day voyage
- Impact: -10 to -25

NEUTRAL:
- Signal not relevant to cargo
- "no steel coils" + cargo is grain
- Impact: 0

POSITIVE MATCH:
- Cargo meets stated preference
- "prefer high SF" + cargo SF = 1.45
- "seeking Egypt backhaul" + cargo to Egypt
- Impact: +10 to +15

PERFECT MATCH:
- Multiple preferences met simultaneously
- "short trip to Egypt with high SF" + cargo matches all
- Impact: +20 to +25
```

**STEP 6: Sum and Clamp Score**
```
Sum all impacts:
  cargo_type_total = sum(cargo_type_signals.impacts)
  geography_total = sum(geography_signals.impacts)
  strategy_total = sum(strategy_signals.impacts)
  
  raw_total = cargo_type_total + geography_total + strategy_total

Clamp to range:
  IF raw_total < -50:
    p6_score = -50
  ELSE IF raw_total > 25:
    p6_score = 25
  ELSE:
    p6_score = raw_total

IMPORTANT: No hard blocks - even at -50, cargo is shown
```

**STEP 7: Generate Reasoning**
```
Create human-readable explanation:

IF p6_score <= -30:
  reasoning = "Strong conflict with current voyage preferences: [list main conflicts]. However, cargo shown for consideration as circumstances may have changed."
  
ELSE IF p6_score < 0:
  reasoning = "Some mismatch with stated preferences: [list conflicts], but [list any positive aspects]."
  
ELSE IF p6_score = 0:
  reasoning = "Neutral match - no specific conflicts or strong preferences indicated in current comments."
  
ELSE IF p6_score > 0:
  reasoning = "Good match with current preferences: [list positive matches]."
  
ELSE IF p6_score >= 20:
  reasoning = "Excellent match - cargo aligns perfectly with stated voyage strategy: [list all matches]."
```

**STEP 8: Generate Offer Text Guidance**
```
Based on conflict level, provide guidance for offer text:

FULL CONFLICT:
  "I see you mentioned '[exact quote]' in your current preferences. I'm showing this cargo because [positive angle: good rate/position/opportunity]. If your strategy has shifted, this could work well."

SOFT CONFLICT:
  "I understand you prefer [preference], and this cargo is [slightly different]. However, [positive aspects] might make it worth considering."

POSITIVE MATCH:
  "This cargo matches your current preferences perfectly: [list matches]. Should be exactly what you're looking for right now."

Include in offer:
- Acknowledge conflicts honestly
- Emphasize positive aspects
- Respect owner's stated preferences
- Leave door open for changed circumstances
```

**STEP 9: Return Complete P6 Analysis**
```json
{
  "criterion_p6_score": numeric [-50, +25],
  "signals_extracted": {
    "cargo_type": [...],
    "geography": [...],
    "strategy": [...]
  },
  "breakdown": {
    "cargo_type_score": numeric,
    "geography_score": numeric,
    "strategy_score": numeric,
    "raw_total": numeric,
    "clamped_score": numeric
  },
  "reasoning": "Human-readable explanation",
  "offer_text_guidance": {
    "acknowledge_conflict": boolean,
    "conflict_text": "string",
    "positive_angle": "string"
  }
}

## FOR KNOWLEDGE BASE UPDATES (Maintenance)

### When to Update This File:

1. **New Signal Type Discovered**
   - Users consistently use new type of voyage-specific comment
   - Add to cargo_type/geography/strategy categories
   - Define keyword detection patterns
   - Document scoring impact

2. **Score Range Adjustment**
   - Market feedback suggests different penalty/bonus levels
   - Update score range or impact values
   - Coordinate with MASTER_SCORING_SYSTEM.txt
   - Document reasoning in changelog

3. **New Conflict Level Needed**
   - Current 4 levels (Full/Soft/Neutral/Positive) insufficient
   - Add new conflict level with clear definition
   - Update scoring impact range
   - Add examples

4. **Integration Point Change**
   - P7 priority in system changes
   - Update priority documentation
   - Coordinate with MASTER_SCORING_SYSTEM.txt
   - Document reasoning

5. **Offer Text Template Update**
   - New diplomatic phrasing needed for conflicts
   - User feedback on offer text effectiveness
   - Update offer_text_guidance patterns
   - Test with real scenarios

### Update Principles:
- ✓ Maintain "no hard blocks" philosophy (soft rules approach)
- ✓ Keep score range asymmetric (more penalty than bonus)
- ✓ Coordinate with COMMENTS_PROCESSING_GUIDE.txt for parsing
- ✓ Test with real OpenArea comment examples
- ✓ Ensure diplomatic conflict acknowledgment in offers
- ✓ Version bump: minor change = +0.1, major change = +1.0
- ✓ Document user feedback driving changes

### Validation Checklist:
- [ ] Score range [-50, +25] maintained
- [ ] Three signal categories comprehensive (cargo/geography/strategy)
- [ ] Conflict levels clearly defined (Full/Soft/Neutral/Positive/Perfect)
- [ ] No hard blocks in any scenario
- [ ] Offer text templates diplomatic and respectful
- [ ] Integration with COMMENTS_PROCESSING_GUIDE.txt verified
- [ ] P6 priority in MASTER_SCORING_SYSTEM.txt correct
- [ ] Real-world comment examples tested

### Testing Guidelines:
```
Test with real OpenArea comments:
1. Parse comment using signal categories
2. Extract cargo/geography/strategy signals
3. Evaluate conflict levels for test cargo
4. Calculate P6 score (verify clamping)
5. Generate reasoning text
6. Create offer text with conflict acknowledgment
7. Verify no hard blocks (cargo shown even at -50)
8. Validate against user expectations
```

---

## QUICK REFERENCE

**Score Range:** [-50, +25] (asymmetric: more penalty than bonus)

**Signal Categories (3 types):**
1. Cargo-Type: "no grains", "prefer high SF", "only fertilizers"
2. Geography: "not going to Black Sea", "prefer nearby cargo", "only East Med"
3. Strategy: "seeking short trip", "avoid long ballast", "repositioning to Continent"

**Conflict Levels:**
- Full Conflict: -40 to -50 (direct refusal + cargo matches)
- Soft Conflict: -10 to -25 (preference not met)
- Neutral: 0 (signal not relevant)
- Positive Match: +10 to +15 (meets preference)
- Perfect Match: +20 to +25 (multiple preferences met)

**Key Principles:**
- NO HARD BLOCKS (cargo always shown with reasoning)
- Voyage-specific (current strategy, not historical patterns)
- High priority (reflects real-time owner intentions)
- Complements P2/P3 (adds current context to historical preferences)

**Example Scoring:**
- "no grains" + wheat cargo = -45 points
- "prefer nearby" + 800nm away = -15 points
- "seeking Egypt" + Egypt cargo = +15 points
- "short trip high SF to Egypt" + perfect match = +25 points

**Offer Text Approach:**
- Full Conflict: Acknowledge honestly, find positive angle
- Soft Conflict: Explain difference, emphasize strengths
- Positive Match: Highlight perfect alignment with preferences

**Critical Notes:**
- P7 changes daily/weekly (not stable like P2/P3)
- Use COMMENTS_PROCESSING_GUIDE.txt for parsing
- Diplomatic conflict acknowledgment required
- Even -50 score doesn't block cargo display


# ═══════════════════════════════════════════════════════════════════
# OPEN AREA COMMENTS SCORING
# VK Charts AI Scoring System - Criterion P6
# ═══════════════════════════════════════════════════════════════════
#
# Оценка соответствия груза текущим voyage-specific комментариям владельца
#
# ═══════════════════════════════════════════════════════════════════

version: "1.2"
last_updated: "2024-12-01"
criterion_code: "P6"
score_range: [-50, 25]
priority: "HIGH - Reflects current real-time owner intentions"

# ═══════════════════════════════════════════════════════════════════
# CRITERION DEFINITION
# ═══════════════════════════════════════════════════════════════════

definition:
  name: "OpenArea Comments Scoring"
  description: |
    Оценка того, насколько текущие, voyage-specific комментарии владельца 
    судна совпадают или конфликтуют с грузом. AI интерпретирует сигналы 
    по трем направлениям (cargo, geography, strategy), применяет бонусы 
    или штрафы, и использует комментарии в reasoning и оффере.
    
  key_characteristics:
    - "Voyage-specific (не долговременные паттерны)"
    - "Высокий приоритет (отражает текущие намерения)"
    - "Нет жестких блоков (только penalties)"
    - "AI-centric интерпретация"
    - "Дипломатичное использование в оффере"
    
  what_it_is_not:
    - "Это НЕ Cargo Preferences (P3) - те долговременные"
    - "Это НЕ Regional Preferences (P2) - те долговременные"
    - "Это НЕ формальные настройки из UI"
    
  relationship_to_other_criteria:
    complements: ["P2 (Regional Preferences)", "P3 (Cargo Preferences)"]
    overrides: []  # Не отменяет другие критерии, дополняет
    priority_level: "HIGH - выше P4 (LPOC) и P1 (Proximity)"

# ═══════════════════════════════════════════════════════════════════
# COMMENT CATEGORIES
# ═══════════════════════════════════════════════════════════════════

comment_categories:
  
  cargo_type_related:
    description: "Комментарии о типах груза, SF, технических характеристиках"
    
    examples:
      negative:
        - "no grains"
        - "no steel coils"
        - "not low SF cargoes (<1.0)"
        - "no dirty bulk"
        - "no breakbulk"
        
      positive:
        - "prefer high SF cargoes"
        - "only fertilizers"
        - "seeking grain cargoes"
        - "looking for bagged cargoes"
        
    keywords:
      refuse: ["no", "not", "avoid", "cannot", "refuse"]
      prefer: ["prefer", "seeking", "looking for", "only", "want"]
      cargo_types: ["grains", "wheat", "corn", "steel", "coils", "fertilizers", 
                    "bauxite", "high SF", "low SF", "dirty bulk", "breakbulk"]
                    
  geography_related:
    description: "Комментарии о регионах, портах, направлениях"
    
    examples:
      negative:
        - "not going to Black Sea"
        - "no Libya / no Egypt"
        - "no Marmara"
        - "avoid Turkey"
        
      positive:
        - "only looking for East Med cargoes"
        - "prefer close cargo from current port"
        - "prefer backhaul towards Adriatic"
        - "seeking Egypt area"
        
    keywords:
      refuse: ["not going to", "no", "avoid", "cannot call"]
      prefer: ["only", "prefer", "seeking", "looking for"]
      proximity: ["nearby", "close", "local", "far", "long ballast"]
      regions: ["Black Sea", "Med", "Egypt", "Libya", "Marmara", "Adriatic",
                "Continent", "Turkey", "Greece", "Far East"]
                
  trade_pattern_strategy:
    description: "Комментарии о типе рейса, стратегии, позиционировании"
    
    examples:
      voyage_type:
        - "looking for short trip"
        - "looking for long haul"
        - "need quick turnaround"
        
      positioning:
        - "seeking repositioning to Continent"
        - "want to stay in Med"
        - "avoid long ballast"
        
      operational:
        - "need fast loading"
        - "not ready for canal transit"
        - "PSC concerns in Egypt"
        
    keywords:
      voyage_length: ["short trip", "long haul", "quick", "fast turnaround"]
      positioning: ["repositioning", "backhaul", "stay in", "heading to"]
      ballast: ["avoid long ballast", "prefer nearby", "long ballast ok"]
      operational: ["fast loading", "slow ops ok", "canal transit", "PSC concerns"]

# ═══════════════════════════════════════════════════════════════════
# SCORING LOGIC
# ═══════════════════════════════════════════════════════════════════

scoring_logic:
  
  principle: "AI-centric interpretation with soft rules (no hard blocks)"
  
  conflict_levels:
    
    full_conflict:
      description: "Прямой запрет + груз соответствует запрету"
      score_range: [-50, -40]
      
      examples:
        - comment: "no grains"
          cargo: "Wheat"
          score: -45
          reasoning: "Direct refusal of grain cargoes, cargo is wheat"
          
        - comment: "not going to Black Sea"
          cargo_loading: "Odessa, Ukraine (Black Sea)"
          score: -40
          reasoning: "Owner explicitly refuses Black Sea routes"
          
        - comment: "prefer only high SF cargo"
          cargo_sf: 0.68
          score: -45
          reasoning: "Low SF cargo conflicts with 'only high SF' preference"
          
      important_note: "Even at -50, cargo is STILL SHOWN to user with reasoning"
      
    soft_conflict:
      description: "Предпочтение не выполнено, но не явный запрет"
      score_range: [-25, -10]
      
      examples:
        - comment: "prefer closer cargo"
          ballast_distance: 800
          score: -15
          reasoning: "Cargo far from current position, owner prefers nearby"
          
        - comment: "prefer short trip"
          voyage_days: 7
          score: -12
          reasoning: "7-day voyage doesn't match 'short trip' preference"
          
        - comment: "avoid Turkey"
          cargo_loading: "Iskenderun, Turkey"
          score: -20
          reasoning: "Soft avoidance of Turkey, cargo loads there"
          
    neutral:
      description: "Сигнал не релевантен к грузу"
      score_range: [0, 0]
      
      examples:
        - comment: "no steel coils"
          cargo: "Wheat"
          score: 0
          reasoning: "Comment about steel not relevant to grain cargo"
          
    positive_match:
      description: "Груз соответствует заявленным предпочтениям"
      score_range: [10, 15]
      
      examples:
        - comment: "prefer high SF cargo"
          cargo_sf: 1.45
          score: 12
          reasoning: "Cargo SF 1.45 matches high SF preference"
          
        - comment: "seeking Egypt/Libya backhaul"
          cargo_discharge: "Alexandria, Egypt"
          score: 15
          reasoning: "Egypt discharge matches backhaul preference"
          
        - comment: "looking for nearby cargo"
          ballast_distance: 150
          score: 10
          reasoning: "150nm ballast matches 'nearby' preference"
          
    perfect_match:
      description: "Несколько предпочтений выполнены одновременно"
      score_range: [20, 25]
      
      examples:
        - comment: "short trip to Egypt with high SF"
          cargo: 
            type: "Bagged fertilizers"
            sf: 1.50
            discharge: "Alexandria, Egypt"
            voyage_days: 3
          score: 25
          reasoning: "Perfect alignment: high SF, Egypt destination, short trip (3 days)"

# ═══════════════════════════════════════════════════════════════════
# SCORING CALCULATION
# ═══════════════════════════════════════════════════════════════════

calculation_method:
  
  step_by_step:
    
    step_1_parse_comments:
      description: "Extract signals from OpenArea comments"
      output: "List of cargo_signals, geography_signals, strategy_signals"
      
    step_2_evaluate_each_signal:
      description: "For each signal, determine conflict level and impact"
      output: "List of {signal, conflict_level, impact_score}"
      
    step_3_sum_impacts:
      description: "Sum all impact scores"
      formula: "raw_score = sum(all_impacts)"
      
    step_4_clamp_to_range:
      description: "Ensure score within [-50, +25]"
      formula: |
        IF raw_score < -50: p7_score = -50
        ELSE IF raw_score > 25: p7_score = 25
        ELSE: p7_score = raw_score
        
    step_5_generate_reasoning:
      description: "Create human-readable explanation"
      includes:
        - Main conflicts identified
        - Positive matches found
        - Overall assessment
        - Why cargo shown despite conflicts
        
  example_calculation:
    
    comment: "no grains, prefer nearby cargo only, seeking short trip to Egypt"
    
    cargo:
      type: "Wheat"
      stowage_factor: 0.68
      loading_port: "Constanta, Romania"
      discharge_port: "Alexandria, Egypt"
      distance_ballast: 420
      voyage_duration_days: 5
      
    signal_evaluation:
      - signal: "no grains"
        cargo_matches: true  # cargo is grain (wheat)
        conflict_level: "FULL"
        impact: -45
        
      - signal: "prefer nearby cargo only"
        distance: 420  # 420nm ballast
        conflict_level: "SOFT"
        impact: -10
        reasoning: "420nm not exactly 'nearby'"
        
      - signal: "seeking short trip to Egypt"
        voyage_days: 5
        discharge_matches: true  # Egypt
        conflict_level: "POSITIVE_MATCH"
        impact: +15
        reasoning: "5-day trip reasonably short, Egypt matches"
        
    calculation:
      raw_score: -45 + (-10) + 15 = -40
      clamped_score: -40  # within range
      final_p6_score: -40
      
    reasoning_output: |
    "Strong conflict with current preferences: owner specified 'no grains' 
    and cargo is wheat (-45). Additional soft conflict on distance (420nm 
    not exactly 'nearby', -10). However, positive match on destination 
    and trip length (Egypt, 5-day trip, +15). Overall P6 score: -40.
      Cargo shown for consideration as circumstances may have changed."

# ═══════════════════════════════════════════════════════════════════
# OFFER TEXT INTEGRATION
# ═══════════════════════════════════════════════════════════════════

offer_text_guidelines:
  
  principle: "Acknowledge conflicts diplomatically, emphasize positive aspects"
  
  full_conflict_template:
    approach: "Honest acknowledgment + positive angle"
    
    examples:
      - comment: "no grains"
        cargo: "Wheat"
        
        bad_text: |
          "Я знаю, что вы писали 'no grains', но решил отправить в любом случае 
          — вдруг ситуация изменилась."
          
        good_text: |
          "I see you mentioned 'no grains' in your current comments. I'm showing 
          this wheat cargo because [position is excellent / rate is attractive / 
          quick turnaround]. If your strategy has shifted or there's flexibility 
          on this particular cargo, it could work well."
          
  soft_conflict_template:
    approach: "Acknowledge preference + show why worth considering"
    
    examples:
      - comment: "prefer close cargo"
        ballast: 800
        
        text: |
          "I understand you prefer nearby cargo, and this is 800nm ballast. 
          However, [strong freight rate / excellent return cargo opportunity / 
          positions you well for next voyage] might make it worth considering."
          
  positive_match_template:
    approach: "Highlight alignment with preferences"
    
    examples:
      - comment: "seeking short trip to Egypt with high SF"
        cargo: "Perfect match"
        
        text: |
          "This cargo matches your current preferences perfectly: high SF (1.48), 
          Egypt destination, 3-day voyage. Should be exactly what you're looking 
          for right now."
          
  diplomatic_principles:
    - "Never argue with owner's stated preferences"
    - "Acknowledge conflicts honestly"
    - "Find positive angles (rate, position, opportunity)"
    - "Leave door open for changed circumstances"
    - "Be respectful of owner's strategy"
    - "Don't be pushy if strong conflict exists"

# ═══════════════════════════════════════════════════════════════════
# AI PROMPT INTEGRATION
# ═══════════════════════════════════════════════════════════════════

prompt_template:
  
  section: |
    ═══════════════════════════════════════════════════════════════
    OPEN AREA COMMENTS (Voyage-Specific Owner Notes)
    ═══════════════════════════════════════════════════════════════
    
    OpenArea Comments: {open_area_comments}
    
    These comments reflect the owner's CURRENT preferences for THIS specific 
    voyage. They may override or complement historical Regional/Cargo 
    Preferences (P2/P3).
    
    Your tasks:
    1. Extract cargo-type, geography, and strategy signals
    2. Evaluate conflicts and matches with current cargo
    3. Calculate P6 score [-50, +25]
    4. Generate diplomatic reasoning
    5. Provide offer text guidance
    
    CRITICAL RULES:
    - NO HARD BLOCKS - even at -50, show cargo with explanation
    - Acknowledge conflicts honestly in offer text
    - Find positive angles where possible
    - Be respectful of owner's stated preferences
    - Score range is asymmetric (more penalty than bonus)
    
    Score the alignment and provide reasoning.

# ═══════════════════════════════════════════════════════════════════
# INTEGRATION WITH SYSTEM
# ═══════════════════════════════════════════════════════════════════

system_integration:
  
  priority_in_scoring:
    position: "Above LPOC (P4) and Proximity (P1)"
    reasoning: |
      OpenArea comments reflect CURRENT daily changing intentions, which are 
      more important than historical patterns (LPOC) or pure distance (Proximity).
      
  suggested_order:
    1: "P5 (Intake) - Hard capacity constraint"
    2: "P3 (Cargo Preferences) - Long-term cargo patterns"
    3: "P2 (Regional Preferences) - Long-term regional patterns"
    4: "P6 (OpenArea Comments) - CURRENT voyage-specific strategy ← THIS"
    5: "P4 (Last Ports) - Historical familiarity"
    6: "P1 (Proximity) - Geographic distance"
    7: "P7 (Readiness ETA) - Timing"
    
  relationship_to_comments_guide:
    reference: "COMMENTS_PROCESSING_GUIDE.txt"
    note: |
      OpenArea Comments use same parsing methodology as vessel/company comments,
      but have separate scoring criterion because they are voyage-specific.
      
  no_hard_blocks_philosophy:
    principle: "Soft rules approach"
    implementation: |
      Even with -50 P7 score, cargo MUST be shown to user with clear reasoning.
      This allows human judgment to override AI assessment if circumstances 
      have changed or there are special considerations.

# ═══════════════════════════════════════════════════════════════════
# METADATA & VERSIONING
# ═══════════════════════════════════════════════════════════════════

metadata:
  created_by: "Vitaly (VK Charts expert)"
  created_date: "2024-11-28"
  last_modified: "2024-12-01"
  version: "1.1.0"
  
  changelog:
    - version: "1.2.0"
      date: "2024-12-01"
      changes:
        - "CRITICAL FIX: Changed criterion code from P7 to P6"
        - "Updated all references from P7 to P6 throughout document"
        - "Corrected suggested_order to match MASTER_SCORING_SYSTEM.txt"
        - "Fixed priority_level description"
        - "Reason: MASTER_SCORING_SYSTEM.txt defines P6 = OpenArea Comments, P7 = Readiness/ETA"
        - "No logic changes - purely nomenclature correction"
      
    - version: "1.1.0"
      date: "2024-11-30"
      changes:
        - "Restructured SHORT SUMMARY in unified format"
        - "Added comprehensive HOW TO USE DOCUMENT with 3 sections:"
        - "  - For Developers (Laravel ↔ LangChain integration)"
        - "  - For AI/LangChain (9-step OpenArea comment processing algorithm)"
        - "  - For Knowledge Base Updates (maintenance procedures)"
        - "Added Quick Reference section"
        - "Enhanced documentation structure for clarity"
        - "Verified score range [-50, +25] consistency"
        - "Verified no hard blocks philosophy maintained"
        - "Confirmed integration with COMMENTS_PROCESSING_GUIDE.txt"
        - "Enhanced offer text templates with diplomatic principles"
        - "No logic changes - purely documentation improvements"
      
    - version: "1.0.0"
      date: "2024-11-28"
      changes:
        - "Initial OpenArea Comments Scoring criterion (originally labeled P7)"
        - "Defined three comment categories (cargo/geography/strategy)"
        - "Established conflict levels (Full/Soft/Neutral/Positive/Perfect)"
        - "Set score range [-50, +25] with asymmetric penalties"
        - "Documented no hard blocks philosophy"
        - "Created offer text integration guidelines"
        - "Established high priority in scoring system"
  
  notes:
    - "P6 is voyage-specific - reflects CURRENT strategy, not historical patterns"
    - "NO HARD BLOCKS - cargo always shown even with -50 score"
    - "Score range asymmetric: -50 max penalty vs +25 max bonus"
    - "High priority criterion - above P4 (LPOC) and P1 (Proximity)"
    - "Complements (not replaces) P2/P3 historical preferences"
    - "CORRECTED 2024-12-01: Renamed from P7 to P6 per MASTER_SCORING_SYSTEM.txt"

# ═══════════════════════════════════════════════════════════════════
# SUMMARY
# ═══════════════════════════════════════════════════════════════════

summary:
  
  key_principles:
    1: "Voyage-specific comments reflect CURRENT owner strategy"
    2: "Three signal types: cargo-type, geography, strategy"
    3: "AI-centric interpretation with soft rules"
    4: "NO HARD BLOCKS - always show cargo with reasoning"
    5: "Diplomatic acknowledgment of conflicts in offer text"
    6: "High priority - above P4 (LPOC) and P1 (Proximity)"
    7: "Asymmetric scoring: more penalty than bonus"
    8: "Criterion code: P6 (not P7) per MASTER_SCORING_SYSTEM.txt"
    
  ai_responsibilities:
    - "Parse OpenArea comments for signals"
    - "Evaluate conflict levels accurately"
    - "Calculate P6 score within [-50, +25]"
    - "Generate diplomatic reasoning"
    - "Provide offer text guidance"
    - "Respect owner's stated preferences"
    
  quality_indicators:
    good_processing:
      - "Signals correctly identified and categorized"
      - "Conflict levels appropriately assessed"
      - "Reasoning acknowledges conflicts honestly"
      - "Offer text is diplomatic and respectful"
      - "Positive angles found where possible"
      
    poor_processing:
      - "Ignores OpenArea comments"
      - "Creates hard blocks (cargo not shown)"
      - "Argumentative offer text"
      - "Doesn't acknowledge conflicts"
      - "Score outside [-50, +25] range"

READINESS/ETA_TO_LOADING PORT_SCORING
# ───────────────────────────────────────────────────────────────
# AI INSTRUCTION FOR CRITERION 7 (P7: READINESS / ETA MATCHING)
# ───────────────────────────────────────────────────────────────
ai_instruction: |
  You are an AI scoring engine inside a maritime CRM system.  
  Your task is to calculate “Criterion 7 (P7): Readiness / ETA Matching” and output:
    - a numeric score from 0 to 10
    - a structured explanation of reasoning
    - all assumptions used

  Follow these rules:

  1. Identify the vessel’s starting location and starting time:
       Priority:
         (1) OpenArea → use open_port + open_date_from
         (2) Destination (ETA + discharge if laden)
         (3) CurrentArea (representative port fallback)

  2. Determine whether the vessel is LADEN or BALLAST using:
         - current_draft vs design_draft thresholds
         - cargo_export_map patterns
         - vessel/company comments

  3. If vessel is LADEN:
         - Use ETA to destination
         - Add discharge time (daily rate × SHEX coefficient)
         - That gives the actual start_time for sailing to loading port

  4. Calculate sea distance (NM) between starting point and loading port.

  5. Select service speed:
         - Small coasters: 8 kn
         - Coasters: 10 kn
         - Handy+ : 12 kn

  6. Compute ETA_to_load = start_time + (distance / speed).

  7. Compare ETA_to_load against cargo dates:
         - late_date        = laycan start
         - cancelling_date  = laycan end

  8. Select category:
         - perfect_fit
         - slightly_early_wait_ok
         - slightly_late_but_possible
         - too_early_or_too_late
         - unknown_eta

  9. Assign numeric score based on the category and explain:
         - Why the start point was chosen
         - Why vessel considered laden or ballast
         - Distance, speed, days of sailing
         - Calculated ETA_to_load
         - How it matches late_date / cancelling_date
         - What data was missing (if any)

  Always produce a clear and concise explanation.

# ─────────────────────────────────────────────────────────────────
# CRITERION 7 (P7): READINESS / ETA TO LOADING PORT
# ─────────────────────────────────────────────────────────────────

criterion_7_readiness_timing:
  jira: "VC-149"
  status: "📋 SPEC READY"
  weight: 10         # P7 weight from MASTER_SCORING_SYSTEM.txt
  max_points: 10
  
  description: |
    Estimate when the vessel can realistically arrive at the cargo loading port
    (ETA_to_load) and compare it to the laycan window. The goal is to score how
    "on time" the vessel is for this cargo, taking into account:
    - Where and when the vessel opens (OpenArea/OpenPort)
    - Whether the vessel is currently laden or in ballast
    - Time required for discharge (if laden and sailing to another port first)
    - Sea distance from start point to loading port
    - Realistic service speed by vessel size
  
  # ───────────────────────────────────────────────────────────────
  # DATA INPUTS
  # ───────────────────────────────────────────────────────────────
  
  data_sources:
    
    vessel_static:
      - dwt
      - summer_draft_design
      - vessel_size_category   # from vessel_size_classification.yaml
      - typical_service_speed  # derived from size (see below)
    
    vessel_dynamic:
      - open_area:          # text + structured port/region if parsed
          port:             # if exact port known
          region:
          open_date_from:   # earliest open date
          open_date_to:     # latest open date (if range)
      - destination:        # port / region (if geographic)
      - eta_destination:    # ETA to destination (if available)
      - current_area:       # fallback region if no open_area/destination
      - current_port:       # if known
      - current_draft:      # from AIS / tracking
      - last_known_position_datetime
    
    cargo_data:
      - loading_port
      - loading_country
      - loading_region
      - discharge_port
      - discharge_country
      - discharge_region
      - laycan_start
      - laycan_end
      - cargo_quantity_mt
  
  # ───────────────────────────────────────────────────────────────
  # SPEED BY VESSEL SIZE (SIMPLIFIED)
  # ───────────────────────────────────────────────────────────────
  
  service_speed_by_size:
    
    # Use DWT → size categories from vessel_size_classification.yaml
    # Then map to a simple speed table for this criterion.
    
    small_coasters:        # 0–4000 DWT (SC)
      reference: "vessel_sizes.small_coasters"     # in vessel_size_classification.yaml
      speed_kn: 8                                   # average realistic service speed
  
    coasters:              # 4001–17000 DWT (C)
      reference: "vessel_sizes.coasters"           # in vessel_size_classification.yaml
      speed_kn: 10
  
    larger_vessels:        # >17000 DWT (SH/H/SS/SM/PM)
      reference: "small_handy / handy and above"
      speed_kn: 12
  
    notes: |
      - This is an intentionally simplified speed model just for ETA-to-load
        scoring. Detailed TCE calculations may use more precise speeds.
      - AI can adjust slightly based on comments (e.g. "slow vessel", "17 kn speed"),
        but default behavior should use the table above.
  
  # ───────────────────────────────────────────────────────────────
  # LADEN VS BALLAST DETECTION
  # ───────────────────────────────────────────────────────────────
  
  ballast_vs_laden_detection:
    
    principle: |
      Use current_draft vs design draft + trade patterns from cargo_export_map
      to decide if the vessel is laden or in ballast.
    
    basic_draft_logic:
      design_draft: "summer_draft_design from vessel card"
      
      thresholds:
        laden_if:  "current_draft >= 0.85 × design_draft"
        ballast_if: "current_draft <= 0.60 × design_draft"
        uncertain_range: "0.60–0.85 × design_draft"
      
      interpretation:
        - "laden"    → vessel is carrying cargo (still to discharge)
        - "ballast"  → vessel is light, free to proceed to next load
        - "uncertain"→ use trade patterns + comments to refine
  
    cargo_export_patterns_fallback:
      source: "cargo_export_map.yaml" :contentReference[oaicite:0]{index=0}
      usage: |
        If draft is in the uncertain zone, AI can consult cargo_export_map:
        - Look at current_region / destination_region.
        - Check typical exports and directions for this area and vessel size.
        - Infer if it is more likely that vessel is:
          * On a laden leg to a typical discharge region, or
          * On a ballast leg back towards a supply region (e.g. Aqaba → Black Sea fertilizers).
  
    comments_integration:
      source: "COMMENTS_PROCESSING_GUIDE.yaml" :contentReference[oaicite:1]{index=1}
      usage: |
        Vessel/company comments may explicitly say:
          - "Typically ballasts back to Black Sea after Egypt Med"
          - "Always fixes backhaul cargo from Aqaba to Ukraine"
        AI must use this information to override generic pattern assumptions.
  
  # ───────────────────────────────────────────────────────────────
  # START POINT & START TIME DETERMINATION
  # ───────────────────────────────────────────────────────────────
  
  start_point_and_time_logic:
    
    priority_order:
      1: open_area
      2: destination (with ETA + discharge time if laden)
      3: current_area (fallback)
    
    case_1_open_area_available:
      description: |
        If OpenArea/OpenPort is present and parsed:
        - Use it as the starting location.
        - Use open_date_from as earliest possible departure time.
      
      start_point:
        - If open_port known → that port.
        - Else → representative port of open_region (e.g. main hub).
      
      start_time:
        - open_date_from (earliest date in open window).
        - AI can note if open_date_to is much later (uncertainty).
    
    case_2_destination_available_but_no_open_area:
      description: |
        If OpenArea is missing but Destination and ETA are available:
        - First decide if vessel is currently laden or in ballast:
          * If LADEN → it still needs to discharge at destination.
          * If BALLAST and destination ≈ loading region → it may already be
            sailing towards load port.
      
      subcase_2a_laden:
        steps:
          1. Assume vessel will arrive at destination at eta_destination.
          2. Estimate discharge time based on vessel size and cargo quantity
             (if known) or typical parcel sizes for that region from cargo_export_map.
          3. start_point = destination port.
          4. start_time = eta_destination + discharge_duration.
        
        discharge_rates_shex:
          # Base daily rates BEFORE SHEX coefficient
          small_coasters_and_coasters: 1500   # mt/day SHEX both ends
          small_handy:               2500
          handy_and_above:           4000
          
          shex_coefficient: 1.6      # to approximate weekends/Friday 17:00 off
          
          formula: |
            discharge_days = (parcel_quantity_mt / daily_rate) × shex_coefficient
            
            If parcel_quantity_mt is unknown:
              - AI can approximate using:
                * Vessel intake estimates, or
                * Typical export parcel sizes for that region from cargo_export_map.
        
      subcase_2b_ballast_towards_loading_region:
        detection: |
          If destination ≈ loading_port OR in same region/cluster, and
          vessel is in ballast → treat eta_destination as ETA to loading area.
        
        steps:
          - If destination == loading_port:
              start_point = loading_port
              start_time  = eta_destination   # vessel arrives directly
          - If destination in same cluster/region:
              start_point = destination port
              start_time  = eta_destination   # then short extra hop to loading_port
              # AI will still calculate small additional sea time.
      
      subcase_2c_destination_not_useful:
        description: |
          If destination is unrelated to loading region and we cannot reliably
          estimate what happens after that (no comments, no patterns), fall back
          to current_area logic (case 3) to avoid fantasy projections.
    
    case_3_fallback_current_area_only:
      description: |
        When neither OpenArea nor usable Destination is available:
        - Use current_area as a generic starting region.
        - Map current_area → representative port (e.g. Istanbul for Marmara,
          Constanta for Black Sea, etc.) using port libraries/port_restrictions_map.
      
      start_point:
        - representative_port_for(current_area)
      
      start_time:
        - last_known_position_datetime (if reasonably fresh)
        - Or "today" as approximate, with explanation of low confidence.
  
  # ───────────────────────────────────────────────────────────────
  # SEA DISTANCE & SAILING TIME
  # ───────────────────────────────────────────────────────────────
  
  distance_and_travel_time:
    
    distance_nm:
      method: |
        Use the same sea distance service as for proximity/TCE:
        - Input: (start_point_port, loading_port)
        - Output: distance_nm including necessary canals/straits (Bosporus, etc.).
    
    sailing_time:
      formula: |
        speed_kn = service_speed_by_size[vessel_size_category]
        
        hours = distance_nm / speed_kn
        days  = hours / 24
        
        Optionally, AI can add:
          - small weather factor,
          - or round to nearest 0.5 day for clarity.
  
  # ───────────────────────────────────────────────────────────────
  # ETA TO LOADING PORT & LAYCAN COMPARISON
  # ───────────────────────────────────────────────────────────────
  
  eta_to_loading_and_laycan:
    
    eta_to_load:
      formula: |
        ETA_to_load = start_time + sailing_time_days
      
      notes: |
        - If start_time itself is a range (open_date_from/open_date_to),
          AI should use open_date_from for "earliest arrival" and explain
          uncertainty in reasoning.
    
    laycan_window:
      inputs:
        - laycan_start
        - laycan_end
    
    timing_categories:
      
      perfect_fit:
        condition: |
          ETA_to_load within [laycan_start - 1 day; laycan_end]
        impact: "Highest score (near max_points)"
        reasoning: "Vessel can be ready right on time or just before laycan."
      
      slightly_early_wait_ok:
        condition: |
          ETA_to_load earlier than laycan_start by up to 3 days
        impact: "Small penalty vs perfect; owner waits but still realistic."
        notes: "AI may note waiting time in reasoning."
      
      slightly_late_but_possible:
        condition: |
          ETA_to_load later than laycan_end by up to 2 days
        impact: "Moderate penalty; depends on charterer flexibility."
        notes: "AI should mention that this likely requires laycan extension."
      
      too_late_or_too_early:
        condition: |
          ETA_to_load earlier than laycan_start by >3 days
          OR later than laycan_end by >2 days
        impact: "Low or zero score for this criterion."
        notes: "Still no hard block – just show low timing score."
      
      unknown_eta:
        condition: "Impossible to compute ETA_to_load with minimal sanity."
        impact: "Neutral (0) or 'skip criterion', not a heavy penalty."
        notes: "AI must explicitly mention lack of data in explanation."
  
  # ───────────────────────────────────────────────────────────────
  # SCORING LOGIC (NUMERIC)
  # ───────────────────────────────────────────────────────────────
  
  scoring_logic:
    
    # This criterion is relatively low weight (5 points total),
    # but still important for ranking similar vessels.
    
    mapping:
      perfect_fit:              [4, 5]   # points range
      slightly_early_wait_ok:   [3, 4]
      slightly_late_but_possible:[1, 3]
      too_late_or_too_early:    [0, 1]
      unknown_eta:              0        # treated as neutral / missing
    
    ai_responsibility: |
      - Determine timing_category based on ETA vs laycan.
      - Pick a concrete score within the recommended range
        depending on how close the dates are.
      - Always explain:
        * Assumed start point & start time
        * Distance and assumed speed
        * Calculated ETA range
        * How this compares to laycan
        * Any uncertainties or assumptions
  
  # ───────────────────────────────────────────────────────────────
  # INTEGRATION WITH OTHER CRITERIA
  # ───────────────────────────────────────────────────────────────
  
  integration:
    
    with_proximity:
      note: |
        Criterion 1 (Proximity) already considers where the vessel is
        geographically vs loading port. Criterion 6 focuses on time
        rather than pure distance:
        - Proximity = "How far is it?"
        - Readiness/Timing = "Will it be there in time for this laycan?"
    
    with_intake_capacity:
      note: |
        If intake is insufficient and vessel would require part cargo,
        timing may still be good, but overall total score will be low.
        AI should keep these dimensions separate in reasoning.
    
    with_comments_and_trade_patterns:
      note: |
        Behavioral patterns from COMMENTS_PROCESSING_GUIDE.yaml and export
        routes from cargo_export_map.yaml should be used to:
        - Improve ballast vs laden detection.
        - Adjust assumptions about what happens after discharge.
        - Explain why ETA estimation is optimistic or conservative.
  
  # ───────────────────────────────────────────────────────────────
  # AI TASK DESCRIPTION (FOR PROMPT)
  # ───────────────────────────────────────────────────────────────
  
  ai_task: |
    1. Determine whether OpenArea, Destination, or only CurrentArea is available.
    2. Decide if the vessel is currently laden or in ballast using:
       - current_draft vs design draft
       - cargo_export_map patterns
       - company/vessel comments (behavioral patterns).
    3. Based on this:
       - If open_area → use open port + open_date_from as start.
       - If laden with destination + ETA → add discharge time, then use dest port.
       - If ballast to region near load → use destination as start after ETA.
       - Else → use current_area mapped to a representative port.
    4. Get sea distance (nm) from this start point to loading port.
    5. Select service speed from vessel_size_classification (8/10/12 kn).
    6. Calculate sailing time and ETA_to_load.
    7. Compare ETA_to_load vs laycan_start/laycan_end and assign timing category.
    8. Convert category to numeric score (0–5) using scoring_logic.
    9. Provide:
       - "Criterion 7 (P7): Readiness / Timing Score: X/5"
       - Clear explanation of:
         * Assumptions (start point, draft interpretation, speeds)
         * Calculated ETA range
         * Comparison vs laycan
         * Any uncertainties or missing data.
